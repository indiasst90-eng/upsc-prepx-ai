# Story 3.9: Video Render - Error Handling & Retry Logic

**Epic:** 3 - Video Generation Pipeline
**Story Number:** 3.9
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 4
**Estimated Effort:** Medium (M)
**Risk Level:** HIGH (Critical for reliability)

---

## Story

**As a** system administrator,
**I want** robust error handling and automatic retry logic for video rendering failures,
**so that** daily CA videos are published reliably even when individual services fail.

---

## Acceptance Criteria

1. Retry logic for all VPS service calls: 3 attempts with exponential backoff
2. Service health checks before rendering: ping each service
3. Graceful degradation: if Manim fails, use static images
4. Fallback TTS: if primary TTS fails, use backup service
5. Queue management: failed jobs marked as failed, retried after 5 minutes
6. Admin alerts: email/Slack notification on critical failures
7. Manual override: admin can manually trigger re-render
8. Render logs: detailed error logs stored for debugging
9. Monitoring dashboard: success rate, failure reasons, avg render time
10. SLA target: 95% on-time delivery rate (video ready by 6 AM)

---

## Dependencies

**Blocking:** Stories 3.3, 3.4
**Blocks:** None

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Shared Utils: `packages/supabase/functions/shared/retry-utils.ts`
- Admin Dashboard: `apps/admin/src/app/system-status/render-metrics/`
- Monitoring Tables: `render_logs`, `render_failures`

### Data Models

**Database Schema:**
```typescript
interface RenderLog {
  id: UUID
  render_id: UUID
  step_name: TEXT  -- 'script_gen', 'manim', 'tts', 'revideo', 'upload'
  status: TEXT  -- 'started', 'completed', 'failed'
  error_message?: TEXT
  duration_ms: INTEGER
  retry_count: INTEGER DEFAULT 0
  created_at: TIMESTAMPTZ
}

interface RenderFailure {
  id: UUID
  render_id: UUID
  failure_reason: TEXT
  error_details: JSONB
  resolved: BOOLEAN
  resolved_at?: TIMESTAMPTZ
  resolved_by?: UUID  -- admin user
}
```

### API Specifications

**Retry Utility:**
- Location: `packages/supabase/functions/shared/retry-utils.ts`
- Function: `withRetry(fn, maxAttempts, backoffMs)`

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/shared/retry-utils.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Retry Logic (AC: 1, 27)**
  - [ ] 1.1 Create `packages/supabase/functions/shared/retry-utils.ts`
  - [ ] 1.2 Implement `withRetry()` function
  - [ ] 1.3 3 attempts with exponential backoff
  - [ ] 1.4 Apply to all VPS service calls

- [ ] **Task 2: Health Checks (AC: 2)**
  - [ ] 2.1 Create `checkServiceHealth()` function
  - [ ] 2.2 Ping each VPS service before rendering
  - [ ] 2.3 Log health status
  - [ ] 2.4 Skip unhealthy services

- [ ] **Task 3: Graceful Degradation (AC: 3)**
  - [ ] 3.1 If Manim fails, use static images
  - [ ] 3.2 Create fallback image template
  - [ ] 3.3 Continue rendering without animations
  - [ ] 3.4 Log degradation event

- [ ] **Task 4: Fallback TTS (AC: 4)**
  - [ ] 4.1 Implement TTS fallback chain
  - [ ] 4.2 Primary: A4F TTS
  - [ ] 4.3 Fallback: browser TTS or cached audio
  - [ ] 4.4 Track which TTS used

- [ ] **Task 5: Queue Management (AC: 5)**
  - [ ] 5.1 Create `handleRenderFailure()` function
  - [ ] 5.2 Mark job as failed with retry_count
  - [ ] 5.3 Re-queue after 5 minutes
  - [ ] 5.4 Max retries before hard fail

- [ ] **Task 6: Admin Alerts (AC: 6)**
  - [ ] 6.1 Create `sendRenderAlert()` function
  - [ ] 6.2 Email/Slack notification on critical failure
  - [ ] 6.3 Alert thresholds: 3 consecutive failures
  - [ ] 6.4 Include error details in alert

- [ ] **Task 7: Manual Override (AC: 7)**
  - [ ] 7.1 Create admin API: `POST /api/admin/rerender`
  - [ ] 7.2 Accept render_id
  - [ ] 7.3 Reset retry_count and trigger render
  - [ ] 7.4 Admin UI in dashboard

- [ ] **Task 8: Render Logging (AC: 8)**
  - [ ] 8.1 Create `logRenderStep()` function
  - [ ] 8.2 Log each step: started, completed, failed
  - [ ] 8.3 Store error details for debugging
  - [ ] 8.4 Log duration for performance tracking

- [ ] **Task 9: Monitoring Dashboard (AC: 9)**
  - [ ] 9.1 Create `apps/admin/src/app/system-status/render-metrics/page.tsx`
  - [ ] 9.2 Display success rate percentage
  - [ ] 9.3 Show failure reasons breakdown
  - [ ] 9.4 Display avg render time

- [ ] **Task 10: SLA Tracking (AC: 10)**
  - [ ] 10.1 Track on-time delivery rate
  - [ ] 10.2 Target: 95% videos ready by 6 AM
  - [ ] 10.3 Daily SLA report
  - [ ] 10.4 Alert if SLA drops below target

- [ ] **Task 11: Unit Tests**
  - [ ] 11.1 Test retry logic
  - [ ] 11.2 Test exponential backoff
  - [ ] 11.3 Test fallback behavior

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
