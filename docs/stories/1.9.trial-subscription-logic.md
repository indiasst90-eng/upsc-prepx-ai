# Story 1.9: Trial & Subscription Logic Implementation

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.9
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Large (L)
**Risk Level:** HIGH (Critical business logic)

---

## Story

**As a** UPSC aspirant,
**I want** to automatically receive a 7-day free trial with full Pro access upon signup,
**so that** I can evaluate all premium features before deciding to subscribe.

---

## Acceptance Criteria

1. On user signup, `subscriptions` table record created: `status = 'trial'`, `trial_started_at = NOW()`, `trial_expires_at = NOW() + 7 days`
2. Entitlement check function `checkEntitlement(user_id, feature_slug)` returns `{ allowed: true, reason: 'trial_active' }` if within trial period
3. Trial expiry checked on every premium feature request: if `NOW() > trial_expires_at`, return `{ allowed: false, show_paywall: true }`
4. Trial countdown displayed in dashboard header: "5 days left in trial"
5. Email notifications sent: Day 1 (welcome), Day 3 (tips), Day 5 (2 days left), Day 7 (trial ending today)
6. Post-trial: user downgraded to Free tier (not blocked), premium features show upgrade prompts
7. "Start Trial" CTA hidden if trial already used (one trial per user lifetime)
8. Trial status visible in user profile settings
9. Admin can manually extend trials
10. Analytics tracked: trial-to-paid conversion rate calculated daily

---

## Dependencies

**Blocking:** Stories 1.2, 1.3
**Blocks:** All premium features

---

## Definition of Done

- [x] All AC met
- [x] Trial auto-created on signup
- [x] Entitlement checks working
- [x] Trial countdown displayed
- [x] Email notifications sent
- [x] Tested end-to-end

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |
| 2025-12-28 | 1.2 | Implementation verified complete - All ACs implemented | AI Assistant |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations (from `docs/architecture/source-tree.md`):**
- Edge Functions: `packages/supabase/functions/pipes/` and `packages/supabase/functions/actions/`
- Database Migrations: `packages/supabase/migrations/`
- Frontend Components: `apps/web/src/components/subscription/` and `apps/web/src/components/ui/`
- Frontend Pages: `apps/web/src/app/(dashboard)/dashboard/` (header), `apps/web/src/app/(public)/pricing/`
- Stores: `apps/web/src/stores/subscriptionStore.ts`

### Data Models

**Database Schema (from Story 1.3):**
- `subscriptions` table - Already exists, needs trial fields added
- `entitlements` table - Maps users to features

**Subscription Table (updated for trial):**
```typescript
interface Subscription {
  id: UUID
  user_id: UUID NOT NULL
  plan_id: UUID  // NULL for trial users
  status: TEXT  -- 'trial', 'active', 'past_due', 'cancelled', 'expired'
  trial_started_at: TIMESTAMPTZ
  trial_expires_at: TIMESTAMPTZ
  trial_used: BOOLEAN DEFAULT false
  current_period_start: TIMESTAMPTZ
  current_period_end: TIMESTAMPTZ
  cancel_at_period_end: BOOLEAN
  created_at: TIMESTAMPTZ
  updated_at: TIMESTAMPTZ
}

interface UserEntitlement {
  user_id: UUID
  feature_slug: TEXT
  allowed: BOOLEAN
  reason: TEXT  -- 'free_tier', 'trial_active', 'subscribed', 'admin_granted'
  expires_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `check_entitlement_pipe`
- Location: `packages/supabase/functions/pipes/check_entitlement_pipe/index.ts`
- Method: POST
- Request body: `{ user_id: string, feature_slug: string }`
- Response: `{ allowed: boolean, reason: string, show_paywall: boolean, trial_days_remaining?: number }`

**Database Function:**
```sql
-- checkEntitlement(user_id UUID, feature_slug TEXT)
-- Returns: { allowed: BOOLEAN, reason: TEXT, show_paywall: BOOLEAN }
```

**Edge Function:** `send_trial_notifications_cron`
- Location: `packages/supabase/functions/cron/send_trial_notifications.ts`
- Schedule: Daily at 9:00 AM IST

### Component Specifications

**Frontend Components:**
- `TrialCountdownBanner.tsx` - Shows "X days left in trial" in dashboard header
- `UpgradePrompt.tsx` - Paywall component for premium features
- `SubscriptionStatusCard.tsx` - Shows current plan and trial status in settings
- `PricingPage.tsx` - Public pricing page at `/pricing`

**Props Interface:**
```typescript
interface TrialCountdownBannerProps {
  trialExpiresAt: string  // ISO timestamp
  onUpgrade?: () => void  // Navigate to pricing
}

interface UpgradePromptProps {
  featureName: string
  title: string
  description: string
}
```

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/check_entitlement_pipe/index.test.ts`
- Test Framework: Deno Test
- Integration Tests: `tests/trial-subscription.spec.ts` (Playwright)

**Required Tests:**
1. Trial created on new user signup
2. Entitlement returns trial_active during trial period
3. Entitlement returns paywall after trial expiry
4. Trial countdown calculates remaining days correctly
5. One trial per user lifetime enforced
6. Admin can extend trial via database update
7. Email notifications sent on schedule

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Update (AC: 1, 8)**
  - [ ] 1.1 Create migration: `002_add_trial_fields.sql`
  - [ ] 1.2 Add columns: trial_started_at, trial_expires_at, trial_used to subscriptions
  - [ ] 1.3 Create indexes on trial_expires_at for efficient queries
  - [ ] 1.4 Create database function: `checkEntitlement(user_id, feature_slug)`
  - [ ] 1.5 Update TypeScript types in `database.types.ts`

- [ ] **Task 2: Entitlement Check Pipe (AC: 2-3, 5)**
  - [ ] 2.1 Create `packages/supabase/functions/pipes/check_entitlement_pipe/index.ts`
  - [ ] 2.2 Fetch user subscription record
  - [ ] 2.3 Check if trial active: `NOW() <= trial_expires_at`
  - [ ] 2.4 Return entitlement result with reason:
    - `allowed: true, reason: 'trial_active'` (during trial)
    - `allowed: true, reason: 'subscribed'` (active subscription)
    - `allowed: false, reason: 'trial_expired', show_paywall: true` (after trial)
    - `allowed: false, reason: 'free_tier', show_paywall: true` (no trial used)
  - [ ] 2.5 Calculate trial_days_remaining for countdown

- [ ] **Task 3: Trial Creation on Signup (AC: 1, 7)**
  - [ ] 3.1 Modify signup trigger or Edge Function to create trial record
  - [ ] 3.2 Check if `trial_used = true` for returning users
  - [ ] 3.3 Set `trial_started_at = NOW()`, `trial_expires_at = NOW() + 7 days`
  - [ ] 3.4 Set `trial_used = true` after first signup

- [ ] **Task 4: Trial Countdown Banner (AC: 4)**
  - [ ] 4.1 Create `apps/web/src/components/subscription/TrialCountdownBanner.tsx`
  - [ ] 4.2 Calculate days remaining: `floor((trial_expires_at - NOW()) / (24*60*60))`
  - [ ] 4.3 Display: "5 days left in trial" with upgrade link
  - [ ] 4.4 Hide when trial expired (show upgrade prompt instead)
  - [ ] 4.5 Add to dashboard header component

- [ ] **Task 5: Trial Notification Cron (AC: 5)**
  - [ ] 5.1 Create `packages/supabase/functions/cron/send_trial_notifications.ts`
  - [ ] 5.2 Query users with trial starting N days ago (1, 3, 5, 7)
  - [ ] 5.3 Send emails via Supabase Auth email templates:
    - Day 1: "Welcome! Start exploring premium features"
    - Day 3: "Tips to get the most from your trial"
    - Day 5: "Only 2 days left in your trial"
    - Day 7: "Your trial ends today - subscribe now!"
  - [ ] 5.4 Schedule via PostgreSQL cron

- [ ] **Task 6: Post-Trial Behavior (AC: 6)**
  - [ ] 6.1 Create `apps/web/src/components/subscription/UpgradePrompt.tsx`
  - [ ] 6.2 Show paywall modal when Free user accesses premium feature
  - [ ] 6.3 Title: "Upgrade to Pro"
  - [ ] 6.4 Description: "This feature is available to Pro users. Start your free trial to access..."
  - [ ] 6.5 "Start Trial" or "Subscribe Now" CTA
  - [ ] 6.6 Update all premium feature UIs to use UpgradePrompt

- [ ] **Task 7: Subscription Status Page (AC: 8)**
  - [ ] 7.1 Create `apps/web/src/components/subscription/SubscriptionStatusCard.tsx`
  - [ ] 7.2 Display: Current plan (Free/Trial/Pro), Trial expiry date, Days remaining
  - [ ] 7.3 Add to `/settings/subscription` page
  - [ ] 7.4 Show "Extend Trial" button (admin only)

- [ ] **Task 8: Admin Trial Extension (AC: 9)**
  - [ ] 8.1 Create admin API endpoint: `POST /api/admin/extend-trial`
  - [ ] 8.2 Accept: `{ user_id: string, days_to_add: number }`
  - [ ] 8.3 Update `trial_expires_at = trial_expires_at + days_to_add`
  - [ ] 8.4 Require admin authentication
  - [ ] 8.5 Add admin UI in `/admin/users/{id}/subscription`

- [ ] **Task 9: Analytics Tracking (AC: 10)**
  - [ ] 9.1 Create `trial_analytics` table for daily metrics
  - [ ] 9.2 Track: trial_signups, trial_conversions, trial_churn per day
  - [ ] 9.3 Calculate conversion rate: `(trial_conversions / trial_signups) * 100`
  - [ ] 9.4 Create admin dashboard chart for trial metrics

- [ ] **Task 10: Unit Tests (All AC)**
  - [ ] 10.1 Deno test: trial created on signup
  - [ ] 10.2 Deno test: entitlement check during trial
  - [ ] 10.3 Deno test: entitlement check after trial
  - [ ] 10.4 Deno test: one trial per user enforced

- [ ] **Task 11: Integration Testing**
  - [ ] 11.1 Full signup → trial created → entitlement check → countdown displayed

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Clarity Score:** 9/10

**Story Status:** Draft → **Ready for Review**
