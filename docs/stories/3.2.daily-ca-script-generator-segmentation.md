# Story 3.2: Daily CA Script Generator - Segmentation & Summarization

**Epic:** 3 - Video Generation Pipeline
**Story Number:** 3.2
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 4
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** system,
**I want** to automatically generate a structured video script from scraped articles with topic segmentation and UPSC-specific insights,
**so that** daily current affairs videos are concise, exam-focused, and easy to follow.

---

## Acceptance Criteria

1. Edge Function: generate_ca_script_pipe.ts triggered after scraper (5:15 AM)
2. Articles fetched from daily_updates where date = today, status = pending_video
3. Topic segmentation: LLM groups articles into 4-6 segments
4. Each segment: 60-120 seconds, max 3 articles per segment
5. Script structure: intro (15s) → segments → conclusion with MCQ preview (15s)
6. RAG integration: retrieve related knowledge chunks for context
7. UPSC relevance markers: Prelims, Mains, Essay connections highlighted
8. Script saved to video_renders table: status = pending_manim
9. Total word count: 800-1200 words (5-8 minutes at 150 words/min)
10. Quality check: if <3 UPSC-relevant articles, flag for manual review

---

## Dependencies

**Blocking:** Story 3.1
**Blocks:** Story 3.3

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/pipes/generate_ca_script_pipe/`
- Database Tables: `daily_updates`, `video_renders`

### Data Models

**Video Render Table:**
```typescript
interface VideoRender {
  id: UUID
  video_type: TEXT  -- 'daily_ca', 'doubt', 'topic_short'
  date: DATE
  script_text: TEXT
  script_sections: JSONB  -- [{ title, duration, articles: [] }]
  status: TEXT  -- 'pending_manim', 'queued_render', 'rendering', 'completed', 'failed'
  total_duration_seconds: INTEGER
  word_count: INTEGER
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `generate_ca_script_pipe`
- Location: `packages/supabase/functions/pipes/generate_ca_script_pipe/index.ts`
- Schedule: 5:15 AM IST (15 min after scraper)
- Trigger: Automated after Story 3.1 completes

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/generate_ca_script_pipe/index.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Script Pipe Creation (AC: 1, 3)**
  - [ ] 1.1 Create `generate_ca_script_pipe/index.ts`
  - [ ] 1.2 Triggered after Story 3.1 completes
  - [ ] 1.3 Fetch articles from daily_updates where date = today, status = pending_video
  - [ ] 1.4 LLM groups articles into 4-6 topic segments

- [ ] **Task 2: Topic Segmentation (AC: 3, 4)**
  - [ ] 2.1 Create `segmentArticles()` function
  - [ ] 2.2 Group by topic: Polity, Economy, International, Environment, etc.
  - [ ] 2.3 Limit: max 3 articles per segment
  - [ ] 2.4 Target: 60-120 seconds per segment

- [ ] **Task 3: Script Structure (AC: 5)**
  - [ ] 3.1 Create `generateScriptStructure()` function
  - [ ] 3.2 Sections: Intro (15s) → Segments → Conclusion (15s) with MCQ preview
  - [ ] 3.3 Total word count: 800-1200 words
  - [ ] 3.4 Estimated duration: 5-8 minutes

- [ ] **Task 4: RAG Integration (AC: 6)**
  - [ ] 4.1 Call rag_search_pipe to get related knowledge chunks
  - [ ] 4.2 Include context from syllabus-grounded content
  - [ ] 4.3 Enhance script with exam-specific insights

- [ ] **Task 5: UPSC Markers (AC: 7)**
  - [ ] 5.1 Add markers for Prelims, Mains, Essay connections
  - [ ] 5.2 Highlight potential question topics
  - [ ] 5.3 Include "This is important for GS-X" notes

- [ ] **Task 6: Save to Database (AC: 8)**
  - [ ] 6.1 Insert/update `video_renders` table
  - [ ] 6.2 Set status = pending_manim
  - [ ] 6.3 Store script_sections JSONB

- [ ] **Task 7: Quality Check (AC: 10)**
  - [ ] 7.1 Count UPSC-relevant articles
  - [ ] 7.2 If <3 relevant, flag for manual review
  - [ ] 7.3 Send alert to admin channel

- [ ] **Task 8: Unit Tests**
  - [ ] 8.1 Deno test: article segmentation
  - [ ] 8.2 Deno test: script structure
  - [ ] 8.3 Deno test: UPSC markers

- [ ] **Task 9: Integration Testing**
  - [ ] 9.1 End-to-end: articles → segmentation → script → saved

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft → **Ready for Review**
