# Story 2.4: Notes Generator - Manim Diagram Integration

**Epic:** 2 - Core Learning Features
**Story Number:** 2.4
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 3
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** UPSC aspirant,
**I want** AI-generated notes to include visual diagrams and flowcharts,
**so that** I can understand complex concepts through visual explanations alongside text.

---

## Acceptance Criteria

1. Notes Generator analyzes content and identifies visualizable elements
2. Manim scene specifications generated: JSON schema
3. VPS Manim Renderer called with scene JSON
4. Diagram rendered as PNG (for notes) and MP4 (for video shorts)
5. Diagrams embedded in notes at relevant positions
6. Notes PDF export includes diagrams
7. Diagram caching: reuse cached renders
8. Fallback: if Manim render fails, proceed without diagram
9. User can click diagram to open fullscreen viewer
10. Mobile-optimized: diagrams scale responsively

---

## Dependencies

**Blocking:** Stories 1.5 (Manim), 2.3
**Blocks:** Story 2.5

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/actions/generate_manim_diagram_action.ts`
- Frontend Components: `apps/web/src/components/notes/DiagramViewer.tsx`
- VPS Service: Manim Renderer at `http://89.117.60.144:5000`

### Data Models

**Database Schema:**
```typescript
interface ManimSceneCache {
  id: UUID
  scene_hash: TEXT UNIQUE  -- Hash of scene specification
  topic_id: UUID
  scene_type: TEXT  -- 'flowchart', 'timeline', 'concept_map', 'diagram'
  input_spec: JSONB  -- Original request
  output_url: TEXT  -- Cached PNG URL
  video_url: TEXT  -- Cached MP4 URL (for AC: 4)
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Action:** `generate_manim_diagram_action`
- Location: `packages/supabase/functions/actions/generate_manim_diagram_action.ts`
- Input: `{ topic: string, content: string, diagram_type: string }`
- Output: `{ diagram_url: string, video_url?: string }`

**Manim Scene Spec:**
```typescript
interface ManimSceneSpec {
  scene_type: 'flowchart' | 'timeline' | 'concept_map' | 'hierarchy'
  title: string
  nodes: { id: string; label: string; position?: [x, y] }[]
  edges: { from: string; to: string; label?: string }[]
  animation?: 'fade_in' | 'grow' | 'slide'
}
```

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/actions/generate_manim_diagram_action.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Diagram Detection (AC: 1)**
  - [ ] 1.1 Analyze notes content for visualizable elements
  - [ ] 1.2 Identify: processes (flowchart), events (timeline), concepts (map), hierarchies
  - [ ] 1.3 Create `detectVisualizableContent()` function

- [ ] **Task 2: Scene Spec Generation (AC: 2)**
  - [ ] 2.1 Create `generateManimSceneSpec()` function
  - [ ] 2.2 Convert content to JSON schema format
  - [ ] 2.3 Include: scene_type, title, nodes, edges, animation
  - [ ] 2.4 Return ManimSceneSpec object

- [ ] **Task 3: Manim Renderer Call (AC: 3)**
  - [ ] 3.1 Call VPS Manim Renderer service
  - [ ] 3.2 POST scene spec to `http://89.117.60.144:5000/render`
  - [ ] 3.3 Handle response: PNG for notes, MP4 for videos

- [ ] **Task 4: Video Generation (AC: 4)**
  - [ ] 4.1 Generate MP4 alongside PNG
  - [ ] 4.2 Save video URL for video shorts (Story 2.5)

- [ ] **Task 5: Diagram Embedding (AC: 5)**
  - [ ] 5.1 Insert diagrams at relevant positions in notes
  - [ ] 5.2 Use markdown image syntax: `![Diagram](url)`
  - [ ] 5.3 Position based on content references

- [ ] **Task 6: PDF Export (AC: 6)**
  - [ ] 6.1 Include embedded diagrams in PDF export
  - [ ] 6.2 Ensure diagrams render at high resolution

- [ ] **Task 7: Caching (AC: 7)**
  - [ ] 7.1 Check `manim_scene_cache` before rendering
  - [ ] 7.2 Use scene_hash as cache key
  - [ ] 7.3 Return cached URLs if exists

- [ ] **Task 8: Fallback Handling (AC: 8)**
  - [ ] 8.1 Wrap render call in try/catch
  - [ ] 8.2 If render fails, log error and continue without diagram
  - [ ] 8.3 Notify user: "Diagram generation failed"

- [ ] **Task 9: Fullscreen Viewer (AC: 9)**
  - [ ] 9.1 Create `DiagramModal.tsx` component
  - [ ] 9.2 Open on diagram click
  - [ ] 9.3 Support zoom and pan

- [ ] **Task 10: Mobile Responsive (AC: 10)**
  - [ ] 10.1 CSS: max-width: 100%, height: auto
  - [ ] 10.2 Touch-friendly zoom controls

- [ ] **Task 11: Unit Tests**
  - [ ] 11.1 Test scene spec generation
  - [ ] 11.2 Test caching logic
  - [ ] 11.3 Test fallback behavior

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
