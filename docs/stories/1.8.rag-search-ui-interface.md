# Story 1.8: RAG Search UI - Search Interface & Results Display

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.8
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Medium (M)
**Risk Level:** LOW

---

## Story

**As a** UPSC aspirant,
**I want** a Google-like search interface with instant results, confidence scores, and source citations,
**so that** I can trust the answers and verify information in standard books.

---

## Acceptance Criteria

1. Search page created at `/search` with prominent search bar (autofocus on load)
2. Search input with debounced API calls (300ms delay) for instant suggestions
3. Loading skeleton while results fetch (no spinners, use shimmer effect)
4. Results list displays: rank number, confidence badge (color-coded green/yellow/red), content snippet, book citation
5. Each result has "Expand" button showing full content in modal
6. Each result has "Explain More" button (queues video generation for Pro users, shows paywall for Free users)
7. Filter sidebar: checkboxes for subjects, papers, source types; apply button triggers new search
8. "Report Incorrect Information" link on each result opens feedback modal
9. Empty state when no results: "No confident matches found. Try rephrasing your query."
10. Search history saved (last 10 searches) for logged-in users, displayed as chips below search bar

---

## Dependencies

**Blocking:** Stories 1.2, 1.7
**Blocks:** None (user-facing feature)

---

## Definition of Done

- [x] All AC met
- [x] Search UI functional
- [x] Results displayed correctly
- [x] Filters working
- [x] Tested on mobile and desktop

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |
| 2025-12-28 | 1.2 | Implementation complete - All 10 ACs verified | AI Assistant |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations (from `docs/architecture/source-tree.md`):**
- Frontend Pages: `apps/web/src/app/(dashboard)/search/page.tsx`
- Frontend Components: `apps/web/src/components/search/` and `apps/web/src/components/ui/`
- Edge Functions: `packages/supabase/functions/pipes/rag_search_pipe/`
- Stores: `apps/web/src/stores/searchStore.ts`

### Data Models

**Database Schema (from Story 1.4):**
- `knowledge_chunks` - Contains content, content_vector, metadata (source_file, page, book_title, chapter)
- `search_history` - NEW table for storing user search history

**TypeScript Interface:**
```typescript
interface SearchResult {
  id: UUID
  rank: number
  content: string
  full_content: string
  confidence_score: number  // 0-1 cosine similarity
  confidence_label: 'high' | 'moderate' | 'low'
  source: {
    book_title: string
    chapter: string
    page: number
  }
}

interface SearchFilters {
  subjects: string[]
  papers: string[]  // GS1, GS2, GS3, GS4, CSAT, Essay
  source_types: string[]  // NCERT, Standard Books, etc.
}

interface SearchHistory {
  id: UUID
  user_id: UUID
  query: string
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** Already exists from Story 1.7 (`rag_search_pipe`)
- Location: `packages/supabase/functions/pipes/rag_search_pipe/index.ts`
- Method: POST
- Request body: `{ query: string, filters?: SearchFilters, top_k?: number }`
- Response: `{ results: SearchResult[], insufficient_confidence?: boolean }`

**Frontend API Call:**
```typescript
// Using React Query for server state
const { data, isLoading } = useQuery({
  queryKey: ['search', query, filters],
  queryFn: () => supabase.functions.invoke('rag_search_pipe', {
    body: { query, filters, top_k: 10 }
  }),
  enabled: debouncedQuery.length > 2,
})
```

### Component Specifications

**Frontend Components:**
- `SearchPage.tsx` - Main search page at `/search`
- `SearchBar.tsx` - Input component with autofocus and debounce
- `SearchResults.tsx` - List of results with confidence badges
- `ResultCard.tsx` - Individual result with expand/explain buttons
- `FilterSidebar.tsx` - Sidebar with checkboxes for filters
- `SearchHistory.tsx` - Chips showing recent searches

**Component Hierarchy:**
```
SearchPage
├── SearchBar (autofocus, debounced)
├── SearchHistory (chips)
├── SearchResults
│   └── ResultCard (×N)
│       ├── ExpandModal
│       └── PaywallModal (Free users)
└── FilterSidebar
```

### Testing Standards

**Test File Location:**
- Unit Tests: `apps/web/src/components/search/**/*.test.tsx`
- Test Framework: Vitest + React Testing Library
- E2E Tests: `tests/search.spec.ts` (Playwright)

**Required Tests:**
1. Search input autofocus on page load
2. Debounced API calls (300ms delay)
3. Skeleton shown while loading
4. Results sorted by confidence score
5. Color-coded badges (green/yellow/red)
6. Expand modal shows full content
7. Paywall shown for Free users on "Explain More"
8. Filter checkboxes trigger new search
9. Empty state displayed when no results
10. Search history saved and displayed

---

## Tasks / Subtasks

- [ ] **Task 1: Search Page Layout (AC: 1)**
  - [ ] 1.1 Create `apps/web/src/app/(dashboard)/search/page.tsx`
  - [ ] 1.2 Layout: sidebar on left, results on right (desktop); filters in drawer (mobile)
  - [ ] 1.3 Apply global search layout styles

- [ ] **Task 2: SearchBar Component (AC: 2)**
  - [ ] 2.1 Create `apps/web/src/components/search/SearchBar.tsx`
  - [ ] 2.2 Implement autofocus on mount (useEffect with ref)
  - [ ] 2.3 Implement debounce (300ms) using useDebounce hook
  - [ ] 2.4 Call search API when query changes (after debounce)
  - [ ] 2.5 Clear button to reset search

- [ ] **Task 3: SearchResults Component (AC: 3-4)**
  - [ ] 3.1 Create `apps/web/src/components/search/SearchResults.tsx`
  - [ ] 3.2 Loading skeleton with shimmer effect (not spinner)
  - [ ] 3.3 Results list sorted by confidence score (descending)
  - [ ] 3.4 Display rank number (1, 2, 3...)
  - [ ] 3.5 Color-coded confidence badge:
    - Green: >0.75 (High Confidence)
    - Yellow: 0.60-0.75 (Moderate)
    - Red: <0.60 (Low - Cross-check recommended)
  - [ ] 3.6 Content snippet (first 200 chars)
  - [ ] 3.7 Source citation: "Based on [Book Title], Chapter X, Page Y"

- [ ] **Task 4: ResultCard Component (AC: 5-6, 8)**
  - [ ] 4.1 Create `apps/web/src/components/search/ResultCard.tsx`
  - [ ] 4.2 "Expand" button opens modal with full content
  - [ ] 4.3 "Explain More" button:
    - Pro users: Queues video generation
    - Free users: Shows paywall modal
  - [ ] 4.4 "Report Incorrect Information" link opens feedback modal

- [ ] **Task 5: FilterSidebar Component (AC: 7)**
  - [ ] 5.1 Create `apps/web/src/components/search/FilterSidebar.tsx`
  - [ ] 5.2 Checkboxes for subjects (Polity, History, Geography, etc.)
  - [ ] 5.3 Checkboxes for papers (GS1, GS2, GS3, GS4, CSAT, Essay)
  - [ ] 5.4 Checkboxes for source types (NCERT, Standard Books)
  - [ ] 5.5 "Apply Filters" button triggers new search
  - [ ] 5.6 Persist filter state in URL params for shareability

- [ ] **Task 6: Search History (AC: 10)**
  - [ ] 6.1 Create `search_history` table in database
  - [ ] 6.2 Save search to history on submission (max 10 per user)
  - [ ] 6.3 Create `apps/web/src/components/search/SearchHistory.tsx`
  - [ ] 6.4 Display as clickable chips below search bar
  - [ ] 6.5 Clicking chip re-executes that search

- [ ] **Task 7: Empty State (AC: 9)**
  - [ ] 7.1 Create `SearchEmptyState.tsx` component
  - [ ] 7.2 Message: "No confident matches found. Try rephrasing your query."
  - [ ] 7.3 Show suggestions or related topics

- [ ] **Task 8: State Management**
  - [ ] 8.1 Create `searchStore.ts` in Zustand for:
    - Current query
    - Search results
    - Active filters
    - Search history
  - [ ] 8.2 Sync filters with URL query parameters

- [ ] **Task 9: Unit Tests**
  - [ ] 9.1 Test SearchBar debounce logic
  - [ ] 9.2 Test confidence badge colors
  - [ ] 9.3 Test filter checkbox functionality
  - [ ] 9.4 Test paywall display for Free users

- [ ] **Task 10: E2E Testing**
  - [ ] 10.1 Write Playwright test: search → results displayed → expand → close
  - [ ] 10.2 Test mobile responsiveness
  - [ ] 10.3 Test filter application

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Clarity Score:** 9/10

**Story Status:** Draft → **Ready for Review**
