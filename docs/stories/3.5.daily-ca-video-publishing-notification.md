# Story 3.5: Daily CA Video Publishing & Notification

**Epic:** 3 - Video Generation Pipeline
**Story Number:** 3.5
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 4
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** to receive notification when daily current affairs video is published by 6 AM,
**so that** I can watch it during my morning study routine.

---

## Acceptance Criteria

1. Video published automatically: status = published, published_at = NOW()
2. Video visible on dashboard: hero card "Today's Current Affairs"
3. Push notifications sent: all users with notifications enabled
4. Email digest (optional): HTML email with video embed link
5. Social media auto-post: Twitter/X, LinkedIn posts with video link
6. Archive page: /daily-ca route lists all past videos in calendar view
7. Video metadata: view count, completion rate, average watch time tracked
8. Thumbnail auto-generated: first frame or custom from Manim title card
9. SEO optimization: video page has meta tags for sharing
10. Monitoring: alert admin if video not published by 6:30 AM

---

## Dependencies

**Blocking:** Story 3.4
**Blocks:** None

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/pipes/publish_ca_video_pipe/`
- Frontend Pages: `apps/web/src/app/(dashboard)/daily-ca/`
- Admin Pages: `apps/admin/src/app/daily-ca/`

### Data Models

**Database Schema:**
```typescript
interface DailyCAPublish {
  id: UUID
  date: DATE UNIQUE
  video_url: TEXT
  thumbnail_url: TEXT
  status: TEXT  -- 'draft', 'scheduled', 'published', 'failed'
  published_at: TIMESTAMPTZ
  view_count: INTEGER DEFAULT 0
  completion_rate: DECIMAL  -- percentage
  avg_watch_time_seconds: INTEGER
  social_posts: JSONB  -- { twitter: post_url, linkedin: post_url }
}
```

### API Specifications

**Edge Function:** `publish_ca_video_pipe`
- Location: `packages/supabase/functions/pipes/publish_ca_video_pipe/index.ts`
- Trigger: After video rendering completes
- Manual trigger available for admin

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/publish_ca_video_pipe/index.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Publish Pipeline (AC: 1, 10)**
  - [ ] 1.1 Create `publish_ca_video_pipe/index.ts`
  - [ ] 1.2 Triggered when video_renders status = completed
  - [ ] 1.3 Update status to published, set published_at = NOW()
  - [ ] 1.4 Alert if not published by 6:30 AM

- [ ] **Task 2: Dashboard Integration (AC: 2)**
  - [ ] 2.1 Create `apps/web/src/app/(dashboard)/daily-ca/page.tsx`
  - [ ] 2.2 Hero card: "Today's Current Affairs" with video embed
  - [ ] 2.3 Fallback if video not ready: show "Coming Soon"

- [ ] **Task 3: Push Notifications (AC: 3)**
  - [ ] 3.1 Create `sendCANotifications()` function
  - [ ] 3.2 Query users with notifications enabled
  - [ ] 3.3 Send push via Supabase push notifications
  - [ ] 3.4 Message: "Today's Current Affairs video is ready!"

- [ ] **Task 4: Email Digest (AC: 4)**
  - [ ] 4.1 Create HTML email template
  - [ ] 4.2 Include video embed link
  - [ ] 4.3 Send to users with email digests enabled

- [ ] **Task 5: Social Media (AC: 5)**
  - [ ] 5.1 Create `postToSocialMedia()` function
  - [ ] 5.2 Twitter/X API integration
  - [ ] 5.3 LinkedIn API integration
  - [ ] 5.4 Post format: "Today's Current Affairs: [Topic highlights] #UPSC"

- [ ] **Task 6: Archive Page (AC: 6)**
  - [ ] 6.1 Create `apps/web/src/app/(dashboard)/daily-ca/archive/page.tsx`
  - [ ] 6.2 Calendar view of all past videos
  - [ ] 6.3 Filter by month/year
  - [ ] 6.4 Search functionality

- [ ] **Task 7: Thumbnail Generation (AC: 8)**
  - [ ] 7.1 Capture first frame from video
  - [ ] 7.2 Or generate Manim title card with date
  - [ ] 7.3 Upload to Supabase Storage
  - [ ] 7.4 Use as video thumbnail

- [ ] **Task 8: SEO Optimization (AC: 9)**
  - [ ] 8.1 Add Open Graph meta tags
  - [ ] 8.2 Twitter card meta tags
  - [ ] 8.3 Video JSON-LD structured data
  - [ ] 8.4 Canonical URL for sharing

- [ ] **Task 9: Unit Tests**
  - [ ] 9.1 Deno test: publish flow
  - [ ] 9.2 Deno test: notification sending
  - [ ] 9.3 Deno test: social posting

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
