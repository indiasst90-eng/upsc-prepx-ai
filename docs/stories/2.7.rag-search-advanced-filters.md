# Story 2.7: RAG Search - Advanced Features & Filters

**Epic:** 2 - Core Learning Features
**Story Number:** 2.7
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 3
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** advanced search capabilities with filters by subject, paper, book, and date range,
**so that** I can find precise information from specific sources quickly.

---

## Acceptance Criteria

1. Advanced filters panel (collapsible sidebar on search page)
2. Subject filter: multi-select checkboxes (Polity, History, Geography, Economy, Science, Ethics, Essay, CSAT)
3. Paper filter: multi-select (GS1, GS2, GS3, GS4, CSAT, Essay)
4. Source type filter: NCERT, Standard Books, Government Reports, Daily Updates
5. Book filter: dropdown populated from pdf_uploads.book_title (distinct values)
6. Date range filter: content updated between start and end dates
7. Search within results: second search bar filters already fetched results client-side
8. Save search: Save this search button stores query + filters to saved_searches table
9. Saved searches accessible from dropdown: My Saved Searches with quick-apply buttons
10. Filter state persisted in URL query params: shareable search URLs, back button works

---

## Dependencies

**Blocking:** Stories 1.7, 1.8
**Blocks:** None

---

## Definition of Done

- [ ] All AC met
- [ ] Advanced filters functional
- [ ] All filter types working
- [ ] Save search working
- [ ] URL persistence working
- [ ] Search within results working

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Frontend Components: `apps/web/src/components/search/AdvancedFilters.tsx`
- Database Table: `saved_searches`
- State Management: URL query params sync

### Data Models

**Database Schema:**
```typescript
interface SavedSearch {
  id: UUID
  user_id: UUID
  name: TEXT
  query: TEXT
  filters: JSONB  -- { subjects, papers, source_types, date_range }
  created_at: TIMESTAMPTZ
}
```

### Testing Standards

**Test File Location:**
- Unit Tests: `apps/web/src/components/search/**/*.test.tsx`

---

## Tasks / Subtasks

- [ ] **Task 1: Advanced Filters Panel (AC: 1)**
  - [ ] 1.1 Create `AdvancedFilters.tsx` component
  - [ ] 1.2 Collapsible sidebar design
  - [ ] 1.3 State managed in URL query params

- [ ] **Task 2: Subject Filter (AC: 2)**
  - [ ] 2.1 Create multi-select checkboxes
  - [ ] 2.2 Options: Polity, History, Geography, Economy, Science, Ethics, Essay, CSAT
  - [ ] 2.3 Persist selection in URL

- [ ] **Task 3: Paper Filter (AC: 3)**
  - [ ] 3.1 Create multi-select checkboxes
  - [ ] 3.2 Options: GS1, GS2, GS3, GS4, CSAT, Essay

- [ ] **Task 4: Source Type Filter (AC: 4)**
  - [ ] 4.1 Create multi-select checkboxes
  - [ ] 4.2 Options: NCERT, Standard Books, Government Reports, Daily Updates
  - [ ] 4.3 Populate from distinct values in pdf_uploads

- [ ] **Task 5: Book Filter (AC: 5)**
  - [ ] 5.1 Create dropdown populated from distinct book_title
  - [ ] 5.2 Multi-select enabled
  - [ ] 5.3 Search within dropdown

- [ ] **Task 6: Date Range Filter (AC: 6)**
  - [ ] 6.1 Create date picker inputs (start date, end date)
  - [ ] 6.2 Filter by content updated_at between dates
  - [ ] 6.3 Clear date range option

- [ ] **Task 7: Search Within Results (AC: 7)**
  - [ ] 7.1 Create secondary search bar
  - [ ] 7.2 Client-side filtering of already fetched results
  - [ ] 7.3 Highlight matching text

- [ ] **Task 8: Save Search (AC: 8-9)**
  - [ ] 8.1 Create `saved_searches` table
  - [ ] 8.2 "Save this search" button on search results page
  - [ ] 8.3 Modal to enter search name
  - [ ] 8.4 Saved searches dropdown with quick-apply buttons

- [ ] **Task 9: URL Persistence (AC: 10)**
  - [ ] 9.1 Sync all filter states to URL query parameters
  - [ ] 9.2 Support shareable search URLs
  - [ ] 9.3 Back button restores previous filter state
  - [ ] 9.4 Clear all filters button

- [ ] **Task 10: Unit Tests**
  - [ ] 10.1 Test filter checkbox functionality
  - [ ] 10.2 Test URL synchronization
  - [ ] 10.3 Test save/load saved searches

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
