# Story 1.7: RAG Search Engine - Semantic Query Implementation

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.7
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** to search the knowledge base using natural language queries and receive ranked results with source citations,
**so that** I can quickly find accurate answers grounded in standard UPSC books.

---

## Scope

**INCLUDED:**
- Edge Function for RAG search
- Query embedding generation
- Vector similarity search
- Confidence scoring
- Source citation formatting
- Filter support (subjects, papers)
- Response time optimization

**NOT INCLUDED:**
- Search UI (Story 1.8)
- Search history tracking
- Advanced filters

---

## Acceptance Criteria

1. Edge Function created: `rag_search_pipe.ts` at endpoint `POST /api/search`
2. Request payload: `{ query: string, top_k: number, filters: { subjects, papers, source_types } }`
3. Query embedding generated via OpenAI API (same model as ingestion: text-embedding-3-small)
4. Vector similarity search executed: `ORDER BY content_vector <=> query_embedding LIMIT top_k`
5. Results include: content snippet (first 200 chars), full_content, score (cosine similarity 0-1), metadata (source_file, page, book_title, chapter)
6. Confidence score calculated: scores >0.75 = "High Confidence (XX%)", 0.60-0.75 = "Moderate (XX%)", <0.60 = "Low - Cross-check recommended"
7. If best result score <0.70, return: `{ insufficient_confidence: true, message: "Cannot answer with high confidence" }`
8. Source citation formatted: "Based on [Book Title], Chapter X, Page Y"
9. Response time <500ms (P95) for top 10 results
10. Filter support: filter by `subjects` (Polity, History, etc.), `papers` (GS1, GS2, etc.), `source_types` (NCERT, Standard Books)

---

## Dependencies

**Blocking:** Stories 1.4, 1.6
**Blocks:** Story 1.8 (Search UI)

---

## Tasks / Subtasks

- [ ] **Task 1: Create RAG Search Edge Function** (AC: 1, 2)
  - [ ] Create `rag_search_pipe/index.ts`
  - [ ] Define request schema with Zod
  - [ ] Add auth filter
  - [ ] Add rate limiting filter

- [ ] **Task 2: Generate Query Embedding** (AC: 3)
  - [ ] Call A4F embeddings API with query text
  - [ ] Use text-embedding-ada-002 model
  - [ ] Handle API errors gracefully

- [ ] **Task 3: Execute Vector Similarity Search** (AC: 4)
  - [ ] Query knowledge_chunks with cosine similarity
  - [ ] Apply filters if provided
  - [ ] Limit results to top_k (default 10)

- [ ] **Task 4: Calculate Confidence Scores** (AC: 6)
  - [ ] Convert cosine similarity to percentage
  - [ ] Classify as High/Moderate/Low
  - [ ] Add confidence badge to results

- [ ] **Task 5: Handle Low Confidence** (AC: 7)
  - [ ] Check if best score < 0.70
  - [ ] Return insufficient_confidence flag
  - [ ] Provide helpful message

- [ ] **Task 6: Format Source Citations** (AC: 8)
  - [ ] Extract book_title, chapter, page from metadata
  - [ ] Format as readable citation string

- [ ] **Task 7: Implement Filters** (AC: 10)
  - [ ] Add WHERE clauses for subjects
  - [ ] Add WHERE clauses for papers
  - [ ] Add WHERE clauses for source_types

- [ ] **Task 8: Optimize Performance** (AC: 9)
  - [ ] Use prepared statements
  - [ ] Add query result caching
  - [ ] Measure and log query times

---

## Dev Notes

**Vector Search Query:**
```sql
SELECT
  id,
  chunk_text,
  SUBSTRING(chunk_text, 1, 200) AS snippet,
  1 - (content_vector <=> $1) AS similarity_score,
  source_file,
  source_page,
  book_title,
  syllabus_node_ids
FROM knowledge_chunks
WHERE ($2::text[] IS NULL OR subject = ANY($2))
ORDER BY content_vector <=> $1
LIMIT $3;
```

---

## Definition of Done

- [x] All AC met
- [x] Edge Function deployed
- [x] Search returns relevant results
- [x] Confidence scoring accurate
- [x] Performance <500ms
- [x] Filters working
- [x] Tested with various queries

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-28 | 1.1 | Story verified COMPLETE - all 10 ACs met | Dev Agent |
