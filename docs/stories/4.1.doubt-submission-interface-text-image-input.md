# Story 4.1: Doubt Submission Interface - Text & Image Input

**Epic:** 4 - On-Demand Video Learning
**Story Number:** 4.1
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 5 (Epic 4)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** to submit doubts via text, voice, or screenshot image,
**so that** I can get video explanations for any question regardless of input format.

---

## Acceptance Criteria

1. Doubt submission page: /ask-doubt with prominent input area
2. Input methods: text area (2000 char limit), image upload, voice recording (60s max)
3. Image upload: accept PNG, JPG, PDF; max 10MB; preview thumbnail
4. OCR processing: extract text from images
5. Voice transcription: Whisper API for speech-to-text
6. Style selector: Concise, Detailed, Example-Rich (default: Detailed)
7. Video length selector: 60s, 120s, 180s (Pro only for 180s)
8. Voice preference: dropdown with user's profile default
9. Preview mode: show extracted text, allow edits
10. Entitlement check: Free users limited to 3 doubts/day, Trial/Pro unlimited

---

## Dependencies

**Blocking:** Stories 1.2, 1.9 (Auth, Entitlements)
**Blocks:** Story 4.2

---

## Definition of Done

- [ ] All AC met
- [ ] All 3 input methods working
- [ ] OCR functional
- [ ] Voice transcription working
- [ ] Entitlement checks working
- [ ] Mobile tested

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Frontend Pages: `apps/web/src/app/(dashboard)/ask-doubt/page.tsx`
- Frontend Components: `apps/web/src/components/doubt/`
- API Route: `apps/web/src/app/api/doubts/create/route.ts`

### Data Models

**Database Schema:**
```typescript
interface DoubtSubmission {
  id: UUID
  user_id: UUID NOT NULL
  doubt_text: TEXT NOT NULL
  input_type: TEXT  -- 'text', 'image', 'voice'
  image_url?: TEXT
  voice_url?: TEXT
  transcribed_text?: TEXT  -- from OCR/STT
  style: TEXT  -- 'concise', 'detailed', 'example_rich'
  video_length: INTEGER  -- 60, 120, 180 seconds
  voice_preference: TEXT
  status: TEXT  -- 'pending', 'processing', 'completed', 'failed'
  job_id: UUID
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Endpoint:** `POST /api/doubts/create`
- Request body: `{ doubt_text, image_base64?, voice_base64?, style, video_length, voice }`
- Response: `{ job_id, estimated_time, queue_position }`

**OCR Service:** A4F Image Model (provider-3/gemini-2.5-flash)
**STT Service:** A4F Whisper (provider-5/whisper-1)

### Testing Standards

**Test File Location:**
- Unit Tests: `apps/web/src/components/doubt/**/*.test.tsx`
- E2E Tests: `tests/doubt-submission.spec.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Doubt Submission Page (AC: 1)**
  - [ ] 1.1 Create `apps/web/src/app/(dashboard)/ask-doubt/page.tsx`
  - [ ] 1.2 Prominent input area layout
  - [ ] 1.3 Mobile-responsive design

- [ ] **Task 2: Text Input (AC: 2)**
  - [ ] 2.1 Create `TextInput.tsx` component
  - [ ] 2.2 Character limit: 2000 chars
  - [ ] 2.3 Character counter display
  - [ ] 2.4 Auto-resize textarea

- [ ] **Task 3: Image Upload (AC: 3, 4)**
  - [ ] 3.1 Create `ImageUploader.tsx` component
  - [ ] 3.2 Accept: PNG, JPG, PDF, max 10MB
  - [ ] 3.3 Preview thumbnail on upload
  - [ ] 3.4 Call A4F Vision API for OCR
  - [ ] 3.5 Display extracted text for review

- [ ] **Task 4: Voice Recording (AC: 2, 5)**
  - [ ] 4.1 Create `VoiceRecorder.tsx` component
  - [ ] 4.2 Record up to 60 seconds
  - [ ] 4.3 Waveform visualization
  - [ ] 4.4 Call A4F Whisper API for transcription
  - [ ] 4.5 Display transcribed text

- [ ] **Task 5: Style Selector (AC: 6)**
  - [ ] 5.1 Create `StyleSelector.tsx` component
  - [ ] 5.2 Options: Concise, Detailed, Example-Rich
  - [ ] 5.3 Default: Detailed
  - [ ] 5.4 Save as user preference

- [ ] **Task 6: Video Length Selector (AC: 7)**
  - [ ] 6.1 Create `VideoLengthSelector.tsx`
  - [ ] 6.2 Options: 60s, 120s, 180s
  - [ ] 6.3 180s: Pro only (entitlement check)

- [ ] **Task 7: Voice Preference (AC: 8)**
  - [ ] 7.1 Create `VoicePreferenceSelector.tsx`
  - [ ] 7.2 Dropdown from user profile defaults
  - [ ] 7.3 Options: Male, Female, Neutral

- [ ] **Task 8: Preview Mode (AC: 9)**
  - [ ] 8.1 Create `SubmissionPreview.tsx` component
  - [ ] 8.2 Show extracted text from OCR/STT
  - [ ] 8.3 Allow manual edits
  - [ ] 8.4 Preview before submission

- [ ] **Task 9: Entitlement Check (AC: 10)**
  - [ ] 9.1 Check Free user doubt limit (3/day)
  - [ ] 9.2 Trial/Pro users: unlimited
  - [ ] 9.3 Show upgrade prompt if limit reached

- [ ] **Task 10: Submission API (AC: 1, 10)**
  - [ ] 10.1 Create `POST /api/doubts/create` route
  - [ ] 10.2 Validate inputs
  - [ ] 10.3 Check entitlements
  - [ ] 10.4 Create job in queue
  - [ ] 10.5 Return job_id and estimated time

- [ ] **Task 11: Unit Tests**
  - [ ] 11.1 Test text input validation
  - [ ] 11.2 Test image upload
  - [ ] 11.3 Test voice recording
  - [ ] 11.4 Test entitlement check

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
