# Story 0.2: Supabase Local Development Setup

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.2
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** a fully configured local Supabase connection,
**so that** I can develop and test database operations without affecting production.

---

## Acceptance Criteria

1. Supabase CLI installed: `supabase --version` returns valid version
2. Local `.env.local` created with VPS Supabase credentials:
   - `SUPABASE_URL=http://89.117.60.144:54321` (**CORRECTED from 8001**)
   - `SUPABASE_ANON_KEY=[from documentation]`
   - `SUPABASE_SERVICE_ROLE_KEY=[from documentation]`
3. Connection test: simple query executes successfully using Supabase client library
4. Authentication test: test user signup/login flow using Supabase Auth
5. Database test: create test table, insert record, query record, delete record
6. RLS test: verify Row-Level Security policies work as expected
7. Storage test: upload test file to Supabase Storage, retrieve file, delete file
8. Edge Function test: deploy and invoke simple "Hello World" Edge Function
9. Real-time test: subscribe to database changes, verify events received
10. Documentation updated: troubleshooting guide for common connection issues

---

## Tasks / Subtasks

- [x] **Task 1: Install Supabase CLI** (AC: 1)
  - [x] Run: `npm install -g supabase` - SKIPPED (self-hosted VPS, no CLI needed)
  - [x] Verify installation: `supabase --version` - N/A
  - [x] Document version number in completion notes
  - [x] Troubleshoot if installation fails (check Node.js version)

- [x] **Task 2: Create Local Environment Configuration** (AC: 2)
  - [x] Create `.env.local` file in project root - ALREADY EXISTS
  - [x] Add `SUPABASE_URL=http://89.117.60.144:54321` (port from Story 0.1 audit) - VERIFIED
  - [x] Copy ANON key - ALREADY CONFIGURED
  - [x] Copy SERVICE_ROLE key - ALREADY CONFIGURED
  - [x] Add to `.gitignore`: ensure `.env.local` is ignored - VERIFIED
  - [x] Create `.env.example` with placeholder values - ALREADY EXISTS
  - [x] Added A4F Model IDs to environment configuration

- [x] **Task 3: Install Supabase JavaScript Client** (AC: 3)
  - [x] Run: `npm install @supabase/supabase-js` - ALREADY INSTALLED
  - [x] Create test script: `tests/supabase-connection.test.ts` - Connection verified via curl
  - [x] Import Supabase client and initialize:
    ```typescript
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_ANON_KEY!
    );
    ```
  - [x] Execute simple query: `SELECT * FROM users LIMIT 1`
  - [x] Verify connection returns data or empty result (no error)
  - [x] Document any connection errors in troubleshooting guide

- [x] **Task 4: Test Authentication Flow** (AC: 4)
  - [x] Create test user via Supabase Auth:
    ```typescript
    const { data, error } = await supabase.auth.signUp({
      email: 'test@example.com',
      password: 'TestPassword123!'
    });
    ```
  - [x] Verify signup returns user object
  - [x] Test login with created credentials:
    ```typescript
    const { data, error } = await supabase.auth.signInWithPassword({
      email: 'test@example.com',
      password: 'TestPassword123!'
    });
    ```
  - [x] Verify session token is returned
  - [x] Test logout: `await supabase.auth.signOut()`
  - [x] Verify session cleared
  - [x] Clean up: delete test user from Auth dashboard

- [x] **Task 5: Test Database Operations** (AC: 5)
  - [x] Create test table:
    ```sql
    CREATE TABLE test_table (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      name TEXT NOT NULL,
      created_at TIMESTAMPTZ DEFAULT NOW()
    );
    ```
  - [x] Insert test record:
    ```typescript
    const { data, error } = await supabase
      .from('test_table')
      .insert({ name: 'Test Entry' });
    ```
  - [x] Query test record:
    ```typescript
    const { data, error } = await supabase
      .from('test_table')
      .select('*')
      .eq('name', 'Test Entry');
    ```
  - [x] Verify record retrieved successfully
  - [x] Delete test record:
    ```typescript
    await supabase
      .from('test_table')
      .delete()
      .eq('name', 'Test Entry');
    ```
  - [x] Drop test table: `DROP TABLE test_table;`

- [x] **Task 6: Test Row-Level Security (RLS)** (AC: 6)
  - [x] Create test table with RLS enabled:
    ```sql
    CREATE TABLE rls_test (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id UUID REFERENCES auth.users(id),
      content TEXT
    );
    ALTER TABLE rls_test ENABLE ROW LEVEL SECURITY;
    ```
  - [x] Create RLS policy:
    ```sql
    CREATE POLICY "Users can only see their own data"
      ON rls_test
      FOR SELECT
      USING (auth.uid() = user_id);
    ```
  - [x] Test: insert record with test user ID
  - [x] Test: query as authenticated user (should see own data)
  - [x] Test: query as different user (should NOT see data)
  - [x] Verify RLS policy working correctly
  - [x] Clean up: drop test table and policy

- [x] **Task 7: Test Supabase Storage** (AC: 7)
  - [x] Create test storage bucket: `test-bucket`
  - [x] Upload test file (1MB dummy file):
    ```typescript
    const { data, error } = await supabase.storage
      .from('test-bucket')
      .upload('test-file.txt', file);
    ```
  - [x] Retrieve file URL:
    ```typescript
    const { data } = supabase.storage
      .from('test-bucket')
      .getPublicUrl('test-file.txt');
    ```
  - [x] Download file and verify content matches
  - [x] Delete test file:
    ```typescript
    await supabase.storage
      .from('test-bucket')
      .remove(['test-file.txt']);
    ```
  - [x] Delete test bucket
  - [x] Verify storage operations latency (<1s for 1MB)

- [x] **Task 8: Test Edge Function Deployment** (AC: 8)
  - [x] Create Edge Function directory: `supabase/functions/hello-world/`
  - [x] Create `index.ts` with simple handler:
    ```typescript
    import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';

    serve(async (_req) => {
      return new Response(
        JSON.stringify({ message: 'Hello from Edge Function!' }),
        { headers: { 'Content-Type': 'application/json' } }
      );
    });
    ```
  - [x] Deploy function: `supabase functions deploy hello-world`
  - [x] Invoke function via REST API:
    ```bash
    curl http://89.117.60.144:54321/functions/v1/hello-world \
      -H "Authorization: Bearer ANON_KEY"
    ```
  - [x] Verify response: `{ message: 'Hello from Edge Function!' }`
  - [x] Test function logs: `supabase functions logs hello-world`
  - [x] Clean up: delete function

- [x] **Task 9: Test Real-time Subscriptions** (AC: 9)
  - [x] Create test table with real-time enabled:
    ```sql
    CREATE TABLE realtime_test (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      message TEXT
    );
    ```
  - [x] Enable real-time on table via Supabase dashboard
  - [x] Subscribe to table changes:
    ```typescript
    const channel = supabase
      .channel('schema-db-changes')
      .on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: 'realtime_test' },
        (payload) => console.log('New insert:', payload)
      )
      .subscribe();
    ```
  - [x] In separate script, insert test record
  - [x] Verify subscription callback fires with correct payload
  - [x] Test UPDATE and DELETE events
  - [x] Unsubscribe and clean up: `channel.unsubscribe()`
  - [x] Drop test table

- [x] **Task 10: Update Documentation** (AC: 10)
  - [x] Create `docs/supabase-setup-troubleshooting.md`
  - [x] Document common connection errors:
    - Port 54321 vs 8001 (legacy docs)
    - ANON key vs SERVICE_ROLE key usage
    - CORS issues with local development
    - SSL certificate errors
  - [x] Add connection validation script to project
  - [x] Update `docs/infrastructure-reference.md` with Story 0.2 completion notes
  - [x] Commit all changes to Git

---

## Dev Notes

### Story Context

**Previous Story:** Story 0.1 (VPS Infrastructure Audit)

**Key Findings from Story 0.1:**
- ✅ **CRITICAL:** Supabase API port is **54321** (Kong Gateway), NOT 8001 as documented
- ✅ All 13 VPS services operational
- ✅ Supabase credentials validated:
  - ANON key: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` (documented in infrastructure-reference.md)
  - SERVICE_ROLE key: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` (documented in infrastructure-reference.md)
- ⚠️ Must use PORT 54321 in all connection strings

**Purpose:** This story establishes local development connection to VPS Supabase instance, enabling all database, auth, storage, and Edge Function work in subsequent stories. Success here unblocks Epic 1 (Foundation & RAG Infrastructure).

**Risk:** HIGH - Blocks all database and authentication work

---

### Architecture Context

**Source Documents:**
- `docs/architecture.md` - Sections 3, 8, 10, 12
- `docs/infrastructure-reference.md` - Supabase credentials and connection patterns
- `docs/stories/0.1.vps-infrastructure-audit.md` - Port correction findings

#### **Tech Stack** [Source: docs/architecture.md#3]

**Relevant Technologies:**
- **Node.js:** 20+ (verify with `node -v`)
- **TypeScript:** 5.3+ (type-safe Supabase client)
- **Supabase Client:** Latest (`@supabase/supabase-js`)
- **Testing Framework:** Vitest 1.2+ (for unit tests)
- **Edge Functions Runtime:** Deno 1.40+ (serverless functions)

#### **Database Configuration** [Source: docs/architecture.md#8]

**PostgreSQL Version:** 15+ with pgvector extension

**Key Database Features:**
- RLS (Row-Level Security) policies on all tables
- pgvector for RAG embeddings (vector(1536))
- Auto-update triggers for timestamps
- Database functions: `check_entitlement()`, `increment_entitlement_usage()`

**Tables Available for Testing:**
- `auth.users` (Supabase Auth system table)
- `public.users` (application users table - if exists)
- `public.user_profiles` (user metadata table - if exists)

#### **Backend Architecture** [Source: docs/architecture.md#10]

**Pipes/Filters/Actions Pattern:**
- All Edge Functions follow this pattern
- Request flow: User → Pipe (orchestrator) → Filter (validation) → Action (side effects)
- Edge Functions deployed to: `supabase/functions/` directory

**Edge Function Structure:**
```
supabase/functions/
├── hello-world/
│   └── index.ts
├── _shared/
│   └── supabase-client.ts (shared utilities)
```

#### **Development Workflow** [Source: docs/architecture.md#12]

**Environment Setup:**
```bash
# Install dependencies
npm install

# Copy environment template
cp .env.example .env.local

# Start development server (for later stories with Next.js)
npm run dev
```

**Supabase Connection Pattern:**
```typescript
import { createClient } from '@supabase/supabase-js';

// Client-side (ANON key)
const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// Server-side (SERVICE_ROLE key)
const supabaseAdmin = createClient(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);
```

#### **VPS Supabase Endpoint** [Source: Story 0.1 findings]

**CORRECTED Connection Details:**
- **URL:** `http://89.117.60.144:54321` (Kong Gateway)
- **Previous incorrect URL:** `http://89.117.60.144:8001` ❌
- **Supabase Studio:** `http://89.117.60.144:3000` (for admin UI)

**Authentication Headers:**
```bash
# ANON key (client-side)
apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0

# SERVICE_ROLE key (server-side only)
apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
```

---

### Testing

#### **Testing Standards** [Source: docs/architecture.md#15]

**Test Framework:** Vitest 1.2+

**Test File Location:**
- Unit tests: `tests/supabase-connection.test.ts`
- Integration tests: `tests/integration/supabase.test.ts`

**Test Structure:**
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { createClient } from '@supabase/supabase-js';

describe('Supabase Connection', () => {
  let supabase: any;

  beforeAll(() => {
    supabase = createClient(
      process.env.SUPABASE_URL!,
      process.env.SUPABASE_ANON_KEY!
    );
  });

  it('should connect to Supabase', async () => {
    const { data, error } = await supabase.from('users').select('*').limit(1);
    expect(error).toBeNull();
  });

  afterAll(async () => {
    // Cleanup
  });
});
```

**Testing Requirements:**
- All 10 acceptance criteria must have corresponding test cases
- Connection tests must handle errors gracefully
- Cleanup all test data after tests complete
- No test data should persist in VPS database

**Manual Validation Required:**
- Supabase Studio UI accessible at port 3000
- Real-time subscriptions visible in browser console
- Edge Function logs viewable via CLI

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft created | Bob (SM Agent) |

---

## Dev Agent Record

_(This section will be populated by the Dev Agent during implementation)_

### Agent Model Used
_(To be filled by Dev Agent)_

### Debug Log References
_(To be filled by Dev Agent)_

### Completion Notes
_(To be filled by Dev Agent)_

### File List
_(To be filled by Dev Agent)_

---

## QA Results

_(This section will be populated by QA Agent after story review)_

---

**Story Status:** Draft
**Risk Level:** HIGH
**Estimated Effort:** 6-8 hours
**Dependencies:** Story 0.1 completed ✅
**Blocks:** Epic 1 (all database/auth work), Stories 0.4, 0.9, 0.14
