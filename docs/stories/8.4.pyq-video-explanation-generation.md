# Story 8.4: PYQ System - Video Explanation Generation

**Epic:** 8 - Practice & Evaluation - PYQs & Question Bank
**Story Number:** 8.4
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 9 (Epic 8)
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** UPSC aspirant,
**I want** video explanations for every PYQ,
**so that** I can understand the question requirements and learn how to approach similar questions.

---

## Acceptance Criteria

1. Video generation: for each PYQ, creates 3-5 minute video explanation
2. Script structure: (1) Question analysis, (2) Key concepts, (3) Model answer breakdown, (4) Common mistakes, (5) Exam tips
3. Script generation: Edge Function calls A4F LLM with model answer and question context
4. Visual markers: script includes [DIAGRAM], [TIMELINE], [MAP] markers for Manim scenes
5. Manim scenes: generates relevant visuals (concept maps, timelines, flowcharts) based on question type
6. Revideo assembly: combines TTS narration, Manim scenes, text overlays, transitions
7. Video storage: saves to Supabase Storage at `pyq-videos/{year}/{paper_type}/q{number}.mp4`
8. Database: `pyq_videos` table with question_id, video_url, duration, script_text, created_at
9. Rendering queue: processes videos in background queue (max 10 concurrent renders)
10. Priority processing: Prelims questions processed first, then Mains (based on demand)

---

## Dependencies

**Blocking:** Stories 8.3, 0.5, 0.6, 0.8 (model answers, Manim, Revideo, video orchestrator)
**Blocks:** Story 8.5

---

## Definition of Done

- [ ] All AC met
- [ ] Videos generated correctly
- [ ] Manim scenes integrated
- [ ] Queue system working
- [ ] Tests passing

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations (from `docs/architecture/source-tree.md`):**
- Edge Functions: `packages/supabase/functions/pipes/` and `packages/supabase/functions/actions/`
- Frontend Components: `apps/web/src/components/video/` for video player
- Frontend Pages: `apps/web/src/app/(dashboard)/pyqs/`
- Types: `packages/supabase/types/database.types.ts`

### Data Models

**Database Schema (from Stories 8.1-8.3):**
- `pyq_questions` - Questions with year, paper_type, number, subject, text, marks
- `pyq_model_answers` - Model answers linked to questions
- New table: `pyq_videos` - Stores video explanations

**TypeScript Interface:**
```typescript
interface PyqVideo {
  id: UUID
  question_id: UUID NOT NULL
  video_url: TEXT
  duration_seconds: INTEGER
  script_text: TEXT
  status: TEXT CHECK (status IN ('queued', 'processing', 'completed', 'failed'))
  render_metadata: JSONB
  created_at: TIMESTAMPTZ
  updated_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function Pipe:** `pyq_video_explanation_pipe`
- Location: `packages/supabase/functions/pipes/pyq_video_explanation_pipe/index.ts`
- Method: POST
- Request body: `{ question_id: string, priority?: 'prelims' | 'mains' }`
- Response: `{ jobId: string, status: 'queued' }`

**VPS Services Used:**
- A4F LLM (`provider-3/llama-4-scout`) for script generation
- Manim Renderer (`:5000`) for visual scenes
- Revideo Renderer (`:5001`) for video assembly
- Video Orchestrator (`:8103`) for coordination

### Component Specifications

**Frontend Components:**
- `PyqVideoPlayer.tsx` - Video player for PYQ explanations
- Location: `apps/web/src/components/video/PyqVideoPlayer.tsx`

**Props Interface:**
```typescript
interface PyqVideoPlayerProps {
  questionId: string
  questionText: string
  videoUrl?: string
  onGenerate?: () => void
}
```

### Video Script Structure

**Script Template (from `docs/architecture.md#video-generation`):**
```typescript
interface PyqVideoScript {
  question_id: string
  sections: {
    type: 'intro' | 'analysis' | 'concepts' | 'mistakes' | 'tips'
    narration: string
    duration_seconds: number
    visual_markers?: string[]  // [DIAGRAM], [TIMELINE], [MAP]
    manim_scene_specs?: object[]
  }[]
}
```

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/pyq_video_explanation_pipe/index.test.ts`
- Test Framework: Deno Test

**Required Tests:**
1. Returns 401 without auth header
2. Returns 404 for non-existent question_id
3. Returns 202 with jobId for valid request
4. Video storage path follows expected format

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Creation (AC: 8)**
  - [ ] 1.1 Create `pyq_videos` table with columns: id, question_id, video_url, duration_seconds, script_text, status, render_metadata
  - [ ] 1.2 Add foreign key constraint to `pyq_questions`
  - [ ] 1.3 Create indexes on question_id and status
  - [ ] 1.4 Create RLS policies for video access
  - [ ] 1.5 Update TypeScript types in `database.types.ts`

- [ ] **Task 2: Script Generation Action (AC: 2-5)**
  - [ ] 2.1 Create `packages/supabase/functions/actions/generate_pyq_script_action.ts`
  - [ ] 2.2 Fetch question and model answer from DB
  - [ ] 2.3 Call A4F LLM to generate 5-section script
  - [ ] 2.4 Add visual markers: [DIAGRAM], [TIMELINE], [MAP]
  - [ ] 2.5 Generate Manim scene specs based on question type

- [ ] **Task 3: Edge Function Pipe (AC: 1, 9)**
  - [ ] 3.1 Create `packages/supabase/functions/pipes/pyq_video_explanation_pipe/index.ts`
  - [ ] 3.2 Apply `auth_filter` for authentication
  - [ ] 3.3 Check entitlement (Pro feature)
  - [ ] 3.4 Create video job record in `pyq_videos` table
  - [ ] 3.5 Call `generate_pyq_script_action`
  - [ ] 3.6 Call `render_video_action` via VPS orchestrator

- [ ] **Task 4: Manim Scene Generation (AC: 4, 7)**
  - [ ] 4.1 Generate concept maps for abstract questions
  - [ ] 4.2 Create timelines for historical questions
  - [ ] 4.3 Generate flowcharts for process-based questions
  - [ ] 4.4 Cache scenes in `manim_scene_cache` for reuse
  - [ ] 4.5 Mark scenes with question_id for tracking

- [ ] **Task 5: Video Assembly & Storage (AC: 6, 7)**
  - [ ] 5.1 Call VPS Revideo Renderer via Video Orchestrator
  - [ ] 5.2 Combine TTS narration, Manim scenes, text overlays, transitions
  - [ ] 5.3 Save to Supabase Storage: `pyq-videos/{year}/{paper_type}/q{number}.mp4`
  - [ ] 5.4 Update `pyq_videos` table with video_url and duration

- [ ] **Task 6: Queue Management (AC: 9)**
  - [ ] 6.1 Priority queue: Prelims questions before Mains
  - [ ] 6.2 Max 10 concurrent renders per Story 0.10 queue system
  - [ ] 6.3 Status updates in `pyq_videos` table
  - [ ] 6.4 Handle failed renders with retry logic

- [ ] **Task 7: Frontend Integration (AC: 1)**
  - [ ] 7.1 Create `PyqVideoPlayer.tsx` component
  - [ ] 7.2 Add to PYQ detail page
  - [ ] 7.3 Show "Generate Video" button for unanswered questions
  - [ ] 7.4 Display video player when available
  - [ ] 7.5 Show progress indicator during generation

- [ ] **Task 8: Unit Tests (All AC)**
  - [ ] 8.1 Write Deno tests for pipe authentication
  - [ ] 8.2 Write Deno tests for script generation
  - [ ] 8.3 Write Deno tests for video job creation

- [ ] **Task 9: Integration Testing**
  - [ ] 9.1 End-to-end test: generate PYQ video → render → play

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Clarity Score:** 9/10

**Major Gaps Identified:** None

**Developer Perspective:** A developer can implement this story as written. Queue priority logic and video storage paths are clearly defined.

---

**Story Status:** Draft → **Ready for Review**
