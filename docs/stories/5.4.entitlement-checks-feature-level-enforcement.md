# Story 5.4: Entitlement Checks - Feature-Level Enforcement

**Epic:** 5 - Monetization & Subscription System
**Story Number:** 5.4
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 6
**Estimated Effort:** Large (L)
**Risk Level:** HIGH (Access control critical)

---

## Story

**As a** product manager,
**I want** granular entitlement checks on every premium feature to enforce access control,
**so that** only authorized users can use paid features while maintaining excellent UX.

---

## Acceptance Criteria

1. Feature manifest table: feature_manifests (feature_slug, name, tier, description)
2. Tiers: Free, Trial, Pro Monthly, Pro Annual
3. Entitlement check: checkEntitlement(user_id, feature_slug)
4. Returns: { allowed, reason, show_paywall, upgrade_cta }
5. Client-side: check before rendering premium buttons
6. Server-side: Edge Functions enforce before processing
7. Paywall modal: shown when not allowed, plan comparison, Upgrade button
8. Soft paywalls: Free users see grayed out features with Pro badge
9. Hard blocks: API returns 403 if entitlement fails
10. Cache entitlements: 5-minute client cache, refresh on subscription change

---

## Dependencies

**Blocking:** Stories 5.1, 5.3
**Blocks:** All premium features

---

## Definition of Done

- [ ] All AC met
- [ ] Entitlement function working
- [ ] Client checks working
- [ ] Server checks enforced
- [ ] Paywall modals functional
- [ ] Caching working

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
