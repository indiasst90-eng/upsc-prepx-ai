# Story 8.7: Question Bank - MCQ Distractor Generation

**Epic:** 8 - Practice & Evaluation - PYQs & Question Bank
**Story Number:** 8.7
**Status:** COMPLETE
**Created:** December 23, 2025
**Completed:** December 28, 2025
**Sprint:** Sprint 9 (Epic 8)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** system,
**I want** to generate high-quality distractors for MCQ questions,
**so that** practice questions are challenging and test conceptual understanding.

---

## Acceptance Criteria

1. Distractor generation: for each MCQ, generates 3 plausible incorrect options
2. Distractor quality: options should be factually incorrect but conceptually related to the topic
3. Common mistakes: includes distractors based on common misconceptions and exam patterns
4. AI prompt: "Generate 3 plausible but incorrect options for this MCQ. Make them challenging by using related concepts, partial truths, or common errors."
5. Validation: ensures no duplicate options, no obviously wrong options (e.g., dates that don't exist)
6. Option shuffling: randomizes option order (A, B, C, D) for each user to prevent pattern memorization
7. Explanation generation: creates 2-3 sentence explanation for why each distractor is incorrect
8. Database: stores distractors and explanations in `question_options` table
9. Quality scoring: tracks question difficulty based on answer success rate, adjusts distractors if too easy/hard
10. Admin review: admins can edit/replace distractors if quality is poor

---

## Dependencies

**Blocking:** Stories 8.6, 0.3 (question generator, A4F API)
**Blocks:** Story 8.8

---

## Definition of Done

- [x] All AC met
- [x] Distractors are challenging
- [x] Explanations helpful
- [x] Quality control working
- [x] Tests passing

---

## Implementation Summary

### Files Created/Modified

**Database Migration:**
- `packages/supabase/migrations/040_mcq_distractors.sql` - Created tables for question_options, question_attempts with RLS and quality tracking functions

**TypeScript Types:**
- `apps/web/src/types/database.types.ts` - Added question_options and question_attempts types

**API Route:**
- `apps/web/src/app/api/questions/distractors/route.ts` - Complete distractor API with:
  - POST: Generate new distractors with AI
  - GET: Fetch shuffled options for a question
  - PATCH: Record attempt and update quality

**Edge Function Action:**
- `packages/supabase/functions/actions/generate_distractor_action.ts` - Reusable distractor generation logic

**Admin UI:**
- `apps/admin/src/app/distractors/page.tsx` - Admin review interface for low-quality distractors

### Acceptance Criteria Verification

| AC | Requirement | Status | Implementation |
|----|-------------|--------|----------------|
| 1 | Generate 3 plausible distractors | ✅ | AI prompt generates exactly 3 validated distractors |
| 2 | Factually incorrect but related | ✅ | Prompt engineering + validation checks |
| 3 | Common mistakes included | ✅ | Distractor types: common_mistake, partial_truth, etc. |
| 4 | AI prompt for generation | ✅ | Comprehensive UPSC-specific prompt |
| 5 | Validation (no duplicates) | ✅ | validateDistractor() function |
| 6 | Option shuffling | ✅ | Fisher-Yates shuffle algorithm |
| 7 | Explanation generation | ✅ | 2-3 sentence explanation for each |
| 8 | Database storage | ✅ | question_options table with full schema |
| 9 | Quality scoring | ✅ | update_distractor_quality() RPC function |
| 10 | Admin review | ✅ | Admin dashboard at /admin/distractors |

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-28 | 2.0 | Full implementation complete | BMAD DEV Agent |
