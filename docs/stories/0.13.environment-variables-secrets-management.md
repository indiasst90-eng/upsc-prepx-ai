# Story 0.13: Environment Variables & Secrets Management

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.13
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** secure environment variable management across local and production,
**so that** API keys and secrets are never exposed in code.

---

## Acceptance Criteria

1. `.env.example` template created with all required variables (30+ variables)
2. Local `.env.local` file created (git-ignored) with actual values
3. Supabase Secrets configured: all Edge Function secrets added via Supabase dashboard
4. Vercel environment variables: all frontend secrets added to Vercel project
5. Environment validation: startup script checks for missing required variables
6. Type-safe env access: `@upsc-ai/config` package provides typed env object
7. Separate environments: `development`, `staging`, `production` configs
8. Secret rotation documented: procedures for updating API keys
9. No secrets in code: ESLint rule blocks hardcoded secrets
10. Documentation updated: `docs/infrastructure-reference.md` lists all required env vars

---

## Tasks / Subtasks

- [ ] **Task 1: Create .env.example Template** (AC: 1, 10)
  - [ ] List all required environment variables from architecture docs
  - [ ] Organize variables by category (Supabase, A4F, VPS, RevenueCat, etc.)
  - [ ] Add descriptive comments for each variable
  - [ ] Include example values (non-sensitive placeholders)
  - [ ] Save to project root: `.env.example`
  - [ ] Update `docs/infrastructure-reference.md` with variable descriptions

- [ ] **Task 2: Create Local .env.local File** (AC: 2)
  - [ ] Copy `.env.example` to `.env.local`
  - [ ] Fill in actual values from VPS infrastructure audit (Story 0.1)
  - [ ] Add Supabase credentials (ANON_KEY, SERVICE_ROLE_KEY)
  - [ ] Add A4F API key: `ddc-a4f-12e06ff0184f41de8d3de7be4cd2e831`
  - [ ] Add VPS service URLs (ports 5000, 5001, 8101-8104)
  - [ ] Verify `.env.local` is in `.gitignore`
  - [ ] Test that `.env.local` is NOT committed to git

- [ ] **Task 3: Configure Supabase Edge Function Secrets** (AC: 3)
  - [ ] Access Supabase dashboard: `http://89.117.60.144:3000`
  - [ ] Navigate to Project Settings → Edge Functions → Secrets
  - [ ] Add `A4F_API_KEY` secret
  - [ ] Add VPS service URL secrets (8 URLs)
  - [ ] Add `REVENUECAT_SECRET_API_KEY` (placeholder for now)
  - [ ] Test secret access from test Edge Function
  - [ ] Document secret management process in infrastructure docs

- [ ] **Task 4: Configure Vercel Environment Variables** (AC: 4)
  - [ ] Create Vercel project (if not already created)
  - [ ] Navigate to Project Settings → Environment Variables
  - [ ] Add `NEXT_PUBLIC_SUPABASE_URL` (public)
  - [ ] Add `NEXT_PUBLIC_SUPABASE_ANON_KEY` (public)
  - [ ] Add non-public variables (if any for frontend)
  - [ ] Test environment variable access in Next.js app
  - [ ] Document Vercel env var configuration

- [ ] **Task 5: Create Environment Validation Script** (AC: 5)
  - [ ] Create `packages/config/src/validate-env.ts`
  - [ ] Use Zod to define required environment variable schema
  - [ ] Check for missing required variables on startup
  - [ ] Throw descriptive error if variables are missing
  - [ ] Add validation to Next.js `next.config.js`
  - [ ] Add validation to Supabase Edge Functions

- [ ] **Task 6: Create Type-Safe Environment Config Package** (AC: 6)
  - [ ] Create `packages/config` workspace
  - [ ] Create `src/env.ts` with typed environment object
  - [ ] Export `env` object with autocomplete for all variables
  - [ ] Handle client vs server environment variables
  - [ ] Add tests for environment validation
  - [ ] Import `@upsc-ai/config` in apps

- [ ] **Task 7: Configure Multi-Environment Setup** (AC: 7)
  - [ ] Create `.env.development`, `.env.staging`, `.env.production` templates
  - [ ] Document differences between environments
  - [ ] Configure Next.js to load correct env file per environment
  - [ ] Configure Supabase CLI for local vs remote
  - [ ] Test environment switching (local → staging → production)

- [ ] **Task 8: Document Secret Rotation Procedures** (AC: 8)
  - [ ] Create `docs/security/secret-rotation-guide.md`
  - [ ] Document A4F API key rotation steps
  - [ ] Document Supabase key rotation (ANON_KEY, SERVICE_ROLE_KEY)
  - [ ] Document VPS service credential updates
  - [ ] Document RevenueCat key rotation
  - [ ] Add rotation schedule recommendations (e.g., every 90 days)

- [ ] **Task 9: Configure ESLint Rule for Hardcoded Secrets** (AC: 9)
  - [ ] Install `eslint-plugin-no-secrets` or similar
  - [ ] Configure rule in `packages/config/eslint-config`
  - [ ] Add patterns for API key detection (regex for common formats)
  - [ ] Test ESLint catches hardcoded secrets
  - [ ] Run ESLint on entire codebase to verify no existing secrets
  - [ ] Add pre-commit hook to block commits with secrets

- [ ] **Task 10: Final Documentation Update** (AC: 10)
  - [ ] Update `docs/infrastructure-reference.md` with all env vars
  - [ ] Add troubleshooting section for common env var issues
  - [ ] Document how to add new environment variables
  - [ ] Create quick reference table of all variables
  - [ ] Verify `.env.example` matches documentation

- [ ] **Task 11: Security Verification** (AC: All)
  - [ ] Verify `.env.local` is git-ignored
  - [ ] Verify no secrets in git history (scan with tool)
  - [ ] Verify Supabase SERVICE_ROLE_KEY never used client-side
  - [ ] Verify all VPS URLs only called from Edge Functions
  - [ ] Run security audit: `npm audit`, `pnpm audit`
  - [ ] Document security best practices in README

---

## Dev Notes

### Relevant Architecture Information

**Source Tree Reference:** [Source: docs/architecture/source-tree.md]

```
upsc-ai-mentor/
├── .env.example          # Template with all variables
├── .env.local            # Local development (git-ignored)
├── .env.development      # Development environment
├── .env.staging          # Staging environment
├── .env.production       # Production environment
├── packages/
│   └── config/           # Shared environment config
│       ├── src/
│       │   ├── env.ts    # Type-safe env object
│       │   └── validate-env.ts  # Validation logic
│       └── package.json
```

**Tech Stack Reference:** [Source: docs/architecture/tech-stack.md]

- **Environment Validation:** Zod (TypeScript-first schema validation)
- **Build Tool:** Turborepo (shares env config across packages)
- **Monorepo:** pnpm workspaces
- **ESLint:** Custom config in `packages/config/eslint-config`

**Coding Standards Reference:** [Source: docs/architecture/coding-standards.md]

- Never expose `SUPABASE_SERVICE_ROLE_KEY` to frontend
- Always use `SUPABASE_ANON_KEY` on client side
- Use `NEXT_PUBLIC_*` prefix for client-accessible variables in Next.js
- Validate environment variables on application startup

### Required Environment Variables (30+ variables)

**Supabase (3 variables):**
```bash
NEXT_PUBLIC_SUPABASE_URL=http://89.117.60.144:8001
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # Server-side only
```

**A4F Unified API (2 variables):**
```bash
A4F_API_KEY=ddc-a4f-12e06ff0184f41de8d3de7be4cd2e831
A4F_BASE_URL=https://api.a4f.co/v1
```

**VPS Services (8 variables):**
```bash
VPS_SUPABASE_STUDIO_URL=http://89.117.60.144:3000
VPS_SUPABASE_API_URL=http://89.117.60.144:8001
VPS_MANIM_URL=http://89.117.60.144:5000
VPS_REVIDEO_URL=http://89.117.60.144:5001
VPS_COOLIFY_URL=http://89.117.60.144:8000
VPS_RAG_URL=http://89.117.60.144:8101
VPS_SEARCH_URL=http://89.117.60.144:8102
VPS_ORCHESTRATOR_URL=http://89.117.60.144:8103
VPS_NOTES_URL=http://89.117.60.144:8104
```

**RevenueCat (2 variables):**
```bash
REVENUECAT_SECRET_API_KEY=<to_be_configured>
REVENUECAT_PUBLIC_KEY=<to_be_configured>
```

**Optional Services (5 variables):**
```bash
REDIS_URL=redis://localhost:6379  # Optional for caching
SENTRY_DSN=<to_be_configured>     # Error tracking
AXIOM_TOKEN=<to_be_configured>    # Logging
VERCEL_URL=<auto_set_by_vercel>   # Deployment URL
NODE_ENV=development              # Environment
```

**Application Config (5 variables):**
```bash
TRIAL_DURATION_DAYS=7
MAX_VIDEO_DURATION_SECONDS=600
RATE_LIMIT_REQUESTS_PER_MINUTE=100
LOG_LEVEL=info
ENABLE_DEBUG_MODE=false
```

### Environment Validation Example (Zod)

```typescript
// packages/config/src/env.ts
import { z } from 'zod'

const envSchema = z.object({
  // Supabase
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1).optional(), // Server-side only

  // A4F
  A4F_API_KEY: z.string().startsWith('ddc-a4f-'),
  A4F_BASE_URL: z.string().url(),

  // VPS Services
  VPS_MANIM_URL: z.string().url(),
  VPS_REVIDEO_URL: z.string().url(),
  VPS_RAG_URL: z.string().url(),
  VPS_SEARCH_URL: z.string().url(),
  VPS_ORCHESTRATOR_URL: z.string().url(),
  VPS_NOTES_URL: z.string().url(),

  // Optional
  REDIS_URL: z.string().url().optional(),
  NODE_ENV: z.enum(['development', 'staging', 'production']).default('development'),
})

export const env = envSchema.parse(process.env)
```

### Security Best Practices

1. **Never commit `.env.local`** - Add to `.gitignore`
2. **Use different keys per environment** - Dev, staging, prod keys should differ
3. **Rotate secrets regularly** - Every 90 days or after team member departure
4. **Principle of least privilege** - Edge Functions get only required secrets
5. **Audit secret access** - Log when SERVICE_ROLE_KEY is used
6. **Encrypt secrets at rest** - Vercel/Supabase handle this automatically
7. **Use environment-specific URLs** - Don't use prod VPS in dev

### Previous Story Insights

From **Story 0.1 (VPS Infrastructure Audit)**:
- VPS is accessible at `89.117.60.144`
- All 13 services are operational
- Supabase port is `8001` (not `54321` as initially documented)
- No authentication currently required for VPS services (needs securing)

From **Story 0.2 (Supabase Local Development)**:
- Supabase ANON_KEY: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0`
- Supabase SERVICE_ROLE_KEY: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU`

---

## Testing

**Test File Location:** [Source: docs/architecture/coding-standards.md#testing-standards]
- Unit tests: `packages/config/src/env.test.ts`
- Integration tests: Test environment loading in Next.js app

**Testing Framework:** Vitest (for packages)

**Test Cases:**
1. **Valid environment:** All required variables present → env object created
2. **Missing required variable:** Throw error with clear message
3. **Invalid URL format:** Throw validation error
4. **Invalid API key format:** Throw validation error
5. **Optional variable missing:** Use default value
6. **Server-only variable on client:** Throw error or return undefined
7. **Environment switching:** Load correct env file per NODE_ENV

**Example Test:**
```typescript
// packages/config/src/env.test.ts
import { describe, it, expect } from 'vitest'
import { z } from 'zod'

describe('Environment Validation', () => {
  it('should parse valid environment variables', () => {
    const env = {
      NEXT_PUBLIC_SUPABASE_URL: 'http://localhost:8001',
      NEXT_PUBLIC_SUPABASE_ANON_KEY: 'test-key',
      A4F_API_KEY: 'ddc-a4f-test',
      A4F_BASE_URL: 'https://api.a4f.co/v1',
    }

    expect(() => envSchema.parse(env)).not.toThrow()
  })

  it('should throw on missing required variable', () => {
    const env = {
      NEXT_PUBLIC_SUPABASE_URL: 'http://localhost:8001',
      // Missing ANON_KEY
    }

    expect(() => envSchema.parse(env)).toThrow()
  })

  it('should reject invalid API key format', () => {
    const env = {
      A4F_API_KEY: 'invalid-format', // Must start with 'ddc-a4f-'
    }

    expect(() => envSchema.parse(env)).toThrow()
  })
})
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Claude (SM Agent) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_Files created/modified during implementation will be listed here_

---

## QA Results

_Results from QA Agent review will be recorded here after story completion_
