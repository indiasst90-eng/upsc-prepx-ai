# Story 4.6: 60-Second Topic Shorts - On-Demand Generation

**Epic:** 4 - On-Demand Video Learning
**Story Number:** 4.6
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 5
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** to generate 60-second explainer videos for any syllabus topic instantly,
**so that** I can quickly understand concepts without reading long notes.

---

## Acceptance Criteria

1. "Generate Short" button on every syllabus node and notes page
2. Confirmation modal: "Generate 60s video for [Topic]? (Uses 1 credit)"
3. Free users: show upgrade prompt
4. Edge Function: topic_shorts_pipe.ts
5. Script auto-generated from topic description + RAG context
6. Fixed format: 150 words, 60 seconds
7. Manim: 1 simple diagram (cache-first)
8. TTS: user's preferred voice
9. Revideo assembly: <45s total generation time
10. Video cached: same topic reuses video for 7 days

---

## Dependencies

**Blocking:** Stories 1.4, 1.9, 4.3, 4.4
**Blocks:** None

---

## Definition of Done

- [ ] All AC met
- [ ] Generation <60s total
- [ ] Caching working
- [ ] Entitlement checks working
- [ ] Videos playing correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Frontend Components: `apps/web/src/components/topic/GenerateShortButton.tsx`
- Edge Functions: `packages/supabase/functions/pipes/topic_shorts_pipe/`

### Data Models

**Database Schema:**
```typescript
interface TopicShort {
  id: UUID
  user_id: UUID NOT NULL
  syllabus_node_id: UUID NOT NULL
  video_url: TEXT
  script_text: TEXT  -- 150 words, fixed
  status: TEXT  -- 'pending', 'completed', 'failed'
  cached_until: TIMESTAMPTZ  -- 7 days from creation
  credits_used: INTEGER DEFAULT 1
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `topic_shorts_pipe`
- Location: `packages/supabase/functions/pipes/topic_shorts_pipe/index.ts`
- Method: POST
- Request: `{ syllabus_node_id }`
- Response: `{ job_id, credits_cost: 1 }`

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/topic_shorts_pipe/index.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Generate Short Button (AC: 1)**
  - [ ] 1.1 Create `GenerateShortButton.tsx` component
  - [ ] 1.2 Add to syllabus node cards
  - [ ] 1.3 Add to notes pages
  - [ ] 1.4 Disable if credits insufficient

- [ ] **Task 2: Confirmation Modal (AC: 2)**
  - [ ] 2.1 Create `ConfirmGenerateModal.tsx`
  - [ ] 2.2 Display: "Generate 60s video for [Topic]? (Uses 1 credit)"
  - [ ] 2.3 Confirm/Cancel buttons
  - [ ] 2.4 Show credit balance

- [ ] **Task 3: Entitlement Check (AC: 3)**
  - [ ] 3.1 Check if user has credits
  - [ ] 3.2 Free users: show upgrade prompt
  - [ ] 3.3 Trial/Pro users: deduct from quota

- [ ] **Task 4: Script Generation (AC: 4, 6)**
  - [ ] 4.1 Create `topic_shorts_pipe/index.ts`
  - [ ] 4.2 Fetch topic description from syllabus_nodes
  - [ ] 4.3 Call RAG for context chunks
  - [ ] 4.4 Generate fixed script: 150 words, 60 seconds
  - [ ] 4.5 Structure: intro → key points → conclusion

- [ ] **Task 5: Video Generation (AC: 5, 7)**
  - [ ] 5.1 Reuse Story 4.3 Manim action (1 simple diagram)
  - [ ] 5.2 Cache-first strategy
  - [ ] 5.3 Reuse cached video if available (80% similarity)
  - [ ] 5.4 Call TTS with user's voice
  - [ ] 5.5 Reuse Story 4.4 Revideo assembly

- [ ] **Task 6: Performance Target (AC: 8)**
  - [ ] 6.1 Target: <45 seconds total
  - [ ] 6.2 Priority: high in queue
  - [ ] 6.3 Skip queue if cached video exists

- [ ] **Task 7: Caching (AC: 9)**
  - [ ] 7.1 Store video URL with cached_until timestamp
  - [ ] 7.2 Cache duration: 7 days
  - [ ] 7.3 Same topic reuses cached video
  - [ ] 7.4 Clear cache after 7 days

- [ ] **Task 8: Unit Tests**
  - [ ] 8.1 Test credit deduction
  - [ ] 8.2 Test cache hit
  - [ ] 8.3 Test script generation
  - [ ] 8.4 Test performance target

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft → **Ready for Review**
