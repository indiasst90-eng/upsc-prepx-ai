# Story 7.3: Answer Writing - Video Feedback Generation

**Epic:** 7 - Practice & Evaluation - Answer Writing & Essays
**Story Number:** 7.3
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 8 (Epic 7)
**Estimated Effort:** Large (L)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** a video explanation of my answer evaluation,
**so that** I can understand my mistakes and learn how to improve.

---

## Acceptance Criteria

1. Video generation: automatically creates 2-3 min feedback video after evaluation completes
2. Script generation: converts evaluation feedback JSON into narrative script
3. Script structure: (1) Score summary, (2) Strengths, (3) Areas for improvement, (4) Model answer comparison, (5) Action items
4. Manim visualizations: creates structure diagram showing answer flow, highlights missing elements
5. Answer comparison: side-by-side visual of user answer vs model answer structure
6. Revideo assembly: combines TTS narration, Manim diagrams, text overlays, transitions
7. Video storage: saves to Supabase Storage at `feedback-videos/{user_id}/answer_{submission_id}.mp4`
8. Database: updates `answer_evaluations` with video_url field
9. Entitlement: video feedback only for Pro users, Free users get text feedback only
10. Notification: sends push notification "Your answer feedback video is ready!" when generation completes

---

## Dependencies

**Blocking:** Stories 7.2, 0.5, 0.6 (evaluation done, Manim/Revideo services)
**Blocks:** Story 7.4

---

## Definition of Done

- [ ] All AC met
- [ ] Videos generated correctly
- [ ] Manim diagrams integrated
- [ ] Comparison visualization working
- [ ] Tests passing

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations (from `docs/architecture/source-tree.md`):**
- Edge Functions: `packages/supabase/functions/pipes/` and `packages/supabase/functions/actions/`
- Frontend Components: `apps/web/src/components/video/` for video player
- Frontend Pages: `apps/web/src/app/(dashboard)/answers/`
- Types: `packages/supabase/types/database.types.ts`

### Data Models

**Database Schema (from `docs/architecture.md` Section 6 - Core Tables):**
- `answer_evaluations` - Already exists from Story 7.2, add `video_url` column
- New table: Not needed, extend existing evaluations table

**TypeScript Interface:**
```typescript
interface AnswerEvaluation {
  id: UUID
  user_id: UUID
  submission_id: UUID
  score: number
  feedback_text: string
  video_url?: string  // NEW - for AC:8
  strengths: string[]
  improvements: string[]
  action_items: string[]
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function Pipe:** `answer_feedback_video_pipe`
- Location: `packages/supabase/functions/pipes/answer_feedback_video_pipe/index.ts`
- Method: POST
- Request body: `{ submission_id: string }`
- Response: `{ jobId: string, status: 'queued' }`

**Actions Used:**
- `generate_feedback_script_action.ts` - Converts evaluation JSON to narrative script
- `render_video_action.ts` - Calls VPS Video Orchestrator (from Story 0.8)

### Component Specifications

**Frontend Components:**
- `FeedbackVideoPlayer.tsx` - Video player for feedback videos
- Location: `apps/web/src/components/video/FeedbackVideoPlayer.tsx`

**Props Interface:**
```typescript
interface FeedbackVideoPlayerProps {
  submissionId: string
  videoUrl: string
  onComplete?: () => void
}
```

### Testing Standards

**Test File Location (from `docs/architecture/coding-standards.md#testing-standards`):**
- Unit Tests: `packages/supabase/functions/pipes/answer_feedback_video_pipe/index.test.ts`
- Test Framework: Deno Test (native to Deno runtime)

**Required Tests:**
1. Returns 401 without auth header
2. Returns 403 for Free users (entitlement check)
3. Returns 202 with jobId for valid Pro user request
4. Handles missing submission_id gracefully

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Update (AC: 8)**
  - [ ] 1.1 Add `video_url` column to `answer_evaluations` table via migration
  - [ ] 1.2 Create RLS policy for video_url updates
  - [ ] 1.3 Update TypeScript types in `database.types.ts`

- [ ] **Task 2: Edge Function Pipe Creation (AC: 1-2, 9)**
  - [ ] 2.1 Create `packages/supabase/functions/pipes/answer_feedback_video_pipe/index.ts`
  - [ ] 2.2 Apply `auth_filter` for authentication
  - [ ] 2.3 Apply `entitlement_check_filter` for Pro-only feature
  - [ ] 2.4 Fetch existing evaluation from DB by submission_id

- [ ] **Task 3: Script Generation Action (AC: 2-3)**
  - [ ] 3.1 Create `packages/supabase/functions/actions/generate_feedback_script_action.ts`
  - [ ] 3.2 Convert evaluation JSON to narrative script structure
  - [ ] 3.3 Script sections: Score summary, Strengths, Improvements, Model comparison, Action items
  - [ ] 3.4 Call A4F LLM (`provider-3/llama-4-scout`) for script polish

- [ ] **Task 4: Manim Visualizations (AC: 4, 6)**
  - [ ] 4.1 Generate structure diagram showing answer flow
  - [ ] 4.2 Create comparison visualization (user vs model answer)
  - [ ] 4.3 Add [DIAGRAM] markers in script for Manim scenes
  - [ ] 4.4 Cache reusable Manim scenes in `manim_scene_cache` table

- [ ] **Task 5: Video Assembly (AC: 6, 8)**
  - [ ] 5.1 Call VPS Video Orchestrator via `render_video_action`
  - [ ] 5.2 Store video URL in `answer_evaluations.video_url` after completion
  - [ ] 5.3 Save to Supabase Storage: `feedback-videos/{user_id}/answer_{submission_id}.mp4`

- [ ] **Task 6: Notification (AC: 10)**
  - [ ] 6.1 Send push notification when video generation completes
  - [ ] 6.2 Message: "Your answer feedback video is ready!"

- [ ] **Task 7: Frontend Integration (AC: 7, 9)**
  - [ ] 7.1 Create `FeedbackVideoPlayer.tsx` component
  - [ ] 7.2 Add to answers dashboard after evaluation
  - [ ] 7.3 Handle video not ready state (show loading)

- [ ] **Task 8: Unit Tests (All AC)**
  - [ ] 8.1 Write Deno tests for pipe authentication
  - [ ] 8.2 Write Deno tests for entitlement check
  - [ ] 8.3 Write Deno tests for valid request flow

- [ ] **Task 9: Integration Testing**
  - [ ] 9.1 End-to-end test: submit answer → evaluate → generate video → play

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Clarity Score:** 9/10

**Major Gaps Identified:** None

**Developer Perspective:** A developer can implement this story as written. All file paths, API specifications, data models, and testing requirements are clearly specified.

---

**Story Status:** Draft → **Ready for Review**
