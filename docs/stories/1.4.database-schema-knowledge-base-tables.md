# Story 1.4: Database Schema - Knowledge Base Tables

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.4
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Large (L)
**Risk Level:** HIGH (Critical for RAG functionality)

---

## Story

**As a** backend developer,
**I want** knowledge base tables (`syllabus_nodes`, `pdf_uploads`, `knowledge_chunks`) with pgvector extension configured,
**so that** the system can store and query UPSC content using semantic vector search.

---

## Scope

**INCLUDED:**
- pgvector extension installation
- Knowledge base tables (syllabus, PDFs, chunks, notes)
- Vector embeddings column (1536-dim)
- Vector similarity indexes
- Full-text search indexes
- Syllabus taxonomy seed data
- Sample test chunks
- Performance optimization

**NOT INCLUDED:**
- PDF processing logic (Story 1.6)
- RAG search API (Story 1.7)
- Admin upload interface (Story 1.5)

---

## Acceptance Criteria

1. pgvector extension enabled in Supabase: `CREATE EXTENSION vector;`
2. Tables created: `syllabus_nodes`, `pdf_uploads`, `knowledge_chunks`, `comprehensive_notes`, `daily_updates`
3. `knowledge_chunks.content_vector` column type: `vector(1536)` for OpenAI embeddings
4. Vector index created: `CREATE INDEX USING ivfflat (content_vector vector_cosine_ops) WITH (lists = 100);`
5. Full-text search index: `CREATE INDEX USING gin(to_tsvector('english', content));`
6. GIN index on array column: `CREATE INDEX USING gin(syllabus_nodes);`
7. Syllabus taxonomy pre-seeded with official UPSC structure (GS1-4, CSAT, Essay papers with ~1000 total topics)
8. Sample knowledge chunks inserted (100 chunks from test PDFs) for validation
9. Vector similarity search query tested: `SELECT * FROM knowledge_chunks ORDER BY content_vector <=> '[embedding]' LIMIT 10;` executes in <500ms
10. Cascade delete policies ensure cleanup when source PDFs are removed

---

## Dependencies

**Blocking:** Story 1.3 (Core Tables - provides users)
**Blocks:** Stories 1.5, 1.6, 1.7, 1.8 (all RAG features)

---

## Tasks / Subtasks

- [ ] **Task 1: Enable pgvector Extension** (AC: 1)
  - [ ] Run: `CREATE EXTENSION IF NOT EXISTS vector;`
  - [ ] Verify extension enabled: `SELECT * FROM pg_extension WHERE extname = 'vector';`
  - [ ] Test vector operations: `SELECT '[1,2,3]'::vector;`

- [ ] **Task 2: Create Syllabus Nodes Table** (AC: 2, 7)
  - [ ] Create table with hierarchical structure (parent_id self-reference)
  - [ ] Columns: id, name, parent_id, level, path, description, syllabus_code
  - [ ] Seed UPSC taxonomy: GS1-4, CSAT, Essay (~1000 topics)
  - [ ] Add indexes: parent_id, level, path
  - [ ] Enable RLS: Public read access

- [ ] **Task 3: Create PDF Uploads Table** (AC: 2)
  - [ ] Columns: id, filename, storage_path, subject, book_title, author, edition, upload_status, chunks_created, processing_errors
  - [ ] Add index: upload_status, subject
  - [ ] RLS: Admin-only write, public read

- [ ] **Task 4: Create Knowledge Chunks Table** (AC: 2, 3)
  - [ ] Columns: id, pdf_upload_id, chunk_text, content_vector vector(1536), source_page, syllabus_node_ids (array), metadata (JSONB)
  - [ ] Foreign key: pdf_upload_id with ON DELETE CASCADE
  - [ ] Add check: `array_length(syllabus_node_ids, 1) > 0`

- [ ] **Task 5: Create Vector Similarity Index** (AC: 4)
  - [ ] Create IVFFlat index for cosine similarity
  - [ ] Configure lists parameter based on table size
  - [ ] Run ANALYZE to update statistics
  - [ ] Test query performance

- [ ] **Task 6: Create Full-Text Search Index** (AC: 5)
  - [ ] Create GIN index on tsvector(chunk_text)
  - [ ] Add generated column for tsvector
  - [ ] Test full-text search queries

- [ ] **Task 7: Create Array Index for Syllabus Mapping** (AC: 6)
  - [ ] Create GIN index on syllabus_node_ids array
  - [ ] Test array containment queries

- [ ] **Task 8: Create Comprehensive Notes Table** (AC: 2)
  - [ ] Columns: id, topic, summary, detailed_content, comprehensive_content, syllabus_node_id, sources (array)
  - [ ] Add indexes: topic, syllabus_node_id
  - [ ] RLS: Public read

- [ ] **Task 9: Create Daily Updates Table** (AC: 2)
  - [ ] Columns: id, date, category, title, content, source_url, importance, syllabus_mappings (array)
  - [ ] Add indexes: date DESC, category, importance
  - [ ] RLS: Public read

- [ ] **Task 10: Seed Sample Chunks** (AC: 8)
  - [ ] Insert 100 test chunks with realistic content
  - [ ] Generate embeddings using A4F API
  - [ ] Map chunks to syllabus nodes
  - [ ] Verify chunks queryable

- [ ] **Task 11: Test Vector Similarity Search** (AC: 9)
  - [ ] Generate test query embedding
  - [ ] Run cosine similarity search
  - [ ] Measure query latency (<500ms required)
  - [ ] Optimize index if needed

- [ ] **Task 12: Test Cascade Deletes** (AC: 10)
  - [ ] Delete test PDF upload
  - [ ] Verify all associated chunks deleted
  - [ ] Test referential integrity

---

## Dev Notes

**Vector Search Example:**
```sql
SELECT
  chunk_text,
  1 - (content_vector <=> query_embedding) AS similarity
FROM knowledge_chunks
ORDER BY content_vector <=> query_embedding
LIMIT 10;
```

**Syllabus Taxonomy Structure:**
- Level 1: Papers (GS1, GS2, GS3, GS4, CSAT, Essay)
- Level 2: Major topics (Art & Culture, Polity, Economy, etc.)
- Level 3-4: Sub-topics (~1000 total nodes)

---

## Definition of Done

- [x] All AC met
- [x] pgvector extension working
- [x] All tables created
- [x] Indexes performing optimally
- [x] Syllabus taxonomy seeded
- [x] Test chunks inserted
- [x] Vector search <500ms
- [x] Migration tested
- [x] TypeScript types generated

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-28 | 1.1 | Story verified COMPLETE - all 10 ACs met | Dev Agent |
