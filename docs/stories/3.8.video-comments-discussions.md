# Story 3.8: Video Comments & Discussions

**Epic:** 3 - Video Generation Pipeline
**Story Number:** 3.8
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 4
**Estimated Effort:** Medium (M)
**Risk Level:** LOW

---

## Story

**As a** UPSC aspirant,
**I want** to comment on daily CA videos and discuss topics with other aspirants,
**so that** I can clarify doubts and share insights.

---

## Acceptance Criteria

1. Comments section below video player
2. Add comment: text input with submit button
3. Comments displayed: user avatar, name, timestamp, comment text
4. Reply functionality: nested replies (1 level deep)
5. Like/upvote comments
6. Sort comments: Newest, Oldest, Most Liked
7. Moderation: admin can delete inappropriate comments
8. Real-time updates: new comments appear without page refresh
9. Notifications: user notified when reply received
10. Mobile-optimized comment interface

---

## Dependencies

**Blocking:** Story 3.5
**Blocks:** None

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Frontend Components: `apps/web/src/components/video/CommentsSection.tsx`
- Database Tables: `video_comments`, `comment_likes`

### Data Models

**Database Schema:**
```typescript
interface VideoComment {
  id: UUID
  video_id: UUID
  user_id: UUID NOT NULL
  parent_id: UUID  -- for replies (1 level deep)
  comment_text: TEXT NOT NULL
  created_at: TIMESTAMPTZ
  updated_at: TIMESTAMPTZ
  is_deleted: BOOLEAN DEFAULT false
}

interface CommentLike {
  id: UUID
  comment_id: UUID NOT NULL
  user_id: UUID NOT NULL
  created_at: TIMESTAMPTZ
  UNIQUE(user_id, comment_id)
}
```

### API Specifications

**Comments Pipe:**
- Location: `packages/supabase/functions/pipes/video_comments_pipe/index.ts`
- Methods: GET (list), POST (create), DELETE (moderate)

### Testing Standards

**Test File Location:**
- Unit Tests: `apps/web/src/components/video/**/*.test.tsx`

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema (AC: 1, 27)**
  - [ ] 1.1 Create migration: `008_video_comments.sql`
  - [ ] 1.2 Create `video_comments` and `comment_likes` tables
  - [ ] 1.3 Add indexes on video_id, parent_id, created_at
  - [ ] 1.4 Update TypeScript types

- [ ] **Task 2: Comments Section UI (AC: 1, 32)**
  - [ ] 2.1 Create `CommentsSection.tsx` component
  - [ ] 2.2 Add below video player
  - [ ] 2.3 Mobile-responsive layout

- [ ] **Task 3: Add Comment (AC: 2, 4)**
  - [ ] 3.1 Create `CommentInput.tsx` component
  - [ ] 3.2 Text area with submit button
  - [ ] 3.3 Display: user avatar, name, timestamp, comment
  - [ ] 3.4 Real-time updates via Supabase subscriptions

- [ ] **Task 4: Replies (AC: 4)**
  - [ ] 4.1 "Reply" button on each comment
  - [ ] 4.2 Create nested reply UI
  - [ ] 4.3 Limit to 1 level deep
  - [ ] 4.4 Indent replies visually

- [ ] **Task 5: Likes/Upvotes (AC: 5)**
  - [ ] 5.1 Create `CommentLikeButton.tsx` component
  - [ ] 5.2 Toggle like/unlike
  - [ ] 5.3 Display like count
  - [ ] 5.4 Prevent duplicate likes

- [ ] **Task 6: Sorting (AC: 6)**
  - [ ] 6.1 Create `CommentSortDropdown.tsx`
  - [ ] 6.2 Options: Newest, Oldest, Most Liked
  - [ ] 6.3 Re-sort on selection change

- [ ] **Task 7: Moderation (AC: 7)**
  - [ ] 7.1 Admin can delete comments
  - [ ] 7.2 Soft delete (is_deleted = true)
  - [ ] 7.3 Admin UI in admin dashboard
  - [ ] 7.4 Moderation history logging

- [ ] **Task 8: Notifications (AC: 9)**
  - [ ] 8.1 Create `comment_notifications` table
  - [ ] 8.2 Notify when reply received
  - [ ] 8.3 In-app notification center
  - [ ] 8.4 Email notifications (optional)

- [ ] **Task 9: Unit Tests**
  - [ ] 9.1 Test comment creation
  - [ ] 9.2 Test reply nesting
  - [ ] 9.3 Test like/unlike
  - [ ] 9.4 Test sorting

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
