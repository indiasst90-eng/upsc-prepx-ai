# Story 0.12: Git Repository & CI/CD Pipeline Setup

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.12
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** a Git repository with automated CI/CD pipeline,
**so that** code changes are tested and validated automatically.

---

## Acceptance Criteria

1. GitHub repository created: `upsc-ai-mentor` repo initialized
2. Branch protection rules: `main` requires PR approval, passing CI
3. `.gitignore` configured: exclude `node_modules`, `.env.local`, `dist`, etc.
4. GitHub Actions workflow created: `.github/workflows/ci.yml`
5. CI pipeline stages: lint → type-check → test → build
6. Lint stage: run ESLint on all packages
7. Type-check stage: run `tsc --noEmit` in all packages
8. Test stage: run Jest/Vitest unit tests with coverage report
9. Build stage: build Next.js apps with `turbo build`
10. Status badges added: CI status badge in README.md

---

## Tasks / Subtasks

- [ ] **Task 1: Initialize Git Repository** (AC: 1)
  - [ ] Navigate to project root
  - [ ] Run: `git init`
  - [ ] Create GitHub repo via CLI:
    ```bash
    gh repo create upsc-ai-mentor --private --source=. --remote=origin
    ```
  - [ ] Add remote:
    ```bash
    git remote add origin https://github.com/YOUR_ORG/upsc-ai-mentor.git
    ```
  - [ ] Initial commit:
    ```bash
    git add .
    git commit -m "Initial commit - Turborepo monorepo setup"
    git push -u origin main
    ```

- [ ] **Task 2: Configure Branch Protection** (AC: 2)
  - [ ] Navigate to GitHub repo settings → Branches
  - [ ] Add branch protection rule for `main`:
    - Require pull request reviews (1 approval)
    - Require status checks to pass (CI pipeline)
    - Require branches to be up to date
    - Do not allow force pushes
  - [ ] Document branch strategy (main, develop, feature/*)

- [ ] **Task 3: Configure .gitignore** (AC: 3)
  - [ ] Create comprehensive `.gitignore`:
    ```
    # Dependencies
    node_modules/
    .pnpm-store/

    # Environment
    .env
    .env.local
    .env*.local

    # Build outputs
    .next/
    dist/
    build/
    out/

    # Testing
    coverage/
    .nyc_output/

    # IDE
    .vscode/
    .idea/
    *.swp
    *.swo

    # OS
    .DS_Store
    Thumbs.db

    # Logs
    *.log
    npm-debug.log*

    # Turbo
    .turbo/
    ```
  - [ ] Verify sensitive files excluded
  - [ ] Test: `git status` should not show `.env.local`

- [ ] **Task 4: Create CI/CD Workflow File** (AC: 4)
  - [ ] Create `.github/workflows/ci.yml`:
    ```yaml
    name: CI Pipeline

    on:
      push:
        branches: [main, develop]
      pull_request:
        branches: [main, develop]

    jobs:
      ci:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4

          - name: Setup Node.js
            uses: actions/setup-node@v4
            with:
              node-version: 20

          - name: Setup pnpm
            uses: pnpm/action-setup@v2
            with:
              version: 8

          - name: Install dependencies
            run: pnpm install

          - name: Lint
            run: pnpm lint

          - name: Type check
            run: pnpm type-check

          - name: Test
            run: pnpm test

          - name: Build
            run: pnpm build
    ```
  - [ ] Commit workflow file

- [ ] **Task 5: Configure Lint Stage** (AC: 6)
  - [ ] Add lint script to root `package.json`:
    ```json
    {
      "scripts": {
        "lint": "turbo run lint"
      }
    }
    ```
  - [ ] Add lint script to each app/package
  - [ ] Test locally: `pnpm lint`
  - [ ] Fix any lint errors
  - [ ] Commit fixes

- [ ] **Task 6: Configure Type-Check Stage** (AC: 7)
  - [ ] Add type-check script to root:
    ```json
    {
      "scripts": {
        "type-check": "turbo run type-check"
      }
    }
    ```
  - [ ] Add to each package:
    ```json
    {
      "scripts": {
        "type-check": "tsc --noEmit"
      }
    }
    ```
  - [ ] Test: `pnpm type-check`
  - [ ] Fix type errors

- [ ] **Task 7: Configure Test Stage** (AC: 8)
  - [ ] Install Vitest in packages:
    ```bash
    pnpm add -D vitest @vitest/ui
    ```
  - [ ] Create `vitest.config.ts` in each package
  - [ ] Add test script:
    ```json
    {
      "scripts": {
        "test": "vitest run --coverage"
      }
    }
    ```
  - [ ] Create sample test file (placeholder)
  - [ ] Run: `pnpm test`

- [ ] **Task 8: Configure Build Stage** (AC: 9)
  - [ ] Verify build scripts in Next.js apps
  - [ ] Update turbo.json:
    ```json
    {
      "pipeline": {
        "build": {
          "dependsOn": ["^build"],
          "outputs": [".next/**", "dist/**"]
        },
        "lint": {},
        "type-check": {},
        "test": {}
      }
    }
    ```
  - [ ] Test: `pnpm build`
  - [ ] Verify apps build successfully

- [ ] **Task 9: Add CI Status Badge** (AC: 10)
  - [ ] Get badge URL from GitHub Actions
  - [ ] Add to README.md:
    ```markdown
    # UPSC AI Mentor

    ![CI](https://github.com/YOUR_ORG/upsc-ai-mentor/workflows/CI%20Pipeline/badge.svg)

    ## Setup...
    ```
  - [ ] Verify badge shows status

- [ ] **Task 10: Trigger CI Pipeline** (All ACs)
  - [ ] Push changes to GitHub
  - [ ] Navigate to Actions tab
  - [ ] Verify CI pipeline runs automatically
  - [ ] Check all stages pass (lint → type-check → test → build)
  - [ ] Fix any failures
  - [ ] Document CI setup in README

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Create `docs/ci-cd-guide.md`
  - [ ] Document workflow stages
  - [ ] Add troubleshooting guide
  - [ ] Commit changes

---

## Dev Notes

**Purpose:** Sets up Git version control and automated CI/CD pipeline to ensure code quality and prevent regressions.

**Risk:** MEDIUM - Delays quality enforcement but doesn't block development

**Dependencies:** Story 0.11 ✅ (project structure needed)

**Blocks:** None (quality gate, not blocker)

---

### Architecture Context

[Source: docs/architecture.md#3]

**CI/CD Tool:** GitHub Actions
**Testing:** Vitest (frontend), Deno Test (Edge Functions)
**Build:** Turborepo with caching

---

### Testing

**Manual Validation:**
- [ ] CI pipeline runs on push
- [ ] All stages pass
- [ ] PR checks enforce quality

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft | Bob (SM Agent) |

---

**Story Status:** Draft
**Risk Level:** MEDIUM
**Estimated Effort:** 4-6 hours
**Dependencies:** Story 0.11 ✅
**Blocks:** None (quality gate)
