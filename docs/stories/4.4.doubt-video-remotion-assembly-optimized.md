# Story 4.4: Doubt Video - Revideo Assembly (Optimized)

**Epic:** 4 - On-Demand Video Learning
**Story Number:** 4.4
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 5
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** video producer,
**I want** Revideo to assemble doubt videos within 30-40 seconds,
**so that** users receive video explanations in under 60 seconds total.

---

## Acceptance Criteria

1. TTS audio generated: A4F TTS with user's voice, <10 seconds
2. Audio timing: map script segments to timestamps
3. Revideo composition: DoubtVideoTemplate with props (via Revideo Renderer at http://89.117.60.144:5001)
4. Template variations: Concise, Detailed, Example-Rich
5. Captions: auto-generated SRT, burned into video
6. Branding: logo watermark, end card (3s)
7. VPS Video Orchestrator: priority queue (higher than daily CA)
8. Render time: <30 seconds (P95)
9. Video uploaded: videos/doubts/{job_id}.mp4
10. Status = completed, notification sent

---

## Dependencies

**Blocking:** Stories 4.3, 0.6 (Revideo)
**Blocks:** Story 4.5

---

## Definition of Done

- [ ] All AC met
- [ ] Assembly <30s
- [ ] All templates working
- [ ] Priority queue functional
- [ ] Video quality acceptable

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/actions/assemble_doubt_video_action.ts`
- VPS Service: Revideo Renderer at `http://89.117.60.144:5001`
- Video Orchestrator: `http://89.117.60.144:8103`

### Data Models

**Database Schema:**
```typescript
interface DoubtVideoAssembly {
  id: UUID
  render_id: UUID NOT NULL
  tts_audio_url: TEXT
  manim_clips: TEXT[]  -- Array of clip URLs
  captions_srt: TEXT
  final_video_url: TEXT
  duration_seconds: INTEGER
  render_time_ms: INTEGER
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Action:** `assemble_doubt_video_action`
- Location: `packages/supabase/functions/actions/assemble_doubt_video_action.ts`
- Input: `{ render_id, script, style }`
- Output: `{ video_url, duration, render_time }`

**Revideo Template:** `DoubtVideoTemplate` with style variants

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/actions/assemble_doubt_video_action.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: TTS Generation (AC: 1)**
  - [ ] 1.1 Create `generateDoubtTTS()` function
  - [ ] 1.2 Call A4F TTS API (provider-5/tts-1)
  - [ ] 1.3 Use user's preferred voice from profile
  - [ ] 1.4 Target: <10 seconds
  - [ ] 1.5 Return audio URL

- [ ] **Task 2: Audio Timing (AC: 2)**
  - [ ] 2.1 Create `mapTimestamps()` function
  - [ ] 2.2 Parse script into segments
  - [ ] 2.3 Map each segment to timestamp range
  - [ ] 2.4 Return timing map for Revideo

- [ ] **Task 3: Revideo Assembly (AC: 3, 6)**
  - [ ] 3.1 Create `assembleWithRevideo()` function
  - [ ] 3.2 Call Video Orchestrator at `http://89.117.60.144:8103/render`
  - [ ] 3.3 Pass: script, TTS URL, Manim clips, template
  - [ ] 3.4 Template: DoubtVideoTemplate with style props:
    - Concise: minimal effects
    - Detailed: full animations
    - Example-Rich: case study overlays

- [ ] **Task 4: Captions (AC: 5)**
  - [ ] 4.1 Create `generateCaptions()` function
  - [ ] 4.2 Generate SRT format from script + timestamps
  - [ ] 4.3 Burn captions into video
  - [ ] 4.4 Style: white text, black outline

- [ ] **Task 5: Branding (AC: 6)**
  - [ ] 5.1 Add logo watermark (bottom-right)
  - [ ] 5.2 Create end card template (3 seconds)
  - [ ] 5.3 End card: "Created on UPSC PrepX-AI"

- [ ] **Task 6: Priority Queue (AC: 7)**
  - [ ] 6.1 Call Video Orchestrator with priority: high
  - [ ] 6.2 Higher priority than daily CA
  - [ ] 6.3 Target: <30 seconds total (P95)

- [ ] **Task 7: Upload & Complete (AC: 8, 9)**
  - [ ] 7.1 Upload video to Supabase Storage
  - [ ] 7.2 Path: `videos/doubts/{job_id}.mp4`
  - [ ] 7.3 Update doubt_video_renders: status = completed, video_url
  - [ ] 7.4 Trigger notification

- [ ] **Task 8: Unit Tests**
  - [ ] 8.1 Test TTS generation
  - [ ] 8.2 Test timestamp mapping
  - [ ] 8.3 Test template variations
  - [ ] 8.4 Test render time <30s

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
