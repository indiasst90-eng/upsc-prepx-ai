# Story 4.3: Doubt Video - Manim Scene Generation (Optimized)

**Epic:** 4 - On-Demand Video Learning
**Story Number:** 4.3
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 5
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** video producer,
**I want** Manim to generate diagrams for doubts within 15-20 seconds,
**so that** total video generation stays under 60 seconds for user satisfaction.

---

## Acceptance Criteria

1. Manim scene specs: max 2 scenes per doubt video
2. Scene types prioritized: simple diagrams, text animations, timeline
3. Cache-first strategy: check manim_scene_cache (80% similarity match)
4. If cache hit, reuse; if miss, render new
5. VPS Manim Renderer: pre-warmed workers, priority queue for doubts
6. Render time: <15 seconds per scene (P95)
7. Parallel rendering: both scenes simultaneously
8. Fallback: if >20s, skip Manim, use text-only
9. Clips uploaded: videos/manim-scenes/doubts/{job_id}/
10. Status updated: pending_remotion

---

## Dependencies

**Blocking:** Stories 4.2, 0.5 (Manim)
**Blocks:** Story 4.4

---

## Definition of Done

- [ ] All AC met
- [ ] Scene generation <15s
- [ ] Cache working
- [ ] Parallel rendering working
- [ ] Fallback functional

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/actions/generate_doubt_manim_action.ts`
- Database Tables: `manim_scene_cache`, `doubt_video_renders`
- VPS Service: Manim Renderer at `http://89.117.60.144:5000`

### Data Models

**Database Schema:**
```typescript
interface ManimSceneCache {
  id: UUID
  scene_hash: TEXT UNIQUE
  scene_type: TEXT  -- 'diagram', 'text_animation', 'timeline'
  topic_keywords: TEXT[]
  input_spec: JSONB
  output_url: TEXT
  video_url: TEXT
  similarity_threshold: DECIMAL DEFAULT 0.80
  created_at: TIMESTAMPTZ
  used_count: INTEGER DEFAULT 0
}
```

### API Specifications

**Action:** `generate_doubt_manim_action`
- Location: `packages/supabase/functions/actions/generate_doubt_manim_action.ts`
- Input: `{ doubt_text, script, job_id }`
- Output: `{ scenes: ManimSceneResult[], render_time_ms }`

**VPS Manim Renderer:**
- Priority: High (for doubts)
- Target: <15 seconds per scene

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/actions/generate_doubt_manim_action.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Scene Type Detection (AC: 1, 2)**
  - [ ] 1.1 Create `detectSceneType()` function
  - [ ] 1.2 Analyze script for visualizable content
  - [ ] 1.3 Prioritize: simple diagrams, text animations, timeline
  - [ ] 1.4 Limit to max 2 scenes per video

- [ ] **Task 2: Cache Strategy (AC: 3, 4)**
  - [ ] 2.1 Create `checkSceneCache()` function
  - [ ] 2.2 Generate scene_hash from topic keywords
  - [ ] 2.3 Query manim_scene_cache for 80% similarity
  - [ ] 2.4 If cache hit, reuse output_url
  - [ ] 2.5 If cache miss, render new

- [ ] **Task 3: Scene Spec Generation (AC: 1)**
  - [ ] 3.1 Create `generateSceneSpec()` function
  - [ ] 3.2 Convert script to Manim JSON schema
  - [ ] 3.3 Include: title, nodes, edges, animations
  - [ ] 3.4 Return optimized spec for fast rendering

- [ ] **Task 4: VPS Manim Call (AC: 5, 7)**
  - [ ] 4.1 Call VPS Manim Renderer with priority: high
  - [ ] 4.2 POST scene specs to `http://89.117.60.144:5000/render`
  - [ ] 4.3 Parallel rendering for 2 scenes
  - [ ] 4.4 Track render time per scene

- [ ] **Task 5: Performance Target (AC: 6)**
  - [ ] 5.1 Target: <15 seconds per scene (P95)
  - [ ] 5.2 Pre-warmed workers via VPS config
  - [ ] 5.3 Priority queue for doubt videos
  - [ ] 5.4 Log performance metrics

- [ ] **Task 6: Fallback (AC: 8)**
  - [ ] 6.1 Monitor render time
  - [ ] 6.2 If >20s, cancel and skip Manim
  - [ ] 6.3 Continue with text-only video
  - [ ] 6.4 Log fallback event

- [ ] **Task 7: Upload & Update (AC: 9)**
  - [ ] 7.1 Upload clips to Supabase Storage
  - [ ] 7.2 Path: `videos/manim-scenes/doubts/{job_id}/`
  - [ ] 7.3 Update doubt_video_renders status = pending_remotion
  - [ ] 7.4 Cache new scenes for reuse

- [ ] **Task 8: Unit Tests**
  - [ ] 8.1 Test cache hit/miss logic
  - [ ] 8.2 Test scene spec generation
  - [ ] 8.3 Test fallback behavior
  - [ ] 8.4 Test render time tracking

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
