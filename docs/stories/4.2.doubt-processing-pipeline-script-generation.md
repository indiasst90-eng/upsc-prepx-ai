# Story 4.2: Doubt Processing Pipeline - Script Generation

**Epic:** 4 - On-Demand Video Learning
**Story Number:** 4.2
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 5
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** system,
**I want** to analyze doubt input using RAG retrieval and generate a structured video script,
**so that** video explanations are accurate, grounded in UPSC sources, and appropriately detailed.

---

## Acceptance Criteria

1. Edge Function: doubt_video_converter_pipe.ts at POST /api/doubts/create
2. Request payload: { doubt_text, style, length, voice, user_id }
3. Content safety filter: check for NSFW/harmful content, block if flagged
4. RAG retrieval: query knowledge_chunks, fetch top 5 chunks (confidence >0.70)
5. If confidence <0.70, return warning modal
6. Script generation: LLM synthesizes answer (intro → explanation → example → conclusion)
7. Script length: 150 words (60s), 300 words (120s), 450 words (180s)
8. Style variations: Concise (bullets), Detailed (full), Example-Rich (case studies)
9. Script saved: content_type = doubt_video, status = pending_manim
10. Job ID returned with estimated_time

---

## Dependencies

**Blocking:** Stories 4.1, 1.7 (RAG)
**Blocks:** Story 4.3

---

## Definition of Done

- [ ] All AC met
- [ ] RAG integration working
- [ ] Script generation functional
- [ ] All 3 styles working
- [ ] All 3 lengths working
- [ ] Content safety working

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/pipes/doubt_video_converter_pipe/`
- Database Tables: `doubt_submissions`, `video_renders`

### Data Models

**Database Schema:**
```typescript
interface DoubtVideoRender {
  id: UUID
  submission_id: UUID NOT NULL
  user_id: UUID NOT NULL
  script_text: TEXT NOT NULL
  script_style: TEXT  -- 'concise', 'detailed', 'example_rich'
  video_length_seconds: INTEGER
  rag_sources: JSONB  -- [{ chunk_id, source, confidence }]
  status: TEXT  -- 'pending_manim', 'queued_render', 'completed', 'failed'
  confidence_score: DECIMAL
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `doubt_video_converter_pipe`
- Location: `packages/supabase/functions/pipes/doubt_video_converter_pipe/index.ts`
- Method: POST
- Request: `{ submission_id }`
- Response: `{ job_id, estimated_time_seconds }`

**Content Safety:** Use content_safety_filter from Story 0.7

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/doubt_video_converter_pipe/index.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Pipe Creation (AC: 1, 2)**
  - [ ] 1.1 Create `doubt_video_converter_pipe/index.ts`
  - [ ] 1.2 Apply auth_filter
  - [ ] 1.3 Apply entitlement_check_filter
  - [ ] 1.4 Fetch submission from database

- [ ] **Task 2: Content Safety (AC: 3)**
  - [ ] 2.1 Apply content_safety_filter
  - [ ] 2.2 Check for NSFW/harmful content
  - [ ] 2.3 Block and log if flagged
  - [ ] 2.4 Return error for flagged content

- [ ] **Task 3: RAG Retrieval (AC: 4, 5)**
  - [ ] 3.1 Call rag_search_pipe with doubt_text as query
  - [ ] 3.2 Fetch top 5 knowledge chunks
  - [ ] 3.3 Filter: confidence > 0.70
  - [ ] 3.4 If confidence < 0.70, return warning modal

- [ ] **Task 4: Script Generation (AC: 6, 8)**
  - [ ] 4.1 Create `generateDoubtScript()` function
  - [ ] 4.2 LLM synthesis: intro → explanation → example → conclusion
  - [ ] 4.3 Word count based on length:
    - 60s: 150 words
    - 120s: 300 words
    - 180s: 450 words
  - [ ] 4.4 Style variations:
    - Concise: bullets only
    - Detailed: full sentences
    - Example-Rich: case studies

- [ ] **Task 5: Script Saving (AC: 9)**
  - [ ] 5.1 Create `doubt_video_renders` record
  - [ ] 5.2 Set status = pending_manim
  - [ ] 5.3 Store rag_sources in JSONB
  - [ ] 5.4 Calculate confidence_score

- [ ] **Task 6: Response (AC: 10)**
  - [ ] 6.1 Return job_id
  - [ ] 6.2 Estimate processing time
  - [ ] 6.3 Trigger Story 4.3 via queue

- [ ] **Task 7: Unit Tests**
  - [ ] 7.1 Deno test: content safety check
  - [ ] 7.2 Deno test: RAG retrieval
  - [ ] 7.3 Deno test: script generation
  - [ ] 7.4 Deno test: confidence warning

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft → **Ready for Review**
