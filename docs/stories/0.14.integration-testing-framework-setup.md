# Story 0.14: Integration Testing Framework Setup

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.14
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** QA engineer,
**I want** an integration testing framework with VPS service mocks,
**so that** I can test features end-to-end without manual service calls.

---

## Acceptance Criteria

1. Playwright installed and configured: `npx playwright install`
2. Test environment setup: Supabase test database created
3. Service mocks created: Mock servers for all VPS services (8101-8104, 5000, 5001)
4. Mock data seeded: Test users, syllabus nodes, sample PDFs in test database
5. Test utilities created: Helper functions for auth, database reset, API calls
6. Example E2E test: User signup → login → perform search → logout
7. CI integration: Integration tests run in GitHub Actions after unit tests
8. Test isolation: Each test resets database to clean state
9. Debugging support: Playwright traces and screenshots on failure
10. Documentation: `docs/testing-guide.md` explains how to write integration tests

---

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Playwright** (AC: 1, 9)
  - [ ] Install Playwright: `pnpm add -D @playwright/test`
  - [ ] Run Playwright setup: `npx playwright install`
  - [ ] Install browser dependencies: chromium, firefox, webkit
  - [ ] Create `playwright.config.ts` in project root
  - [ ] Configure test directory: `tests/e2e/`
  - [ ] Enable traces and screenshots on failure
  - [ ] Set base URL to `http://localhost:3000` (Next.js dev server)
  - [ ] Configure parallel execution and retries

- [ ] **Task 2: Create Supabase Test Database** (AC: 2, 8)
  - [ ] Create test database configuration in Supabase
  - [ ] Copy production schema to test database
  - [ ] Create database reset script: `scripts/reset-test-db.ts`
  - [ ] Implement `beforeEach` hook to reset database
  - [ ] Test database reset functionality
  - [ ] Document test database setup in testing guide

- [ ] **Task 3: Create VPS Service Mock Servers** (AC: 3)
  - [ ] Install MSW (Mock Service Worker): `pnpm add -D msw`
  - [ ] Create mock server configuration: `tests/mocks/handlers.ts`
  - [ ] Mock Manim Renderer (port 5000): return fake video scene
  - [ ] Mock Revideo Renderer (port 5001): return fake video composition
  - [ ] Mock Document Retriever (port 8101): return fake RAG results
  - [ ] Mock DuckDuckGo Search (port 8102): return fake search results
  - [ ] Mock Video Orchestrator (port 8103): return fake job ID
  - [ ] Mock Notes Generator (port 8104): return fake notes
  - [ ] Test each mock server responds correctly
  - [ ] Document mock server architecture

- [ ] **Task 4: Seed Test Database with Mock Data** (AC: 4)
  - [ ] Create seed script: `scripts/seed-test-data.ts`
  - [ ] Seed test users (3 users: free, trial, paid)
  - [ ] Seed syllabus nodes (GS1-4, CSAT, Essay topics)
  - [ ] Seed sample PDF uploads (2-3 test PDFs)
  - [ ] Seed knowledge chunks (vector embeddings for RAG)
  - [ ] Seed comprehensive notes (5-10 sample notes)
  - [ ] Seed video renders (completed, processing, failed)
  - [ ] Run seed script in `beforeAll` hook
  - [ ] Verify seeded data accessible in tests

- [ ] **Task 5: Create Test Utility Functions** (AC: 5)
  - [ ] Create `tests/utils/auth.ts`: login(), logout(), signup()
  - [ ] Create `tests/utils/database.ts`: resetDatabase(), seedData()
  - [ ] Create `tests/utils/api.ts`: callPipe(), mockVpsService()
  - [ ] Create `tests/utils/assertions.ts`: custom Playwright matchers
  - [ ] Create `tests/utils/fixtures.ts`: Playwright fixtures for auth
  - [ ] Test all utility functions independently
  - [ ] Document utility functions in testing guide

- [ ] **Task 6: Write Example E2E Test** (AC: 6)
  - [ ] Create `tests/e2e/user-auth-flow.spec.ts`
  - [ ] Test 1: User signup with email/password
  - [ ] Test 2: User login with valid credentials
  - [ ] Test 3: User performs RAG search
  - [ ] Test 4: User views search results
  - [ ] Test 5: User logs out
  - [ ] Run test: `pnpm playwright test`
  - [ ] Verify test passes consistently
  - [ ] Review Playwright trace on failure

- [ ] **Task 7: Write Additional E2E Tests** (AC: 6)
  - [ ] Create `tests/e2e/doubt-video-converter.spec.ts`
  - [ ] Test video generation workflow (mocked)
  - [ ] Create `tests/e2e/notes-generation.spec.ts`
  - [ ] Test notes generation workflow (mocked)
  - [ ] Create `tests/e2e/subscription-flow.spec.ts`
  - [ ] Test trial signup → upgrade → payment (mocked)
  - [ ] Verify all tests pass in parallel

- [ ] **Task 8: Configure GitHub Actions CI** (AC: 7)
  - [ ] Update `.github/workflows/ci.yml`
  - [ ] Add Playwright test job after unit tests
  - [ ] Install Playwright browsers in CI
  - [ ] Set up test database for CI environment
  - [ ] Run integration tests: `pnpm playwright test`
  - [ ] Upload Playwright report artifacts on failure
  - [ ] Configure test caching for faster CI runs
  - [ ] Test CI pipeline end-to-end

- [ ] **Task 9: Implement Test Isolation** (AC: 8)
  - [ ] Create global setup: `tests/global-setup.ts`
  - [ ] Create global teardown: `tests/global-teardown.ts`
  - [ ] Implement `beforeEach` hook for database reset
  - [ ] Clear cookies/localStorage between tests
  - [ ] Isolate test user sessions (parallel test safety)
  - [ ] Verify tests can run in any order
  - [ ] Verify tests can run in parallel without conflicts

- [ ] **Task 10: Configure Debugging Support** (AC: 9)
  - [ ] Enable Playwright traces in config: `trace: 'on-first-retry'`
  - [ ] Enable screenshots on failure: `screenshot: 'only-on-failure'`
  - [ ] Enable video recording: `video: 'retain-on-failure'`
  - [ ] Test debugging: run failing test, review trace
  - [ ] Document how to use Playwright Inspector: `pnpm playwright test --debug`
  - [ ] Document how to view traces: `pnpm playwright show-report`

- [ ] **Task 11: Create Testing Documentation** (AC: 10)
  - [ ] Create `docs/testing-guide.md`
  - [ ] Document testing philosophy (unit, integration, E2E)
  - [ ] Document how to run tests locally
  - [ ] Document how to write new E2E tests
  - [ ] Document test utilities and fixtures
  - [ ] Document mock server usage
  - [ ] Document debugging techniques
  - [ ] Document CI integration
  - [ ] Add troubleshooting section

- [ ] **Task 12: Testing Strategy Documentation** (AC: 10)
  - [ ] Document testing pyramid: 70% unit, 20% integration, 10% E2E
  - [ ] Document when to write unit vs integration vs E2E tests
  - [ ] Document test naming conventions
  - [ ] Document test organization (by feature vs by type)
  - [ ] Document test coverage goals (80% for critical paths)
  - [ ] Document performance test strategy (future)
  - [ ] Document visual regression testing (future, if needed)

---

## Dev Notes

### Relevant Architecture Information

**Tech Stack Reference:** [Source: docs/architecture/tech-stack.md]

- **E2E Testing:** Playwright 1.40+ (multi-browser, auto-wait, video recording)
- **Frontend Testing:** Vitest + React Testing Library (unit tests)
- **Backend Testing:** Deno Test (Edge Functions)
- **Mocking:** MSW (Mock Service Worker) for API mocking

**Coding Standards Reference:** [Source: docs/architecture/coding-standards.md#testing-standards]

- Test file naming: `{ComponentName}.test.ts(x)` for unit tests
- E2E test naming: `{feature-name}.spec.ts` for Playwright tests
- Test location: `tests/e2e/` for integration tests
- Mock location: `tests/mocks/` for MSW handlers

**Source Tree Reference:** [Source: docs/architecture/source-tree.md]

```
upsc-ai-mentor/
├── tests/
│   ├── e2e/                     # Playwright E2E tests
│   │   ├── user-auth-flow.spec.ts
│   │   ├── doubt-video-converter.spec.ts
│   │   ├── notes-generation.spec.ts
│   │   └── subscription-flow.spec.ts
│   ├── mocks/                   # MSW mock handlers
│   │   ├── handlers.ts          # API mock handlers
│   │   └── server.ts            # Mock server setup
│   ├── utils/                   # Test utilities
│   │   ├── auth.ts              # Auth helpers
│   │   ├── database.ts          # DB reset/seed
│   │   ├── api.ts               # API helpers
│   │   ├── assertions.ts        # Custom matchers
│   │   └── fixtures.ts          # Playwright fixtures
│   ├── global-setup.ts          # Run before all tests
│   └── global-teardown.ts       # Run after all tests
├── scripts/
│   ├── reset-test-db.ts         # Database reset script
│   └── seed-test-data.ts        # Test data seeding
├── playwright.config.ts         # Playwright configuration
└── docs/
    └── testing-guide.md         # Testing documentation
```

### Playwright Configuration Example

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',

  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],

  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

### Mock Service Worker (MSW) Example

```typescript
// tests/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  // Mock Manim Renderer
  http.post('http://89.117.60.144:5000/render', () => {
    return HttpResponse.json({
      sceneId: 'mock-scene-123',
      status: 'completed',
      outputUrl: '/mock-videos/scene-123.mp4',
    })
  }),

  // Mock Document Retriever (RAG)
  http.post('http://89.117.60.144:8101/retrieve', () => {
    return HttpResponse.json({
      chunks: [
        { text: 'Mock RAG result 1', confidence: 0.95, source: 'test.pdf' },
        { text: 'Mock RAG result 2', confidence: 0.87, source: 'test2.pdf' },
      ],
    })
  }),

  // Mock Video Orchestrator
  http.post('http://89.117.60.144:8103/render', () => {
    return HttpResponse.json({
      jobId: 'mock-job-456',
      status: 'queued',
    })
  }),

  // Add more mock handlers for other VPS services...
]
```

### Test Utility Functions Example

```typescript
// tests/utils/auth.ts
import { Page } from '@playwright/test'

export async function login(page: Page, email: string, password: string) {
  await page.goto('/login')
  await page.fill('[name="email"]', email)
  await page.fill('[name="password"]', password)
  await page.click('button[type="submit"]')
  await page.waitForURL('/dashboard')
}

export async function logout(page: Page) {
  await page.click('[data-testid="user-menu"]')
  await page.click('[data-testid="logout-button"]')
  await page.waitForURL('/login')
}

export async function signup(page: Page, email: string, password: string, name: string) {
  await page.goto('/signup')
  await page.fill('[name="name"]', name)
  await page.fill('[name="email"]', email)
  await page.fill('[name="password"]', password)
  await page.click('button[type="submit"]')
  await page.waitForURL('/dashboard')
}
```

### Database Reset/Seed Example

```typescript
// scripts/reset-test-db.ts
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.TEST_SUPABASE_URL!,
  process.env.TEST_SUPABASE_SERVICE_ROLE_KEY!
)

export async function resetTestDatabase() {
  // Delete all data from tables (in reverse dependency order)
  await supabase.from('video_renders').delete().neq('id', '00000000-0000-0000-0000-000000000000')
  await supabase.from('knowledge_chunks').delete().neq('id', '00000000-0000-0000-0000-000000000000')
  await supabase.from('comprehensive_notes').delete().neq('id', '00000000-0000-0000-0000-000000000000')
  await supabase.from('user_profiles').delete().neq('id', '00000000-0000-0000-0000-000000000000')
  await supabase.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000')
  // ... reset other tables
}

export async function seedTestData() {
  // Create test users
  const { data: testUsers } = await supabase.auth.admin.createUser({
    email: 'test-free@example.com',
    password: 'test-password',
    email_confirm: true,
  })

  // Seed syllabus nodes
  await supabase.from('syllabus_nodes').insert([
    { id: 'gs1', name: 'General Studies 1', parent_id: null },
    { id: 'gs1-history', name: 'Indian History', parent_id: 'gs1' },
    // ... more syllabus nodes
  ])

  // Seed knowledge chunks with embeddings
  await supabase.from('knowledge_chunks').insert([
    {
      chunk_text: 'Mock test content about Indian history',
      embedding: '[0.1, 0.2, ...]', // 1536-dim vector
      source_pdf_id: 'test-pdf-1',
    },
  ])
}
```

### Example E2E Test

```typescript
// tests/e2e/user-auth-flow.spec.ts
import { test, expect } from '@playwright/test'
import { login, logout, signup } from '../utils/auth'
import { resetTestDatabase, seedTestData } from '../../scripts/reset-test-db'

test.describe('User Authentication Flow', () => {
  test.beforeEach(async () => {
    await resetTestDatabase()
    await seedTestData()
  })

  test('user can signup, login, and logout', async ({ page }) => {
    // Step 1: Signup
    await signup(page, 'newuser@example.com', 'password123', 'New User')
    await expect(page).toHaveURL('/dashboard')
    await expect(page.locator('[data-testid="user-name"]')).toHaveText('New User')

    // Step 2: Logout
    await logout(page)
    await expect(page).toHaveURL('/login')

    // Step 3: Login
    await login(page, 'newuser@example.com', 'password123')
    await expect(page).toHaveURL('/dashboard')
  })

  test('user can perform RAG search', async ({ page }) => {
    // Login first
    await login(page, 'test-free@example.com', 'test-password')

    // Navigate to search
    await page.goto('/search')

    // Perform search
    await page.fill('[data-testid="search-input"]', 'Indian history')
    await page.click('[data-testid="search-button"]')

    // Verify results
    await expect(page.locator('[data-testid="search-results"]')).toBeVisible()
    await expect(page.locator('[data-testid="result-card"]').first()).toContainText('Mock RAG result')
  })
})
```

### CI Integration (GitHub Actions)

```yaml
# .github/workflows/ci.yml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Run linter
        run: pnpm lint

      - name: Run type check
        run: pnpm type-check

      - name: Run unit tests
        run: pnpm test

      - name: Install Playwright browsers
        run: pnpm playwright install --with-deps

      - name: Run integration tests
        run: pnpm playwright test
        env:
          TEST_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          TEST_SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.TEST_SUPABASE_SERVICE_ROLE_KEY }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
```

### Testing Strategy Guidelines

**Test Pyramid:**
- **70% Unit Tests:** Test individual functions, components, filters, actions
- **20% Integration Tests:** Test Edge Functions, database operations, API calls
- **10% E2E Tests:** Test critical user flows (auth, video generation, subscription)

**When to Write Each Type:**

- **Unit Test:** Pure functions, React components, utility functions
- **Integration Test:** Edge Function pipes, database queries with RLS
- **E2E Test:** User journeys across multiple pages/features

**Test Coverage Goals:**
- Critical paths (auth, payment, video generation): 90%+ coverage
- Business logic (filters, actions, utilities): 80%+ coverage
- UI components: 70%+ coverage
- E2E flows: 100% of critical user journeys

### Previous Story Insights

From **Story 0.2 (Supabase Local Development)**:
- Supabase test database can be created with CLI: `supabase db branch create test`
- Use separate credentials for test database
- RLS policies apply to test database (verify in tests)

From **Story 0.4-0.9 (VPS Service Integrations)**:
- All VPS services have `/health` endpoints
- Services return JSON responses
- Mock servers should replicate actual response formats

From **Story 0.11 (Full Stack Local Development)**:
- Next.js dev server runs on `http://localhost:3000`
- Turborepo allows running all apps with `pnpm dev`
- Tests can use `pnpm --filter web test` for app-specific tests

---

## Testing

**Test File Location:** [Source: docs/architecture/coding-standards.md#testing-standards]
- E2E tests: `tests/e2e/*.spec.ts`
- Test utilities: `tests/utils/*.ts`
- Mock handlers: `tests/mocks/handlers.ts`

**Testing Framework:** Playwright 1.40+ (E2E), Vitest (utility tests)

**Test Cases:**
1. **Playwright installation:** Verify browsers installed, config valid
2. **Database reset:** Verify all tables cleared, seeded data present
3. **Mock servers:** Verify each VPS service mock returns expected responses
4. **Auth utilities:** Test login(), logout(), signup() functions
5. **Example E2E test:** Verify user auth flow passes
6. **Test isolation:** Verify tests can run in parallel without conflicts
7. **CI integration:** Verify tests run successfully in GitHub Actions
8. **Debugging:** Verify traces/screenshots generated on failure

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Claude (SM Agent) |

---

## Dev Agent Record

_This section will be populated during implementation._

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_Files created/modified during implementation will be listed here_

---

## QA Results

_Results from QA Agent review will be recorded here after story completion_
