# Story 0.5: VPS Service Integration - Manim Renderer

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.5
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** the Manim Renderer service (port 5000) tested and integrated,
**so that** I can generate mathematical animations for videos.

---

## Acceptance Criteria

1. Service endpoint verified: `http://89.117.60.144:5000` responds to GET /health
2. Simple scene test: render basic "Hello Manim" animation scene
3. Complex scene test: render graph with axes, equations, transformations
4. Scene spec format documented: JSON structure for scene definitions
5. Render latency test: simple scenes complete in 2-6s, complex scenes in 10-30s
6. Output format verified: MP4 video with transparent background option
7. Error handling test: invalid scene specs return clear error messages
8. Queue test: multiple render requests queued properly (no blocking)
9. Disk space monitoring: verify rendered files cleaned up after processing
10. Edge Function wrapper created: `render_manim_action.ts` calls Manim service

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Service Health** (AC: 1)
  - [ ] Test health endpoint: `curl http://89.117.60.144:5000/health`
  - [ ] Verify response: `{ "status": "ok", "renderer": "manim", "version": "0.18.x" }`
  - [ ] Check service uptime
  - [ ] Review service logs: `ssh root@89.117.60.144 "docker logs manim-api"`

- [ ] **Task 2: Test Simple Scene Rendering** (AC: 2)
  - [ ] Create simple scene spec:
    ```json
    {
      "scene_type": "text",
      "content": "Hello Manim",
      "animation": "Write",
      "duration": 3,
      "background": "transparent"
    }
    ```
  - [ ] Send render request:
    ```bash
    curl -X POST http://89.117.60.144:5000/render \
      -H "Content-Type: application/json" \
      -d @simple-scene.json
    ```
  - [ ] Verify response contains job_id
  - [ ] Poll status: `GET /status/{job_id}`
  - [ ] Download rendered video when complete
  - [ ] Verify video plays correctly (3s duration)
  - [ ] Measure render time

- [ ] **Task 3: Test Complex Scene Rendering** (AC: 3)
  - [ ] Create complex scene with graph:
    ```json
    {
      "scene_type": "graph",
      "axes": { "x_range": [-5, 5], "y_range": [-3, 3] },
      "functions": [
        { "equation": "x**2", "color": "#FF6B6B" },
        { "equation": "sin(x)", "color": "#4ECDC4" }
      ],
      "labels": [
        { "text": "y = x²", "position": [3, 8] },
        { "text": "y = sin(x)", "position": [3, 1] }
      ],
      "animations": ["DrawGraph", "Transform"],
      "duration": 15
    }
    ```
  - [ ] Send render request
  - [ ] Verify rendering completes successfully
  - [ ] Download and review video (verify graph accuracy)
  - [ ] Measure render time (should be 10-30s)

- [ ] **Task 4: Document Scene Specification Format** (AC: 4)
  - [ ] Create `docs/vps-services/manim-scene-spec.md`
  - [ ] Document all supported scene types:
    - `text` - Text animations
    - `graph` - Mathematical graphs
    - `number_line` - Number line animations
    - `geometry` - Shapes and transformations
    - `timeline` - Historical timeline
  - [ ] Document animation options: Write, FadeIn, Transform, etc.
  - [ ] Document color format (hex codes)
  - [ ] Add 5+ example scene specs
  - [ ] Document optional parameters (background, quality, fps)

- [ ] **Task 5: Test Render Latency** (AC: 5)
  - [ ] Create benchmark script: `tests/manim-latency.test.ts`
  - [ ] Test simple scenes (5 different):
    ```typescript
    const start = Date.now();
    const jobId = await submitRenderJob(simpleScene);
    await pollUntilComplete(jobId);
    const latency = Date.now() - start;
    console.log(`Simple scene: ${latency}ms`);
    ```
  - [ ] Verify simple scenes complete in 2-6s
  - [ ] Test complex scenes (5 different)
  - [ ] Verify complex scenes complete in 10-30s
  - [ ] Document results (average, min, max)
  - [ ] If latency exceeds targets, investigate bottlenecks

- [ ] **Task 6: Test Output Formats** (AC: 6)
  - [ ] Render with transparent background:
    ```json
    { "scene_type": "text", "background": "transparent" }
    ```
  - [ ] Download and verify transparency (open in video editor)
  - [ ] Render with black background:
    ```json
    { "scene_type": "text", "background": "#000000" }
    ```
  - [ ] Test different quality settings: "low", "medium", "high"
  - [ ] Verify MP4 codec (H.264)
  - [ ] Test different resolutions: 720p, 1080p
  - [ ] Document file size for each quality level

- [ ] **Task 7: Test Error Handling** (AC: 7)
  - [ ] Send invalid scene spec (missing required fields):
    ```json
    { "scene_type": "invalid" }
    ```
  - [ ] Verify 400 Bad Request with error message
  - [ ] Test malformed JSON
  - [ ] Verify 400 with parse error
  - [ ] Test unsupported scene type
  - [ ] Verify clear error: "Scene type 'xyz' not supported"
  - [ ] Document all error codes and messages

- [ ] **Task 8: Test Job Queue** (AC: 8)
  - [ ] Submit 5 render jobs simultaneously:
    ```typescript
    const jobs = await Promise.all([
      submitRenderJob(scene1),
      submitRenderJob(scene2),
      submitRenderJob(scene3),
      submitRenderJob(scene4),
      submitRenderJob(scene5)
    ]);
    ```
  - [ ] Verify all jobs queued (return job_ids)
  - [ ] Check job statuses: `pending`, `rendering`, `completed`
  - [ ] Verify jobs process sequentially (not all at once)
  - [ ] Measure total time for 5 jobs
  - [ ] Document queue capacity (max concurrent renders)

- [ ] **Task 9: Test Disk Space Management** (AC: 9)
  - [ ] Check disk usage before tests: `df -h`
  - [ ] Submit 10 render jobs
  - [ ] Wait for completion
  - [ ] Check disk usage after
  - [ ] Verify rendered files are cleaned up automatically
  - [ ] Test cleanup policy:
    ```bash
    ssh root@89.117.60.144 "ls /var/manim/renders/"
    ```
  - [ ] Verify only recent files remain (e.g., last 24 hours)
  - [ ] Document cleanup schedule

- [ ] **Task 10: Create Edge Function Wrapper** (AC: 10)
  - [ ] Create `supabase/functions/actions/render_manim_action.ts`
  - [ ] Implement action:
    ```typescript
    export async function renderManimAction(sceneSpec: ManimScene) {
      // Submit render job
      const response = await fetch('http://89.117.60.144:5000/render', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sceneSpec)
      });

      const { job_id } = await response.json();

      // Poll for completion (with timeout)
      const videoUrl = await pollJobStatus(job_id, 60000); // 60s timeout

      return { videoUrl, jobId: job_id };
    }

    async function pollJobStatus(jobId: string, timeout: number) {
      const startTime = Date.now();

      while (Date.now() - startTime < timeout) {
        const status = await fetch(`http://89.117.60.144:5000/status/${jobId}`);
        const data = await status.json();

        if (data.status === 'completed') {
          return data.video_url;
        }

        if (data.status === 'failed') {
          throw new Error(`Render failed: ${data.error}`);
        }

        await new Promise(resolve => setTimeout(resolve, 2000)); // Poll every 2s
      }

      throw new Error('Render timeout');
    }
    ```
  - [ ] Add error handling and retry logic
  - [ ] Test wrapper via Edge Function
  - [ ] Document usage in README

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Create `docs/vps-services/manim-renderer.md`
  - [ ] Document API endpoints
  - [ ] Add scene specification reference
  - [ ] Add latency benchmarks
  - [ ] Add troubleshooting guide
  - [ ] Update `docs/infrastructure-reference.md`
  - [ ] Commit changes to Git

---

## Dev Notes

### Story Context

**Previous Stories:** 0.1 (VPS audit - service validated)

**Purpose:** Manim is the mathematical animation engine used for creating diagrams, graphs, and visual explanations in videos. It's critical for Daily Current Affairs videos, Topic Shorts, and Doubt Converter. This story validates the service can render scenes with acceptable latency.

**Risk:** HIGH - Blocks all video features with diagrams/animations

---

### Architecture Context

**Source Documents:**
- `docs/infrastructure-reference.md`
- `docs/architecture.md` - Section 3 (Tech Stack)
- Story 0.1 - Port 5000 validated

#### **Service Details** [Source: docs/infrastructure-reference.md]

**Endpoint:** `http://89.117.60.144:5000`
**Technology:** Manim Community Edition v0.18+, Python, FastAPI
**Purpose:** Mathematical animation rendering

**Key Features:**
- Vector-based animations (SVG → MP4)
- Transparent background support
- LaTeX equation rendering
- Graph and geometry tools

#### **Tech Stack** [Source: docs/architecture.md#3]

**Video Rendering:** Manim Community + Revideo

**Manim for:**
- Math equations
- Graphs and charts
- Geometric diagrams
- Timeline animations

**Performance Targets:**
- Simple scenes: 2-6s
- Complex scenes: 10-30s
- Max queue size: 10 concurrent jobs

---

### Testing

#### **Testing Standards**

**Test Framework:** Vitest 1.2+

**Test File Location:**
- Performance tests: `tests/vps-services/manim-latency.test.ts`
- Integration tests: `tests/integration/manim.test.ts`

**Manual Validation:**
- Watch rendered videos to verify visual quality
- Check animations are smooth (30fps)
- Verify transparency works correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft created | Bob (SM Agent) |

---

## Dev Agent Record

_(This section will be populated by the Dev Agent during implementation)_

---

## QA Results

_(This section will be populated by QA Agent after story review)_

---

**Story Status:** Draft
**Risk Level:** HIGH
**Estimated Effort:** 4-6 hours
**Dependencies:** Story 0.1 ✅
**Blocks:** Epic 3 (Daily CA Video), Epic 4 (Doubt Converter, Topic Shorts)
