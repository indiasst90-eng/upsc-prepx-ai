# Story 0.7: VPS Service Integration - DuckDuckGo Search Proxy

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.7
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** the DuckDuckGo Search service (port 8102) tested and integrated,
**so that** I can fetch current affairs from whitelisted sources.

---

## Acceptance Criteria

1. Service endpoint verified: `http://89.117.60.144:8102/search` responds to GET /health
2. Search test: query "UPSC current affairs" returns results
3. Whitelisting verified: only results from approved domains returned (visionias.in, drishtiias.com, etc.)
4. Response format validated: JSON with fields `{ results: [], metadata: {} }`
5. Pagination tested: retrieve multiple pages of results
6. Rate limiting tested: verify service respects search engine limits
7. Error handling test: network failures handled gracefully with retries
8. Date filtering test: filter results by date range (last 7 days, last 30 days)
9. Deduplication test: verify duplicate URLs are filtered
10. Edge Function wrapper created: `fetch_current_affairs_action.ts` calls search service

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Service Health** (AC: 1)
  - [ ] Test: `curl http://89.117.60.144:8102/health`
  - [ ] Verify response
  - [ ] Check service logs

- [ ] **Task 2: Test Basic Search** (AC: 2)
  - [ ] Query search service:
    ```bash
    curl "http://89.117.60.144:8102/search?q=UPSC+current+affairs&max_results=10"
    ```
  - [ ] Verify results returned
  - [ ] Check result structure (title, url, snippet, date)

- [ ] **Task 3: Test Domain Whitelisting** (AC: 3)
  - [ ] Query with UPSC sources filter:
    ```bash
    curl "http://89.117.60.144:8102/search/upsc?q=current+affairs"
    ```
  - [ ] Verify all results from whitelisted domains:
    - visionias.in
    - drishtiias.com
    - thehindu.com
    - pib.gov.in
    - forumias.com
    - insightsonindia.com
    - iasgyan.in
    - pmfias.com
  - [ ] Verify no results from non-whitelisted domains
  - [ ] Test with general query, verify filtering works

- [ ] **Task 4: Validate Response Format** (AC: 4)
  - [ ] Parse response JSON
  - [ ] Verify schema:
    ```typescript
    interface SearchResponse {
      results: Array<{
        title: string;
        url: string;
        snippet: string;
        source: string;
        published_date?: string;
      }>;
      metadata: {
        total_results: number;
        query: string;
        page: number;
      };
    }
    ```
  - [ ] Document in `docs/vps-services/search-proxy.md`

- [ ] **Task 5: Test Pagination** (AC: 5)
  - [ ] Request page 1: `?q=test&page=1`
  - [ ] Request page 2: `?q=test&page=2`
  - [ ] Verify different results
  - [ ] Test up to page 5
  - [ ] Document max pages supported

- [ ] **Task 6: Test Rate Limiting** (AC: 6)
  - [ ] Send 20 rapid requests
  - [ ] Verify service implements delay between requests
  - [ ] Check for 429 errors
  - [ ] Document rate limit (e.g., max 10 req/min)

- [ ] **Task 7: Test Error Handling** (AC: 7)
  - [ ] Simulate network error (disconnect VPS)
  - [ ] Verify service retries (2-3 attempts)
  - [ ] Verify graceful error response
  - [ ] Test with timeout scenario
  - [ ] Document retry strategy

- [ ] **Task 8: Test Date Filtering** (AC: 8)
  - [ ] Query last 7 days:
    ```bash
    curl "http://89.117.60.144:8102/search?q=current+affairs&date_filter=7d"
    ```
  - [ ] Verify all results from last week
  - [ ] Test last 30 days filter
  - [ ] Document date filter options

- [ ] **Task 9: Test Deduplication** (AC: 9)
  - [ ] Query broad term (returns duplicates)
  - [ ] Verify response has no duplicate URLs
  - [ ] Check deduplication logic in service
  - [ ] Document behavior

- [ ] **Task 10: Create Edge Function Wrapper** (AC: 10)
  - [ ] Create `supabase/functions/actions/fetch_current_affairs_action.ts`
  - [ ] Implement with retry logic
  - [ ] Add caching (1 hour TTL)
  - [ ] Test wrapper

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Create `docs/vps-services/search-proxy.md`
  - [ ] Document whitelisted domains
  - [ ] Update infrastructure reference
  - [ ] Commit changes

---

## Dev Notes

**Purpose:** Search proxy enables Daily Current Affairs video generation by scraping whitelisted UPSC sources.

**Risk:** MEDIUM - Only blocks current affairs features

**Dependencies:** Story 0.1 ✅

**Blocks:** Epic 3 (Daily Current Affairs Video)

---

### Architecture Context

[Source: docs/infrastructure-reference.md]

**Service:** DuckDuckGo Search Proxy
**Port:** 8102
**Technology:** FastAPI, Python
**Status:** ✅ Validated (HTTP 200)

**Whitelisted Sources:**
visionias.in, drishtiias.com, thehindu.com, pib.gov.in, forumias.com, insightsonindia.com, iasgyan.in, pmfias.com, pwonlyias.com, byjus.com

---

### Testing

**Test Framework:** Vitest
**Test Files:** `tests/vps-services/search-proxy.test.ts`

**Manual Validation:**
- Review search results for relevance
- Verify whitelisting is working

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

_(To be filled by Dev Agent)_

---

## QA Results

_(To be filled by QA Agent)_

---

**Story Status:** Draft
**Risk Level:** MEDIUM
**Estimated Effort:** 3-4 hours
**Dependencies:** Story 0.1 ✅
**Blocks:** Epic 3 (Daily Current Affairs)
