# Story 0.9: VPS Service Integration - Notes Generator

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.9
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** the Notes Generator service (port 8104) tested and integrated,
**so that** I can synthesize comprehensive notes from source material.

---

## Acceptance Criteria

1. Service endpoint verified: `http://89.117.60.144:8104/generate_notes` responds to GET /health
2. Note generation test: provide topic, receive summary/detailed/comprehensive notes
3. RAG integration test: verify service uses Document Retriever for grounding
4. Output format validated: JSON with `{ summary: string, detailed: string, comprehensive: string }`
5. Syllabus mapping test: notes automatically tagged with relevant syllabus nodes
6. Latency test: notes generation completes in <30s for typical topic
7. Error handling test: insufficient source material returns clear error
8. Batch processing test: generate notes for multiple topics in queue
9. Citation tracking: verify notes include source references
10. Edge Function wrapper created: `generate_notes_action.ts` calls Notes Generator

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Service Health** (AC: 1)
  - [ ] Test: `curl http://89.117.60.144:8104/health`
  - [ ] Verify response includes service status

- [ ] **Task 2: Test Note Generation** (AC: 2)
  - [ ] Submit request:
    ```json
    {
      "topic": "Fundamental Rights - Article 21",
      "levels": ["summary", "detailed", "comprehensive"]
    }
    ```
  - [ ] Verify all 3 note levels returned
  - [ ] Check content quality (manual review)
  - [ ] Verify summary ~100 words, detailed ~500 words, comprehensive ~1500 words

- [ ] **Task 3: Test RAG Integration** (AC: 3)
  - [ ] Submit topic that exists in knowledge base
  - [ ] Verify notes include grounded facts from RAG
  - [ ] Submit topic NOT in knowledge base
  - [ ] Verify notes marked as "limited grounding"
  - [ ] Check RAG service is called (monitor logs)

- [ ] **Task 4: Validate Response Format** (AC: 4)
  - [ ] Parse response JSON
  - [ ] Verify schema:
    ```typescript
    interface NotesResponse {
      summary: string;
      detailed: string;
      comprehensive: string;
      metadata: {
        topic: string;
        sources_used: number;
        confidence: number;
      };
    }
    ```
  - [ ] Document schema

- [ ] **Task 5: Test Syllabus Mapping** (AC: 5)
  - [ ] Generate notes for "Preamble of Constitution"
  - [ ] Verify response includes syllabus tags:
    ```json
    { "syllabus_tags": ["GS1", "polity", "constitution-basics"] }
    ```
  - [ ] Test with multiple topics
  - [ ] Verify tagging accuracy

- [ ] **Task 6: Test Latency** (AC: 6)
  - [ ] Measure generation time for 5 topics
  - [ ] Verify all complete in <30s
  - [ ] Document average latency

- [ ] **Task 7: Test Error Handling** (AC: 7)
  - [ ] Request notes for nonsense topic
  - [ ] Verify error: "Insufficient source material"
  - [ ] Test with empty topic
  - [ ] Verify validation error

- [ ] **Task 8: Test Batch Processing** (AC: 8)
  - [ ] Submit 5 topics simultaneously
  - [ ] Verify all queued
  - [ ] Check processing order
  - [ ] Verify all complete successfully

- [ ] **Task 9: Test Citation Tracking** (AC: 9)
  - [ ] Generate notes with citations enabled
  - [ ] Verify footnotes/references in output
  - [ ] Check source file names and page numbers

- [ ] **Task 10: Create Edge Function Wrapper** (AC: 10)
  - [ ] Create `supabase/functions/actions/generate_notes_action.ts`
  - [ ] Implement with caching
  - [ ] Test wrapper

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Create `docs/vps-services/notes-generator.md`
  - [ ] Update infrastructure reference
  - [ ] Commit changes

---

## Dev Notes

**Purpose:** Notes Generator creates 3-level notes (summary/detailed/comprehensive) using RAG + LLM.

**Risk:** MEDIUM - Blocks notes features

**Dependencies:** Stories 0.1 ✅, 0.4 ✅ (RAG Engine)

**Blocks:** Epic 2 (Comprehensive Notes)

---

### Architecture Context

[Source: docs/infrastructure-reference.md]

**Service:** Notes Generator
**Port:** 8104
**Technology:** FastAPI, A4F LLM
**Status:** ✅ Validated (HTTP 200)

---

### Testing

**Test Files:** `tests/vps-services/notes-generator.test.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft | Bob (SM Agent) |

---

**Story Status:** Draft
**Risk Level:** MEDIUM
**Estimated Effort:** 4-6 hours
**Dependencies:** Stories 0.1 ✅, 0.4 ✅
**Blocks:** Epic 2 (Notes)
