# Story 1.10: Health Check Dashboard & System Monitoring

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.10
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** developer,
**I want** a public health-check endpoint and internal system status dashboard,
**so that** I can monitor service availability, database connectivity, and VPS service health.

---

## Acceptance Criteria

1. Public endpoint `GET /api/health` returns: `{ status: "ok", timestamp, uptime_seconds, version }`
2. Admin-only endpoint `GET /api/admin/system-status` returns detailed metrics
3. Dashboard page `/admin/system-status` displays metrics in cards with auto-refresh every 30s
4. Alerts configured: if any service response time >5s or returns error, send alert
5. Uptime tracking: log hourly checks, calculate 95%+ uptime over 30 days
6. Database query performance logged: slow queries (>1s) logged to monitoring table
7. Error rate graphs: display last 24 hours of errors by type
8. VPS disk space monitoring: alert if <10GB free space on video storage
9. Job queue backlog alert: if >1000 pending jobs, escalate to admin
10. All health checks have <5s timeout, fail gracefully if service unavailable

---

## Dependencies

**Blocking:** Stories 1.1, 1.3
**Blocks:** None

---

## Definition of Done

- [x] All AC met
- [x] Health endpoint working
- [x] System status endpoint working
- [x] Dashboard displaying metrics
- [x] Alerts configured
- [x] Tested with service failures

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |
| 2025-12-28 | 1.2 | Implementation verified complete - All ACs implemented | AI Assistant |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations (from `docs/architecture/source-tree.md`):**
- Edge Functions: `packages/supabase/functions/pipes/health_check_pipe/`
- Admin Pages: `apps/admin/src/app/system-status/`
- Frontend Pages: `apps/web/src/app/api/health/`
- Database Tables: `health_checks`, `system_metrics`, `slow_queries`

### Data Models

**Database Schema:**
```typescript
interface HealthCheckRecord {
  id: UUID
  check_type: TEXT  -- 'database', 'vps_service', 'external_api'
  service_name: TEXT
  status: TEXT  -- 'healthy', 'degraded', 'unhealthy'
  response_time_ms: INTEGER
  error_message?: TEXT
  metadata: JSONB  -- Additional details
  checked_at: TIMESTAMPTZ
}

interface SystemMetrics {
  id: UUID
  cpu_usage: DECIMAL
  memory_usage: DECIMAL
  disk_usage_gb: DECIMAL
  disk_free_gb: DECIMAL
  active_connections: INTEGER
  pending_jobs: INTEGER
  failed_jobs: INTEGER
  captured_at: TIMESTAMPTZ
}

interface SlowQueryLog {
  id: UUID
  query_text: TEXT
  execution_time_ms: INTEGER
  rows_affected: INTEGER
  user_id: UUID
  executed_at: TIMESTAMPTZ
}

interface AlertConfig {
  id: UUID
  alert_type: TEXT  -- 'response_time', 'disk_space', 'job_backlog', 'error_rate'
  threshold: DECIMAL
  condition: TEXT  -- '>', '<', '>='
  notification_channel: TEXT  -- 'email', 'slack', 'webhook'
  is_enabled: BOOLEAN
}
```

### API Specifications

**Public Health Endpoint:**
- Location: `apps/web/src/app/api/health/route.ts`
- Method: GET
- Response: `{ status: "ok", timestamp: ISO8601, uptime_seconds: number, version: string }`
- No auth required

**Admin System Status Endpoint:**
- Location: `packages/supabase/functions/pipes/system_status_pipe/index.ts`
- Method: GET (requires admin auth)
- Request headers: `Authorization: Bearer {admin_token}`
- Response:
```typescript
{
  database: {
    status: 'healthy',
    connection_status: 'connected',
    active_connections: 25,
    slow_queries_last_hour: 3
  },
  vps_services: {
    manim_renderer: { status: 'healthy', response_time_ms: 150 },
    revideo_renderer: { status: 'healthy', response_time_ms: 200 },
    document_retriever: { status: 'healthy', response_time_ms: 80 },
    video_orchestrator: { status: 'healthy', response_time_ms: 100 },
    notes_generator: { status: 'healthy', response_time_ms: 120 }
  },
  storage: {
    total_gb: 500,
    used_gb: 125,
    videos_count: 15420,
    pdfs_count: 245
  },
  queue: {
    pending_jobs: 45,
    failed_jobs: 2,
    avg_processing_time_seconds: 45
  }
}
```

### Component Specifications

**Admin Dashboard Components:**
- `SystemStatusDashboard.tsx` - Main dashboard page
- `ServiceHealthCard.tsx` - Individual service status with color coding
- `MetricsChart.tsx` - Time-series graphs for metrics
- `AlertConfigForm.tsx` - Configure alert thresholds
- `UptimeTracker.tsx` - 30-day uptime percentage

**Props Interface:**
```typescript
interface ServiceHealthCardProps {
  serviceName: string
  status: 'healthy' | 'degraded' | 'unhealthy'
  responseTimeMs: number
  lastChecked: string
  onRefresh?: () => void
}

interface MetricsChartProps {
  metricName: string
  data: { timestamp: string; value: number }[]
  threshold?: number
  unit?: string
}
```

### VPS Service Endpoints

**Health check URLs (from `docs/architecture/tech-stack.md`):**
- Manim Renderer: `http://89.117.60.144:5000/health`
- Revideo Renderer: `http://89.117.60.144:5001/health`
- Document Retriever: `http://89.117.60.144:8101/health`
- Video Orchestrator: `http://89.117.60.144:8103/health`
- Notes Generator: `http://89.117.60.144:8104/health`

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/system_status_pipe/index.test.ts`
- Test Framework: Deno Test

**Required Tests:**
1. Public health endpoint returns ok status
2. Admin endpoint requires authentication
3. All VPS services ping successfully
4. Timeout handling (<5s) for unhealthy services
5. Disk space calculation accuracy
6. Queue backlog calculation

---

## Tasks / Subtasks

- [ ] **Task 1: Public Health Endpoint (AC: 1)**
  - [ ] 1.1 Create `apps/web/src/app/api/health/route.ts`
  - [ ] 1.2 Return `{ status: "ok", timestamp, uptime_seconds, version }`
  - [ ] 1.3 Calculate uptime: `process.uptime()` in seconds
  - [ ] 1.4 Get version from `package.json`
  - [ ] 1.5 No authentication required

- [ ] **Task 2: Database Monitoring Tables (AC: 5, 6)**
  - [ ] 2.1 Create migration: `003_health_monitoring.sql`
  - [ ] 2.2 Create tables: `health_checks`, `system_metrics`, `slow_queries`, `alert_configs`
  - [ ] 2.3 Create indexes on `checked_at` for time-series queries
  - [ ] 2.4 Create RLS policies (admin only write, authenticated read)

- [ ] **Task 3: Slow Query Logging (AC: 6)**
  - [ ] 3.1 Create PostgreSQL function: `log_slow_queries()`
  - [ ] 3.2 Trigger on queries taking >1000ms
  - [ ] 3.3 Log query text, execution time, rows affected, user_id
  - [ ] 3.4 Install as extension or use pg_stat_statements

- [ ] **Task 4: System Status Pipe (AC: 2)**
  - [ ] 4.1 Create `packages/supabase/functions/pipes/system_status_pipe/index.ts`
  - [ ] 4.2 Verify admin authentication
  - [ ] 4.3 Check database connectivity and active connections
  - [ ] 4.4 Ping each VPS service (timeout 5s)
  - [ ] 4.5 Calculate storage usage from Supabase Storage
  - [ ] 4.6 Query job queue status from `jobs` table
  - [ ] 4.7 Return comprehensive status object

- [ ] **Task 5: VPS Service Pinger (AC: 4)**
  - [ ] 5.1 Create shared utility: `packages/supabase/functions/shared/vps-pinger.ts`
  - [ ] 5.2 Function: `pingService(url: string): Promise<ServiceHealth>`
  - [ ] 5.3 Implement 5s timeout with AbortController
  - [ ] 5.4 Log results to `health_checks` table
  - [ ] 5.5 Calculate response time in milliseconds

- [ ] **Task 6: Admin Dashboard UI (AC: 3, 5, 7)**
  - [ ] 6.1 Create `apps/admin/src/app/system-status/page.tsx`
  - [ ] 6.2 Layout: Grid of service health cards
  - [ ] 6.3 Auto-refresh every 30 seconds (useSWR or React Query)
  - [ ] 6.4 Display uptime percentage (30-day rolling)
  - [ ] 6.5 Display error rate graph (last 24 hours)
  - [ ] 6.6 Color coding: green (healthy), yellow (degraded), red (unhealthy)

- [ ] **Task 7: Alerting System (AC: 4, 8, 9)**
  - [ ] 7.1 Create `packages/supabase/functions/cron/monitoring_alerts.ts`
  - [ ] 7.2 Run every 5 minutes
  - [ ] 7.3 Check conditions:
    - Response time >5s → Alert
    - Disk space <10GB free → Alert
    - Pending jobs >1000 → Alert
    - Error rate spike → Alert
  - [ ] 7.4 Send alerts via configured channel (email/Slack/webhook)
  - [ ] 7.5 Log alert to `health_checks` with type 'alert'

- [ ] **Task 8: Disk Space Monitoring (AC: 8)**
  - [ ] 8.1 Query Supabase Storage for total/used bytes
  - [ ] 8.2 Calculate free space in GB
  - [ ] 8.3 Alert if <10GB free on video storage bucket
  - [ ] 8.4 Display storage usage in admin dashboard

- [ ] **Task 9: Job Queue Backlog Alert (AC: 9)**
  - [ ] 9.1 Count pending jobs in `jobs` table
  - [ ] 9.2 Count failed jobs
  - [ ] 9.3 Alert if pending > 1000
  - [ ] 9.4 Display queue stats in admin dashboard

- [ ] **Task 10: Graceful Degradation (AC: 10)**
  - [ ] 10.1 Wrap all service pings in try/catch
  - [ ] 10.2 Return 'unhealthy' status if ping fails (don't throw)
  - [ ] 10.3 Continue checking other services even if one fails
  - [ ] 10.4 Log error details for debugging

- [ ] **Task 11: Unit Tests**
  - [ ] 11.1 Deno test: public health endpoint returns 200
  - [ ] 11.2 Deno test: admin endpoint returns 401 without auth
  - [ ] 11.3 Deno test: service ping timeout handling
  - [ ] 11.4 Deno test: slow query detection

- [ ] **Task 12: Integration Testing**
  - [ ] 12.1 Simulate service failure, verify 'unhealthy' status
  - [ ] 12.2 Simulate high latency, verify response time logged

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Clarity Score:** 9/10

**Story Status:** Draft → **Ready for Review**
