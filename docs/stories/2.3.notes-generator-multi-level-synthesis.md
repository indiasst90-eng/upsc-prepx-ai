# Story 2.3: Notes Generator - Multi-Level Text Synthesis

**Epic:** 2 - Core Learning Features
**Story Number:** 2.3
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 3
**Estimated Effort:** Large (L)
**Risk Level:** HIGH (AI synthesis critical)

---

## Story

**As a** UPSC aspirant,
**I want** to generate notes at 3 levels (summary, detailed, comprehensive) for any syllabus topic,
**so that** I can study according to my depth requirement and time availability.

---

## Acceptance Criteria

1. "Generate Notes" button on every syllabus topic detail modal
2. User selects level: Summary (100 words), Detailed (250 words), Comprehensive (500 words)
3. Edge Function: `generate_notes_pipe.ts` calls Notes Generator VPS service
4. RAG retrieval: fetch top 5 knowledge chunks matching topic
5. LLM synthesis: GPT-4 Turbo generates notes grounded in RAG chunks with citations
6. Notes include: key points (bullets), definitions, examples, UPSC relevance, related topics
7. Source citations appended: "Sources: [Book Title], Chapter X"
8. Notes saved to `comprehensive_notes` table
9. Generation time <10s for summary, <20s for comprehensive (P95)
10. Error handling: if confidence <70%, display warning

---

## Dependencies

**Blocking:** Stories 1.4, 1.6, 1.7
**Blocks:** Stories 2.4, 2.5

---

## Definition of Done

- [ ] All AC met
- [ ] Notes generation functional
- [ ] All 3 levels working
- [ ] RAG integration complete
- [ ] Citations accurate
- [ ] Performance targets met

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/pipes/generate_notes_pipe/`
- Frontend Components: `apps/web/src/components/notes/`
- Frontend Pages: `apps/web/src/app/(dashboard)/notes/`
- VPS Service: Notes Generator at `http://89.117.60.144:8104`

### Data Models

**Database Schema:**
```typescript
interface ComprehensiveNote {
  id: UUID
  user_id: UUID
  syllabus_node_id: UUID
  level: TEXT  -- 'summary', 'detailed', 'comprehensive'
  content: TEXT NOT NULL
  key_points: TEXT[]  -- JSON array
  definitions: TEXT[]  -- JSON array
  examples: TEXT[]  -- JSON array
  upsc_relevance: TEXT
  related_topics: UUID[]  -- Array of related syllabus_node_ids
  source_citations: TEXT
  confidence_score: DECIMAL
  created_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `generate_notes_pipe`
- Location: `packages/supabase/functions/pipes/generate_notes_pipe/index.ts`
- Method: POST
- Request body: `{ syllabus_node_id: string, level: 'summary' | 'detailed' | 'comprehensive' }`
- Response: `{ note_id: string, status: 'queued' | 'completed', generation_time_ms?: number }`

**VPS Service Call:**
- URL: `http://89.117.60.144:8104/generate_notes`
- Method: POST
- Payload: `{ topic, level, context_chunks: KnowledgeChunk[] }`

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/generate_notes_pipe/index.test.ts`
- Test Framework: Deno Test

---

## Tasks / Subtasks

- [ ] **Task 1: Database Schema (AC: 8)**
  - [ ] 1.1 Create migration: `005_comprehensive_notes.sql`
  - [ ] 1.2 Create `comprehensive_notes` table with all columns
  - [ ] 1.3 Create indexes on user_id, syllabus_node_id, level
  - [ ] 1.4 Update TypeScript types

- [ ] **Task 2: Notes Generation Pipe (AC: 3)**
  - [ ] 2.1 Create `packages/supabase/functions/pipes/generate_notes_pipe/index.ts`
  - [ ] 2.2 Apply auth_filter and entitlement_check_filter
  - [ ] 2.3 Fetch syllabus_node to get topic details
  - [ ] 2.4 Call Notes Generator VPS service
  - [ ] 2.5 Return job ID for async processing

- [ ] **Task 3: RAG Retrieval (AC: 4)**
  - [ ] 3.1 Call rag_search_pipe with topic as query
  - [ ] 3.2 Fetch top 5 knowledge chunks matching topic
  - [ ] 3.3 Pass chunks to Notes Generator for context

- [ ] **Task 4: LLM Synthesis (AC: 5-7)**
  - [ ] 4.1 Notes Generator calls A4F LLM (llama-4-scout)
  - [ ] 4.2 System prompt: "Generate UPSC notes grounded in provided source material..."
  - [ ] 4.3 Output structured JSON: content, key_points, definitions, examples, relevance
  - [ ] 4.4 Append source citations: "Sources: [Book Title], Chapter X"
  - [ ] 4.5 Calculate confidence score (0-1)

- [ ] **Task 5: Notes UI Integration (AC: 1-2)**
  - [ ] 5.1 Create `GenerateNotesButton.tsx` component
  - [ ] 5.2 Add to syllabus topic detail modal
  - [ ] 5.3 Create level selector: Summary (100 words), Detailed (250), Comprehensive (500)
  - [ ] 5.4 Show generation progress spinner
  - [ ] 5.5 Navigate to note on completion

- [ ] **Task 6: Notes Content Structure (AC: 6)**
  - [ ] 6.1 Render notes with sections: Key Points, Definitions, Examples, UPSC Relevance
  - [ ] 6.2 Display source citations
  - [ ] 6.3 Add related topics links

- [ ] **Task 7: Performance Optimization (AC: 9)**
  - [ ] 7.1 Target: <10s for summary, <20s for comprehensive (P95)
  - [ ] 7.2 Implement caching for repeated topic requests
  - [ ] 7.3 Queue low-priority requests during high load

- [ ] **Task 8: Confidence Warning (AC: 10)**
  - [ ] 8.1 Display warning if confidence < 0.70
  - [ ] 8.2 Message: "Low confidence - Cross-check recommended"
  - [ ] 8.3 Show sources for verification

- [ ] **Task 9: Unit Tests**
  - [ ] 9.1 Deno test: pipe authentication
  - [ ] 9.2 Deno test: entitlement check
  - [ ] 9.3 Deno test: confidence calculation

- [ ] **Task 10: Integration Testing**
  - [ ] 10.1 Full flow: request → RAG fetch → LLM synthesis → save → display

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft → **Ready for Review**
