# Story 0.8: VPS Service Integration - Video Orchestrator

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.8
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** the Video Orchestrator service (port 8103) tested and integrated,
**so that** I can coordinate multi-step video generation workflows.

---

## Acceptance Criteria

1. Service endpoint verified: `http://89.117.60.144:8103/render` responds to GET /health
2. Job submission test: submit video job, receive job_id
3. Job status polling test: check job status via GET /jobs/{job_id}
4. Callback webhook test: verify service calls webhook on completion
5. Multi-scene workflow test: orchestrate Manim render → TTS → Revideo composition
6. Error recovery test: failed steps retry with exponential backoff
7. Job queue management: verify FIFO processing, priority queue support
8. Concurrent job limit: verify max 10 jobs processed simultaneously
9. Job timeout handling: long-running jobs timeout after 10 minutes
10. Edge Function wrapper created: `video_orchestrator_pipe.ts` submits jobs

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Service Health** (AC: 1)
  - [ ] Test: `curl http://89.117.60.144:8103/health`
  - [ ] Verify queue status shown in health response
  - [ ] Check active jobs count

- [ ] **Task 2: Test Job Submission** (AC: 2)
  - [ ] Submit test job:
    ```json
    {
      "job_type": "video_render",
      "workflow": [
        { "step": "manim", "scene_spec": {...} },
        { "step": "tts", "text": "..." },
        { "step": "revideo", "composition_spec": {...} }
      ],
      "callback_url": "http://localhost:3000/webhook/video-complete"
    }
    ```
  - [ ] Verify job_id returned
  - [ ] Verify job appears in queue

- [ ] **Task 3: Test Job Status Polling** (AC: 3)
  - [ ] Poll job status:
    ```bash
    curl http://89.117.60.144:8103/jobs/{job_id}
    ```
  - [ ] Verify status transitions: pending → processing → completed
  - [ ] Check progress percentage
  - [ ] Verify estimated time remaining

- [ ] **Task 4: Test Webhook Callback** (AC: 4)
  - [ ] Set up local webhook receiver (test server)
  - [ ] Submit job with callback URL
  - [ ] Wait for completion
  - [ ] Verify webhook called with job result
  - [ ] Check callback payload structure

- [ ] **Task 5: Test Multi-Scene Workflow** (AC: 5)
  - [ ] Submit complete workflow (Manim → TTS → Revideo)
  - [ ] Verify each step executes in sequence
  - [ ] Check intermediate outputs stored
  - [ ] Verify final video URL returned
  - [ ] Measure end-to-end latency

- [ ] **Task 6: Test Error Recovery** (AC: 6)
  - [ ] Submit job with intentional failure (invalid Manim spec)
  - [ ] Verify service retries 3 times
  - [ ] Verify exponential backoff (1s, 2s, 4s delays)
  - [ ] Verify job status shows "failed" after retries
  - [ ] Check error details in response

- [ ] **Task 7: Test Job Queue Management** (AC: 7)
  - [ ] Submit 15 jobs simultaneously
  - [ ] Verify FIFO processing
  - [ ] Test priority queue (high priority jobs jump queue)
  - [ ] Document queue behavior

- [ ] **Task 8: Test Concurrent Job Limit** (AC: 8)
  - [ ] Submit 20 jobs
  - [ ] Verify only 10 process concurrently
  - [ ] Verify remaining 10 queued
  - [ ] Monitor service resource usage

- [ ] **Task 9: Test Job Timeout** (AC: 9)
  - [ ] Submit job with very long duration (>10 min)
  - [ ] Verify job times out at 10 minutes
  - [ ] Check timeout error message
  - [ ] Document timeout configuration

- [ ] **Task 10: Create Edge Function Wrapper** (AC: 10)
  - [ ] Create `supabase/functions/pipes/video_orchestrator_pipe.ts`
  - [ ] Implement job submission and polling
  - [ ] Add webhook handler
  - [ ] Test integration

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Create `docs/vps-services/video-orchestrator.md`
  - [ ] Document workflow structure
  - [ ] Update infrastructure reference
  - [ ] Commit changes

---

## Dev Notes

**Purpose:** Video Orchestrator coordinates the multi-step video pipeline (Manim → TTS → Revideo), managing job queues and error recovery.

**Risk:** HIGH - Blocks automated video workflows

**Dependencies:** Stories 0.1 ✅, 0.5 ✅, 0.6 ✅

**Blocks:** Epic 3 (Daily CA), Epic 4 (Doubt Converter)

---

### Architecture Context

[Source: docs/infrastructure-reference.md]

**Service:** Video Orchestrator
**Port:** 8103
**Technology:** Python/Node.js, Job Queue
**Status:** ✅ Validated (HTTP 200)

---

### Testing

**Test Files:** `tests/vps-services/video-orchestrator.test.ts`

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft | Bob (SM Agent) |

---

## Dev Agent Record

_(To be filled by Dev Agent)_

---

## QA Results

_(To be filled by QA Agent)_

---

**Story Status:** Draft
**Risk Level:** HIGH
**Estimated Effort:** 6-8 hours
**Dependencies:** Stories 0.1 ✅, 0.5 ✅, 0.6 ✅
**Blocks:** Epic 3, Epic 4
