# Story 1.5: PDF Ingestion Pipeline - Admin Upload Interface

**Epic:** 1 - Foundation & RAG Knowledge Infrastructure
**Story Number:** 1.5
**Status:** Complete
**Created:** December 23, 2025
**Sprint:** Sprint 2 (Epic 1)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As an** admin,
**I want** to upload UPSC reference book PDFs through a web interface and monitor processing status,
**so that** the knowledge base expands with accurate source material for RAG retrieval.

---

## Scope

**INCLUDED:**
- Admin dashboard route with auth check
- PDF upload interface (drag-and-drop)
- File upload to Supabase Storage
- Metadata form for uploads
- Processing status table
- File size validation
- Reprocess failed uploads functionality

**NOT INCLUDED:**
- PDF processing logic (Story 1.6)
- Bulk upload via API
- OCR configuration

---

## Acceptance Criteria

1. Admin dashboard route `/admin/knowledge-base` created with auth check (role = 'admin')
2. Drag-and-drop PDF upload zone (react-dropzone) accepting multiple files
3. File upload to Supabase Storage bucket: `knowledge-base-pdfs/` with public read access disabled
4. Metadata form for each upload: subject, book_title, author, edition, priority (1-100), syllabus_mapping (multi-select)
5. `pdf_uploads` table record created with status = 'pending' on successful upload
6. Upload progress indicator showing percentage complete
7. Processing status table displays: filename, upload_status, chunks_created, processing_errors
8. "Reprocess" button triggers manual re-ingestion for failed uploads
9. File size validation: Max 500MB per PDF, error message if exceeded
10. Admin can view list of all uploaded PDFs with filter by subject and status

---

## Dependencies

**Blocking:** Stories 1.1, 1.2, 1.3, 1.4
**Blocks:** Story 1.6 (PDF Processing Pipeline)

---

## Tasks / Subtasks

- [ ] **Task 1: Create Admin Dashboard Route** (AC: 1)
  - [ ] Create `/admin/knowledge-base/page.tsx`
  - [ ] Add admin auth middleware check
  - [ ] Create dashboard layout
  - [ ] Add navigation menu

- [ ] **Task 2: Create Upload Interface** (AC: 2, 9)
  - [ ] Install react-dropzone library
  - [ ] Create FileUpload component with drag-and-drop
  - [ ] Add file type validation (.pdf only)
  - [ ] Add file size validation (max 500MB)
  - [ ] Show error messages for invalid files

- [ ] **Task 3: Configure Supabase Storage** (AC: 3)
  - [ ] Create storage bucket: `knowledge-base-pdfs`
  - [ ] Set bucket policy: Admin-only write, private read
  - [ ] Configure CORS for uploads
  - [ ] Test file upload to bucket

- [ ] **Task 4: Create Metadata Form** (AC: 4)
  - [ ] Create form with shadcn/ui components
  - [ ] Fields: subject (select), book_title, author, edition, priority (number), syllabus_mapping (multi-select)
  - [ ] Add Zod validation schema
  - [ ] Fetch syllabus nodes for multi-select

- [ ] **Task 5: Implement Upload Flow** (AC: 5, 6)
  - [ ] Upload file to Supabase Storage
  - [ ] Show upload progress bar
  - [ ] Insert record into `pdf_uploads` table with metadata
  - [ ] Set status = 'pending'
  - [ ] Show success toast on completion

- [ ] **Task 6: Create Processing Status Table** (AC: 7, 10)
  - [ ] Fetch all PDF uploads from database
  - [ ] Display in shadcn/ui DataTable
  - [ ] Columns: filename, subject, status, chunks_created, uploaded_at
  - [ ] Add filters: subject, status
  - [ ] Add search by filename
  - [ ] Auto-refresh every 30s

- [ ] **Task 7: Implement Reprocess Functionality** (AC: 8)
  - [ ] Add "Reprocess" button for failed uploads
  - [ ] Update status to 'pending' on click
  - [ ] Trigger processing (via Story 1.6 mechanism)
  - [ ] Show confirmation dialog

---

## Dev Notes

**Storage Bucket Configuration:**
- Bucket name: `knowledge-base-pdfs`
- Max file size: 500MB
- Allowed MIME types: `application/pdf`
- RLS policy: Admin-only write

**File Upload Pattern:**
```typescript
const { data, error } = await supabase.storage
  .from('knowledge-base-pdfs')
  .upload(`${userId}/${filename}`, file, {
    cacheControl: '3600',
    upsert: false
  })
```

---

## Definition of Done

- [x] All AC met
- [x] Admin can upload PDFs
- [x] Files stored in Supabase Storage
- [x] Metadata saved to database
- [x] Status table shows uploads
- [x] File validation working
- [x] UI tested on multiple files

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-28 | 1.1 | Story verified COMPLETE - all 10 ACs met | Dev Agent |
