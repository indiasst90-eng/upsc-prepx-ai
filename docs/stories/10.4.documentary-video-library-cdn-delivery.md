# Story 10.4: Documentary Library - CDN Delivery & Chapter Navigation

**Epic:** 10 - Deep Learning Assets - Documentary Lectures & Weekly Analysis
**Story Number:** 10.4
**Status:** COMPLETE
**Created:** December 23, 2025
**Sprint:** Sprint 10 (Epic 10)
**Estimated Effort:** Medium (M)
**Risk Level:** MEDIUM

---

## Story

**As a** UPSC aspirant,
**I want** to access documentary lectures with chapter navigation and download options,
**so that** I can learn at my own pace and access content offline.

---

## Acceptance Criteria

1. Documentary library: `/documentaries` page with filters (subject, duration, topic)
2. Video player: custom player with chapter markers, seeking, speed control (0.5x-2x)
3. Chapter navigation: sidebar with chapter list, click to jump to chapter
4. Progress tracking: user's watch position saved, resume from where left
5. Download option: download full documentary or individual chapters (Pro users)
6. Offline storage: PWA caches for offline viewing (up to 500MB per video)
7. CDN delivery: Cloudflare CDN for fast playback globally
8. Quality options: 1080p, 720p, 480p streaming options
9. Transcript: downloadable PDF transcript of full documentary
10. Related content: recommendations for related documentaries/topics

---

## Dependencies

**Blocking:** Story 10.2
**Blocks:** None

---

## Definition of Done

- [x] All AC met
- [x] Player works smoothly
- [x] CDN integration complete
- [x] Tests passing

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-28 | 2.0 | Implementation complete - All 10 ACs verified | Quinn (QA Agent) |

---

## Implementation Summary

### Files Created:
1. **Migration 056**: `packages/supabase/migrations/056_documentary_library.sql`
   - `documentary_watch_progress` table for resume functionality
   - `chapter_watch_progress` table for detailed tracking
   - `documentary_downloads` table for Pro downloads
   - `documentary_offline_cache` for PWA caching
   - Functions: `update_watch_progress`, `get_resume_position`, `request_documentary_download`, `get_documentary_library`, `get_related_documentaries`, `get_documentary_with_chapters`

2. **API Route**: `apps/web/src/app/api/documentaries/route.ts`
   - GET: library with filters, single documentary, resume position, related content
   - POST: update_progress, request_download (Pro), cache_offline, get_cdn_url, get_transcript
   - CDN URL generation with Cloudflare
   - Quality options: 1080p, 720p, 480p
   - Max offline cache: 500MB

3. **Video Player**: `apps/web/src/components/documentary/DocumentaryPlayer.tsx`
   - Chapter markers on progress bar
   - Chapter sidebar navigation
   - Speed control (0.5x-2x)
   - Quality selector
   - Progress auto-save every 5 seconds

4. **Library Page**: `apps/web/src/app/(dashboard)/documentaries/page.tsx`
   - Filter by subject, duration, topic
   - Progress indicators on thumbnails
   - Download button (Pro only)
   - Offline cache button
   - Transcript PDF download
   - Related documentaries section

---

**Story Status:** COMPLETE
**Risk Level:** MEDIUM
**Estimated Effort:** Medium (M)
