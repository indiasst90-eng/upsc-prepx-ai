# Story 3.7: Video Player - Interactions & Analytics

**Epic:** 3 - Video Generation Pipeline
**Story Number:** 3.7
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 4
**Estimated Effort:** Medium (M)
**Risk Level:** LOW

---

## Story

**As a** UPSC aspirant,
**I want** an interactive video player with playback controls, speed adjustment, and chapter navigation,
**so that** I can watch daily CA videos efficiently and jump to relevant sections.

---

## Acceptance Criteria

1. Custom video player component with shadcn/ui styling
2. Controls: play/pause, seek bar, volume, fullscreen, speed (0.75x, 1x, 1.25x, 1.5x, 2x)
3. Chapter markers: topic segments displayed as clickable chapters
4. Keyboard shortcuts: space (play/pause), arrow keys (seek), f (fullscreen)
5. Watch progress saved: resume from last position
6. Picture-in-Picture mode supported
7. Analytics tracked: play event, pause event, seek event, completion event
8. Engagement metrics: watch time, completion rate, avg speed used
9. Mobile-optimized: touch gestures, responsive controls
10. Accessibility: captions toggle, keyboard navigation

---

## Dependencies

**Blocking:** Story 3.5
**Blocks:** None

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Frontend Components: `apps/web/src/components/video/CAVideoPlayer.tsx`
- Stores: `apps/web/src/stores/videoProgressStore.ts`
- Analytics: `video_analytics` table

### Data Models

**Database Schema:**
```typescript
interface VideoAnalytics {
  id: UUID
  user_id: UUID
  video_id: UUID
  event_type: TEXT  -- 'play', 'pause', 'seek', 'complete', 'speed_change'
  timestamp: INTEGER  -- video position in seconds
  old_timestamp?: INTEGER
  playback_speed?: DECIMAL
  device_info: JSONB  -- { browser, os, device_type }
  created_at: TIMESTAMPTZ
}

interface WatchProgress {
  user_id: UUID
  video_id: UUID
  last_position_seconds: INTEGER
  completed: BOOLEAN
  completed_at?: TIMESTAMPTZ
}
```

### API Specifications

**Analytics Endpoint:**
- Location: `apps/web/src/app/api/analytics/video/route.ts`
- Method: POST
- Payload: `{ video_id, event_type, timestamp, playback_speed }`

### Testing Standards

**Test File Location:**
- Unit Tests: `apps/web/src/components/video/**/*.test.tsx`

---

## Tasks / Subtasks

- [ ] **Task 1: Video Player Component (AC: 1, 24)**
  - [ ] 1.1 Create `CAVideoPlayer.tsx` component
  - [ ] 1.2 Use shadcn/ui styling (Neon Glass dark mode)
  - [ ] 1.3 Wrap HTML5 video element
  - [ ] 1.4 Custom control bar styling

- [ ] **Task 2: Playback Controls (AC: 2)**
  - [ ] 2.1 Create `VideoControls.tsx` component
  - [ ] 2.2 Controls: play/pause, seek bar, volume, fullscreen
  - [ ] 2.3 Speed options: 0.75x, 1x, 1.25x, 1.5x, 2x
  - [ ] 2.4 Custom styling matching theme

- [ ] **Task 3: Chapter Markers (AC: 3)**
  - [ ] 3.1 Parse script_sections for chapter data
  - [ ] 3.2 Display chapters as clickable markers on seek bar
  - [ ] 3.3 Click chapter to jump to position
  - [ ] 3.4 Chapter list sidebar

- [ ] **Task 4: Keyboard Shortcuts (AC: 4)**
  - [ ] 4.1 Add keyboard event listener
  - [ ] 4.2 Space: play/pause
  - [ ] 4.3 Arrow keys: seek +/- 10 seconds
  - [ ] 4.4 F: toggle fullscreen
  - [ ] 4.5 M: toggle mute

- [ ] **Task 5: Progress Saving (AC: 5)**
  - [ ] 5.1 Create `videoProgressStore.ts` in Zustand
  - [ ] 5.2 Save position every 5 seconds
  - [ ] 5.3 Restore position on video load
  - [ ] 5.4 Resume playback prompt

- [ ] **Task 6: PiP Support (AC: 6)**
  - [ ] 6.1 Implement Picture-in-Picture API
  - [ ] 6.2 PiP button in controls
  - [ ] 6.3 Handle PiP state changes

- [ ] **Task 7: Analytics Tracking (AC: 7, 8)**
  - [ ] 7.1 Create `trackVideoEvent()` function
  - [ ] 7.2 Track: play, pause, seek, complete events
  - [ ] 7.3 Calculate metrics: watch time, completion rate, avg speed
  - [ ] 7.4 Store in `video_analytics` table

- [ ] **Task 8: Mobile Optimization (AC: 9)**
  - [ ] 8.1 Touch-friendly control targets (44px min)
  - [ ] 8.2 Swipe gestures for volume/brightness
  - [ ] 8.3 Responsive control layout
  - [ ] 8.4 Test on iOS/Android

- [ ] **Task 9: Accessibility (AC: 10)**
  - [ ] 9.1 Add closed captions toggle
  - [ ] 9.2 Keyboard navigation for controls
  - [ ] 9.3 ARIA labels on all buttons
  - [ ] 9.4 Screen reader support

- [ ] **Task 10: Unit Tests**
  - [ ] 10.1 Test keyboard shortcuts
  - [ ] 10.2 Test progress saving
  - [ ] 10.3 Test analytics tracking

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft â†’ **Ready for Review**
