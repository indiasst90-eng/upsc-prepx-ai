# Story 0.6: VPS Service Integration - Revideo Renderer

**Epic:** 0 - Infrastructure Prerequisites
**Story Number:** 0.6
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 1 (Epic 0 - Infrastructure Setup)

---

## Story

**As a** developer,
**I want** the Revideo Renderer service (port 5001) tested and integrated,
**so that** I can compose final videos with TTS, scenes, and transitions.

---

## Acceptance Criteria

1. Service endpoint verified: `http://89.117.60.144:5001` responds to GET /health
2. Simple composition test: combine 2 video clips with fade transition
3. TTS integration test: render video with A4F TTS audio narration
4. Manim integration test: compose video using Manim scene output + TTS
5. Timeline spec format documented: JSON structure for video composition
6. Render latency test: 60s video completes in <60s, 180s video in <120s
7. Output quality verified: 1080p MP4, 30fps, H.264 codec
8. Multiple aspect ratios tested: 16:9, 9:16, 1:1 all render correctly
9. Error handling test: missing assets return clear error messages
10. Edge Function wrapper created: `render_video_action.ts` calls Revideo service

---

## Tasks / Subtasks

- [ ] **Task 1: Verify Service Health** (AC: 1)
  - [ ] Test health endpoint: `curl http://89.117.60.144:5001/health`
  - [ ] Verify response includes Revideo version
  - [ ] Check service logs
  - [ ] Document any startup warnings

- [ ] **Task 2: Test Simple Video Composition** (AC: 2)
  - [ ] Create 2 test video clips (5s each, solid colors)
  - [ ] Create composition spec:
    ```json
    {
      "composition": "SimpleTransition",
      "clips": [
        { "url": "clip1.mp4", "start": 0, "duration": 5 },
        { "url": "clip2.mp4", "start": 5, "duration": 5 }
      ],
      "transitions": [
        { "type": "fade", "position": 5, "duration": 1 }
      ],
      "fps": 30,
      "resolution": "1920x1080"
    }
    ```
  - [ ] Submit render request
  - [ ] Poll job status until complete
  - [ ] Download composed video
  - [ ] Verify 10s total duration with fade transition
  - [ ] Measure render latency

- [ ] **Task 3: Test TTS Integration** (AC: 3)
  - [ ] Generate TTS audio using Story 0.3 A4F integration:
    ```typescript
    const audioUrl = await generateTTS('Welcome to this UPSC tutorial');
    ```
  - [ ] Create video with TTS narration:
    ```json
    {
      "composition": "NarratedSlides",
      "audio": { "url": "narration.mp3" },
      "slides": [
        { "text": "Slide 1", "duration": 3 },
        { "text": "Slide 2", "duration": 3 }
      ]
    }
    ```
  - [ ] Verify audio syncs with slides
  - [ ] Check audio quality in final video
  - [ ] Test with different voice types

- [ ] **Task 4: Test Manim + Revideo Integration** (AC: 4)
  - [ ] Use Manim output from Story 0.5 test
  - [ ] Create composition with Manim scene + TTS:
    ```json
    {
      "composition": "ExplainerVideo",
      "scenes": [
        { "type": "manim", "url": "manim-output.mp4", "duration": 10 },
        { "type": "text", "content": "Summary slide", "duration": 3 }
      ],
      "audio": { "url": "narration.mp3" },
      "transitions": [{ "type": "fade", "position": 10 }]
    }
    ```
  - [ ] Verify end-to-end pipeline: Manim render → TTS → Revideo composition
  - [ ] This validates the complete video generation stack
  - [ ] Measure total pipeline latency (Manim + TTS + Revideo)

- [ ] **Task 5: Document Timeline Specification** (AC: 5)
  - [ ] Create `docs/vps-services/revideo-timeline-spec.md`
  - [ ] Document composition types
  - [ ] Document clip object structure
  - [ ] Document transition types: fade, wipe, slide, dissolve
  - [ ] Document audio sync options
  - [ ] Add 10+ example compositions

- [ ] **Task 6: Test Render Latency** (AC: 6)
  - [ ] Test 60s video render:
    ```json
    { "composition": "TestVideo60s", "duration": 60 }
    ```
  - [ ] Measure time to completion
  - [ ] Verify completes in <60s (real-time rendering target)
  - [ ] Test 180s video (3 minutes)
  - [ ] Verify completes in <120s
  - [ ] Document latency for different video lengths (30s, 60s, 120s, 180s)

- [ ] **Task 7: Verify Output Quality** (AC: 7)
  - [ ] Inspect rendered video metadata:
    ```bash
    ffprobe output.mp4 2>&1 | grep -E '(Video|Audio|codec|fps|resolution)'
    ```
  - [ ] Verify resolution: 1920x1080
  - [ ] Verify frame rate: 30 fps
  - [ ] Verify codec: H.264
  - [ ] Verify audio codec: AAC (if audio present)
  - [ ] Check bitrate (target: 5-8 Mbps for 1080p)
  - [ ] Play video and verify no artifacts

- [ ] **Task 8: Test Multiple Aspect Ratios** (AC: 8)
  - [ ] Render 16:9 video (YouTube format):
    ```json
    { "resolution": "1920x1080" }
    ```
  - [ ] Render 9:16 video (Instagram Reels/Shorts):
    ```json
    { "resolution": "1080x1920" }
    ```
  - [ ] Render 1:1 video (Instagram feed):
    ```json
    { "resolution": "1080x1080" }
    ```
  - [ ] Verify all render successfully
  - [ ] Check content doesn't get cropped incorrectly
  - [ ] Document aspect ratio support

- [ ] **Task 9: Test Error Handling** (AC: 9)
  - [ ] Submit composition with missing asset URL:
    ```json
    { "clips": [{ "url": "nonexistent.mp4" }] }
    ```
  - [ ] Verify error message: "Asset not found: nonexistent.mp4"
  - [ ] Test with invalid audio URL
  - [ ] Test with corrupted video file
  - [ ] Verify job status shows "failed" with reason
  - [ ] Document all error scenarios

- [ ] **Task 10: Create Edge Function Wrapper** (AC: 10)
  - [ ] Create `supabase/functions/actions/render_video_action.ts`
  - [ ] Implement action with polling logic
  - [ ] Add timeout handling (default: 300s for long videos)
  - [ ] Add progress callback support
  - [ ] Test wrapper integration
  - [ ] Document usage examples

- [ ] **Task 11: Update Documentation** (All ACs)
  - [ ] Consolidate all findings
  - [ ] Update `docs/infrastructure-reference.md`
  - [ ] Add benchmark results
  - [ ] Commit changes to Git

---

## Dev Notes

### Story Context

**Previous Stories:**
- Story 0.5: Manim Renderer validated

**Purpose:** Revideo is the final composition layer that assembles Manim scenes, TTS audio, transitions, and text overlays into the final video. It's the last step in the video generation pipeline.

**Risk:** CRITICAL - Blocks all video generation features

---

### Architecture Context

[Source: docs/infrastructure-reference.md, Story 0.1]

**Service:** Revideo Renderer
**Port:** 5001
**Technology:** Node.js, Revideo (Remotion alternative)
**Status:** ✅ Validated in Story 0.1 (HTTP 200)

**Performance Targets:**
- 60s video in <60s (real-time)
- 180s video in <120s
- 1080p @ 30fps output

---

### Testing

**Test Framework:** Vitest + manual video review

**Test Files:**
- `tests/vps-services/revideo-render.test.ts`
- `tests/integration/video-pipeline.test.ts`

**Manual Validation:**
- Watch rendered videos for quality
- Verify audio-video sync
- Check transition smoothness

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story draft created | Bob (SM Agent) |

---

## Dev Agent Record

_(To be filled by Dev Agent)_

---

## QA Results

_(To be filled by QA Agent)_

---

**Story Status:** Draft
**Risk Level:** CRITICAL
**Estimated Effort:** 4-6 hours
**Dependencies:** Story 0.1 ✅, Story 0.5 ✅
**Blocks:** Epic 3, Epic 4 (all video features)
