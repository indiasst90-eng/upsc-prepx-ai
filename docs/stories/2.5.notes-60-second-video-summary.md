# Story 2.5: Notes Generator - 60-Second Video Summary

**Epic:** 2 - Core Learning Features
**Story Number:** 2.5
**Status:** Draft
**Created:** December 23, 2025
**Sprint:** Sprint 3
**Estimated Effort:** Large (L)
**Risk Level:** HIGH

---

## Story

**As a** UPSC aspirant,
**I want** each note to have an optional 60-second animated video summary,
**so that** I can quickly revise topics through video before reading full notes.

---

## Acceptance Criteria

1. "Generate Video Summary" checkbox on notes generation form (Pro users only)
2. Video script generated from comprehensive notes: extract 3-4 key points, 150-200 words
3. Manim scenes generated for 1-2 critical visuals (reuse from notes diagrams if available)
4. TTS audio generated: A4F TTS API with selected voice (user preference from profile)
5. Revideo composition: NotesSummaryTemplate assembles script, TTS, Manim clips, transitions (via Revideo Renderer at http://89.117.60.144:5001)
6. Video rendered via VPS Video Orchestrator
7. Video uploaded to Supabase Storage: videos/notes-summaries/{note_id}.mp4
8. Render time <60 seconds (P95), job queued with priority high
9. Video player embedded in notes view: autoplay on note open, controls (pause, speed, seek)
10. Video linked to note record: comprehensive_notes.summary_video_url column updated

---

## Dependencies

**Blocking:** Stories 2.3, 2.4, 1.6 (Revideo)
**Blocks:** None

---

## Definition of Done

- [ ] All AC met
- [ ] Video generation functional
- [ ] Pro-only entitlement check working
- [ ] TTS integration complete
- [ ] Revideo composition working
- [ ] Video uploaded and playable
- [ ] Performance targets met

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-23 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2025-12-24 | 1.1 | Added Dev Notes and Tasks/Subtasks | Bob (SM Agent) |

---

## Dev Notes

### Relevant Source Tree Info

**File Locations:**
- Edge Functions: `packages/supabase/functions/pipes/generate_video_summary_pipe/`
- Frontend Components: `apps/web/src/components/notes/VideoSummaryPlayer.tsx`
- VPS Service: Revideo Renderer at `http://89.117.60.144:5001`
- Video Orchestrator: `http://89.117.60.144:8103`

### Data Models

**Database Schema:**
```typescript
interface VideoSummary {
  id: UUID
  note_id: UUID NOT NULL
  user_id: UUID NOT NULL
  video_url: TEXT
  duration_seconds: INTEGER
  status: TEXT  -- 'queued', 'processing', 'completed', 'failed'
  script_text: TEXT
  created_at: TIMESTAMPTZ
  completed_at: TIMESTAMPTZ
}
```

### API Specifications

**Edge Function:** `generate_video_summary_pipe`
- Location: `packages/supabase/functions/pipes/generate_video_summary_pipe/index.ts`
- Method: POST
- Request body: `{ note_id: string, priority: 'high' | 'normal' }`
- Response: `{ jobId: string, estimated_time_seconds: number }`

**Video Template:**
- Template: `NotesSummaryTemplate` in Revideo
- Duration: 60 seconds
- Sections: Intro (5s), Key Points (40s, 3-4 points), Conclusion (15s)

### Testing Standards

**Test File Location:**
- Unit Tests: `packages/supabase/functions/pipes/generate_video_summary_pipe/index.test.ts`

---

## Tasks / Subtasks

- [ ] **Task 1: Video Summary Pipe (AC: 1)**
  - [ ] 1.1 Create `generate_video_summary_pipe/index.ts`
  - [ ] 1.2 Check entitlement (Pro users only)
  - [ ] 1.3 Fetch note content from `comprehensive_notes`
  - [ ] 1.4 Create `video_summaries` record with status 'queued'
  - [ ] 1.5 Return job ID

- [ ] **Task 2: Script Generation (AC: 2)**
  - [ ] 2.1 Create `generate_summary_script_action.ts`
  - [ ] 2.2 Extract 3-4 key points from comprehensive notes
  - [ ] 2.3 Generate 150-200 word narration script
  - [ ] 2.4 Structure: Intro → Point 1 → Point 2 → Point 3 → Conclusion
  - [ ] 2.5 Return script with timestamps

- [ ] **Task 3: TTS Audio (AC: 4)**
  - [ ] 3.1 Call A4F TTS API (provider-5/tts-1)
  - [ ] 3.2 Use user's preferred voice from profile
  - [ ] 3.3 Generate audio for script sections
  - [ ] 3.4 Return audio URLs

- [ ] **Task 4: Manim Scenes (AC: 3)**
  - [ ] 4.1 Reuse diagrams from Story 2.4 if available
  - [ ] 4.2 Generate 1-2 new visuals for key points
  - [ ] 4.3 Pass scene specs to Revideo

- [ ] **Task 5: Revideo Assembly (AC: 5, 7)**
  - [ ] 5.1 Call Video Orchestrator at `http://89.117.60.144:8103/render`
  - [ ] 5.2 Pass: script, TTS audio URLs, Manim scene URLs
  - [ ] 5.3 Template: NotesSummaryTemplate
  - [ ] 5.4 Output: MP4 video

- [ ] **Task 6: Storage & Database (AC: 7, 9)**
  - [ ] 6.1 Upload to Supabase Storage: `videos/notes-summaries/{note_id}.mp4`
  - [ ] 6.2 Update `video_summaries` table with video_url
  - [ ] 6.3 Update `comprehensive_notes.summary_video_url`

- [ ] **Task 7: Performance (AC: 8)**
  - [ ] 7.1 Priority: high for video summaries
  - [ ] 7.2 Target: <60 seconds render time (P95)
  - [ ] 7.3 Queue management via Video Orchestrator

- [ ] **Task 8: Video Player (AC: 9)**
  - [ ] 8.1 Create `VideoSummaryPlayer.tsx`
  - [ ] 8.2 Autoplay on note open (muted)
  - [ ] 8.3 Controls: pause, speed (0.5x, 1x, 1.5x), seek bar
  - [ ] 8.4 Progress indicator

- [ ] **Task 9: Entitlement Check (AC: 1)**
  - [ ] 9.1 Only Pro users can generate video summaries
  - [ ] 9.2 Free users see "Upgrade to Pro" prompt
  - [ ] 9.3 Use entitlement_check_filter

- [ ] **Task 10: Unit Tests**
  - [ ] 10.1 Deno test: entitlement check
  - [ ] 10.2 Deno test: script generation
  - [ ] 10.3 Deno test: video URL stored correctly

- [ ] **Task 11: Integration Testing**
  - [ ] 11.1 End-to-end: generate → render → upload → play

---

## QA Results

**Validation Date:** December 24, 2025
**Validated By:** Bob (SM Agent) - Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | None   |
| 2. Technical Implementation Guidance | PASS   | None   |
| 3. Reference Effectiveness           | PASS   | None   |
| 4. Self-Containment Assessment       | PASS   | None   |
| 5. Testing Guidance                  | PASS   | None   |

**Final Assessment:** READY - The story provides sufficient context for implementation

**Story Status:** Draft → **Ready for Review**
