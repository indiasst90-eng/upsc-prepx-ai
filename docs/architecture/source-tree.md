# Source Tree / Project Structure

**Version:** 1.0
**Last Updated:** December 23, 2025
**Source:** Extracted from `docs/architecture.md` Section 11

---

## Monorepo Structure

**Monorepo Tool:** Turborepo v2.x
**Package Manager:** pnpm 8+
**Package Organization:** Domain-driven workspaces with clear boundaries

```
upsc-ai-mentor/
├── apps/
│   ├── web/                      # Student-facing Next.js application
│   │   ├── src/
│   │   │   ├── app/              # Next.js 14 App Router
│   │   │   │   ├── (public)/    # Public routes (landing, login, signup)
│   │   │   │   ├── (dashboard)/ # Protected routes (search, notes, videos, profile)
│   │   │   │   ├── api/          # Next.js API routes (if needed)
│   │   │   │   ├── layout.tsx    # Root layout
│   │   │   │   └── page.tsx      # Landing page
│   │   │   ├── components/       # React components
│   │   │   │   ├── auth/         # Auth components (AuthProvider, LoginForm, SignupForm)
│   │   │   │   ├── search/       # Search components (SearchBar, ResultCard, FilterSidebar)
│   │   │   │   ├── video/        # Video components (VideoPlayer, RenderProgress)
│   │   │   │   ├── notes/        # Notes components (NotesViewer, DiagramViewer)
│   │   │   │   ├── layout/       # Layout components (Header, Sidebar, Footer)
│   │   │   │   └── ui/           # shadcn/ui components (Button, Card, Dialog, etc.)
│   │   │   ├── lib/              # Utilities and helpers
│   │   │   │   ├── supabase/     # Supabase client initialization
│   │   │   │   ├── utils.ts      # General utilities
│   │   │   │   └── cn.ts         # className utility
│   │   │   ├── hooks/            # Custom React hooks
│   │   │   ├── stores/           # Zustand stores
│   │   │   │   ├── authStore.ts  # Authentication state
│   │   │   │   └── uiStore.ts    # UI state (sidebar, theme)
│   │   │   ├── styles/           # Global styles
│   │   │   │   └── globals.css   # Tailwind CSS imports
│   │   │   └── types/            # TypeScript type definitions
│   │   ├── public/               # Static assets
│   │   ├── middleware.ts         # Next.js middleware (auth checks)
│   │   ├── next.config.js        # Next.js configuration
│   │   ├── tailwind.config.ts    # Tailwind CSS configuration
│   │   ├── tsconfig.json         # TypeScript configuration
│   │   └── package.json          # Package dependencies
│   │
│   └── admin/                    # Admin dashboard Next.js application
│       ├── src/
│       │   ├── app/              # Admin routes (PDF upload, content management)
│       │   ├── components/       # Admin-specific components
│       │   └── lib/              # Admin utilities
│       ├── middleware.ts         # Admin auth checks
│       ├── next.config.js
│       ├── tailwind.config.ts
│       ├── tsconfig.json
│       └── package.json
│
├── packages/
│   ├── supabase/                 # Supabase Edge Functions, migrations, types
│   │   ├── supabase/
│   │   │   ├── functions/        # Edge Functions (Deno/TypeScript)
│   │   │   │   ├── pipes/        # Orchestrator Edge Functions
│   │   │   │   │   ├── doubt_video_converter_pipe/
│   │   │   │   │   │   └── index.ts
│   │   │   │   │   ├── daily_ca_video_pipe/
│   │   │   │   │   │   └── index.ts
│   │   │   │   │   └── ...       # 30+ pipes
│   │   │   │   ├── filters/      # Validation/enrichment functions
│   │   │   │   │   ├── auth_filter.ts
│   │   │   │   │   ├── entitlement_check_filter.ts
│   │   │   │   │   ├── content_safety_filter.ts
│   │   │   │   │   ├── rag_injector_filter.ts
│   │   │   │   │   └── validate_input_filter.ts
│   │   │   │   ├── actions/      # Side-effect functions
│   │   │   │   │   ├── generate_script_action.ts
│   │   │   │   │   ├── render_video_action.ts
│   │   │   │   │   ├── store_result_action.ts
│   │   │   │   │   └── update_entitlement_action.ts
│   │   │   │   └── shared/       # Shared utilities for Edge Functions
│   │   │   │       ├── supabase-client.ts
│   │   │   │       ├── a4f-client.ts
│   │   │   │       └── vps-client.ts
│   │   │   ├── migrations/       # Database migrations (SQL)
│   │   │   │   ├── 00001_initial_schema.sql
│   │   │   │   ├── 00002_add_video_tables.sql
│   │   │   │   └── ...
│   │   │   └── config.toml       # Supabase local config
│   │   ├── types/                # Auto-generated Supabase TypeScript types
│   │   │   └── database.types.ts # Generated by `supabase gen types typescript`
│   │   ├── package.json
│   │   └── tsconfig.json
│   │
│   ├── ui/                       # Shared React components
│   │   ├── src/
│   │   │   ├── button.tsx        # shadcn/ui Button customization
│   │   │   ├── card.tsx          # shadcn/ui Card customization
│   │   │   ├── dialog.tsx        # shadcn/ui Dialog customization
│   │   │   └── ...               # Other shared components
│   │   ├── tsconfig.json
│   │   └── package.json
│   │
│   ├── config/                   # Shared configurations
│   │   ├── eslint-config/        # ESLint presets
│   │   ├── tailwind-config/      # Tailwind base config
│   │   ├── tsconfig/             # TypeScript base configs
│   │   │   ├── base.json
│   │   │   ├── nextjs.json
│   │   │   └── deno.json
│   │   └── package.json
│   │
│   └── utils/                    # Shared utilities
│       ├── src/
│       │   ├── validation.ts     # Zod schemas for validation
│       │   ├── formatting.ts     # Date/number formatting
│       │   ├── constants.ts      # Shared constants
│       │   └── helpers.ts        # Utility functions
│       ├── tsconfig.json
│       └── package.json
│
├── services/                     # Optional: VPS service source code
│   ├── manim-renderer/           # Manim service (Python)
│   ├── revideo-renderer/         # Revideo service (Node.js/TypeScript)
│   ├── document-retriever/       # RAG Engine (Python)
│   ├── search-proxy/             # DuckDuckGo Search (Python)
│   ├── video-orchestrator/       # Video Orchestrator (Node.js)
│   └── notes-generator/          # Notes Generator (Python)
│
├── docs/                         # Documentation
│   ├── prd/                      # Sharded PRD
│   │   ├── index.md
│   │   ├── epic-0-infrastructure-prerequisites.md
│   │   ├── epic-1-foundation-rag-knowledge-infrastructure.md
│   │   └── ...
│   ├── architecture/             # Sharded architecture docs
│   │   ├── index.md
│   │   ├── tech-stack.md
│   │   ├── coding-standards.md
│   │   ├── source-tree.md
│   │   └── ...
│   ├── stories/                  # User stories
│   │   ├── 0.1.vps-infrastructure-audit.md
│   │   └── ...
│   ├── qa/                       # QA assessments and gates
│   ├── prd.md                    # Monolithic PRD (reference)
│   ├── architecture.md           # Monolithic architecture (reference)
│   ├── ux-spec.md                # UX specification
│   ├── infrastructure-reference.md
│   ├── PROJECT-STATUS.md
│   └── ...
│
├── .bmad-core/                   # BMAD methodology framework
│   ├── agents/                   # Agent personas
│   ├── tasks/                    # Executable tasks
│   ├── templates/                # Document templates
│   ├── workflows/                # Project workflows
│   ├── checklists/               # Quality checklists
│   └── core-config.yaml          # BMAD configuration
│
├── .github/
│   └── workflows/
│       ├── ci.yml                # CI pipeline (lint, test, build)
│       └── deploy.yml            # Deployment workflow
│
├── .gitignore                    # Git ignore rules
├── turbo.json                    # Turborepo configuration
├── pnpm-workspace.yaml           # pnpm workspace config
├── package.json                  # Root package.json
├── .env.example                  # Environment variables template
├── README.md                     # Project README
└── CLAUDE.md                     # Claude Code instructions

```

---

## Naming Conventions

### Files and Directories

- **Components:** PascalCase for files (e.g., `Button.tsx`, `SearchBar.tsx`)
- **Utilities:** camelCase for files (e.g., `formatDate.ts`, `validateEmail.ts`)
- **Stores:** camelCase with `Store` suffix (e.g., `authStore.ts`, `uiStore.ts`)
- **Types:** PascalCase for files (e.g., `User.types.ts`, `Video.types.ts`)
- **Edge Functions:** snake_case with descriptive suffix (e.g., `doubt_video_converter_pipe`, `auth_filter`, `render_video_action`)
- **Migrations:** Sequential numbered with description (e.g., `00001_initial_schema.sql`, `00002_add_video_tables.sql`)

### Code Elements

- **React Components:** PascalCase (e.g., `export function SearchBar()`)
- **Hooks:** camelCase with `use` prefix (e.g., `useAuth`, `useVideoRender`)
- **Functions:** camelCase (e.g., `formatDate`, `validateInput`)
- **Constants:** UPPER_SNAKE_CASE (e.g., `MAX_VIDEO_DURATION`, `API_BASE_URL`)
- **Interfaces/Types:** PascalCase (e.g., `interface User`, `type VideoRender`)
- **Enums:** PascalCase (e.g., `enum VideoStatus`)

---

## File Organization Principles

### Component Structure

Each complex component should have its own directory:

```
components/search/
├── SearchBar.tsx          # Main component
├── SearchBar.test.tsx     # Unit tests
├── SearchBar.stories.tsx  # Storybook stories (if using)
└── SearchBar.module.css   # Component-specific styles (if not using Tailwind)
```

### Edge Function Structure

Each pipe/filter/action is a standalone function:

```
supabase/functions/pipes/doubt_video_converter_pipe/
├── index.ts               # Main pipe orchestrator
├── index.test.ts          # Unit tests
└── README.md              # Pipe documentation
```

### Shared Code

- **UI Components:** `packages/ui/` (shadcn/ui wrappers)
- **Business Logic:** `packages/utils/` (validation, formatting)
- **Type Definitions:** `packages/supabase/types/` (database types)
- **Config:** `packages/config/` (ESLint, Tailwind, TypeScript)

---

## Import Conventions

### Absolute Imports (Recommended)

Configure TypeScript `paths` in `tsconfig.json`:

```json
{
  "compilerOptions": {
    "paths": {
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/hooks/*": ["./src/hooks/*"],
      "@/stores/*": ["./src/stores/*"],
      "@/types/*": ["./src/types/*"],
      "@upsc-ai/ui": ["../../packages/ui/src"],
      "@upsc-ai/utils": ["../../packages/utils/src"],
      "@upsc-ai/supabase": ["../../packages/supabase/types"]
    }
  }
}
```

**Usage:**
```typescript
import { Button } from '@/components/ui/button'
import { formatDate } from '@/lib/utils'
import { useAuth } from '@/hooks/useAuth'
import { authStore } from '@/stores/authStore'
import { User } from '@upsc-ai/supabase'
```

### Relative Imports (Use Sparingly)

Only for files in the same directory:
```typescript
import { SearchBarProps } from './SearchBar.types'
```

---

## Environment Variable Organization

### Local Development (`.env.local`)

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=http://89.117.60.144:8001
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGc...

# A4F AI API
A4F_API_KEY=ddc-a4f-12e06ff0184f41de8d3de7be4cd2e831
A4F_BASE_URL=https://api.a4f.co/v1

# VPS Services
VPS_MANIM_URL=http://89.117.60.144:5000
VPS_REVIDEO_URL=http://89.117.60.144:5001
VPS_RAG_URL=http://89.117.60.144:8101
VPS_SEARCH_URL=http://89.117.60.144:8102
VPS_ORCHESTRATOR_URL=http://89.117.60.144:8103
VPS_NOTES_URL=http://89.117.60.144:8104

# RevenueCat
REVENUECAT_SECRET_API_KEY=...

# Optional
REDIS_URL=redis://localhost:6379
```

### Production Environment Variables

Set in:
- **Vercel:** Project Settings → Environment Variables
- **Supabase:** Dashboard → Project Settings → Edge Function Secrets

---

## Build and Development Commands

### Root Commands (Turborepo)

```bash
pnpm dev              # Start all apps in dev mode
pnpm build            # Build all apps and packages
pnpm test             # Run all tests
pnpm lint             # Lint all code
pnpm type-check       # TypeScript type checking
pnpm clean            # Clean all build artifacts
```

### App-Specific Commands

```bash
pnpm --filter web dev         # Run only web app
pnpm --filter admin build     # Build only admin app
pnpm --filter @upsc-ai/ui build  # Build UI package
```

### Supabase Commands

```bash
cd packages/supabase
supabase start                # Start local Supabase
supabase db push              # Push migrations to remote
supabase functions deploy     # Deploy all Edge Functions
supabase gen types typescript --local > types/database.types.ts  # Generate types
```

---

## Key Design Decisions

### Why Monorepo?
- Shared code between web and admin apps
- Type-safe API contracts via shared types
- Single CI/CD pipeline
- Incremental builds with Turborepo caching

### Why Separate `packages/supabase`?
- Edge Functions are Deno-based (different runtime than Next.js)
- Migrations and types used by both web and admin apps
- Clear separation between frontend and backend

### Why `apps/web` vs `apps/admin`?
- Different user audiences (students vs content managers)
- Different authentication requirements
- Different performance characteristics
- Separate deployment targets (potentially)

### Why Pipes/Filters/Actions in Edge Functions?
- Testability: Each filter/action is independently testable
- Reusability: Filters used across multiple pipes
- Maintainability: Clear separation of concerns
- Traceability: Easy to debug request flow
