<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold mb-8">ðŸŽ¬ Video Queue Monitoring</h1>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-blue-50 rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-blue-600 opacity-75">Queued</h3>
                <p id="stat-queued" class="text-3xl font-bold text-blue-600 mt-2">-</p>
            </div>
            <div class="bg-yellow-50 rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-yellow-600 opacity-75">Processing</h3>
                <p id="stat-processing" class="text-3xl font-bold text-yellow-600 mt-2">-</p>
            </div>
            <div class="bg-green-50 rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-green-600 opacity-75">Completed Today</h3>
                <p id="stat-completed" class="text-3xl font-bold text-green-600 mt-2">-</p>
            </div>
            <div class="bg-red-50 rounded-lg shadow p-6">
                <h3 class="text-sm font-medium text-red-600 opacity-75">Failed Today</h3>
                <p id="stat-failed" class="text-3xl font-bold text-red-600 mt-2">-</p>
            </div>
        </div>

        <!-- Priority Breakdown -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Queue by Priority</h2>
            <div class="space-y-3">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">High Priority</span>
                        <span id="priority-high" class="text-sm font-medium">0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="priority-high-bar" class="h-2 rounded-full bg-red-500" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Medium Priority</span>
                        <span id="priority-medium" class="text-sm font-medium">0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="priority-medium-bar" class="h-2 rounded-full bg-yellow-500" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium">Low Priority</span>
                        <span id="priority-low" class="text-sm font-medium">0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="priority-low-bar" class="h-2 rounded-full bg-green-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Jobs Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="p-6 pb-4 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Recent Jobs</h2>
                <span id="last-updated" class="text-sm text-gray-500">Last updated: -</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Queue Pos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Retry</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                        </tr>
                    </thead>
                    <tbody id="jobs-table" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Auto-refresh indicator -->
        <div class="mt-4 text-center text-sm text-gray-500">
            Auto-refreshing every 5 seconds
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'http://89.117.60.144:54321';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Badge helper functions
        function getPriorityBadge(priority) {
            const colors = {
                high: 'bg-red-100 text-red-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800'
            };
            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[priority]}">${priority}</span>`;
        }

        function getStatusBadge(status) {
            const colors = {
                queued: 'bg-blue-100 text-blue-800',
                processing: 'bg-yellow-100 text-yellow-800',
                completed: 'bg-green-100 text-green-800',
                failed: 'bg-red-100 text-red-800',
                cancelled: 'bg-gray-100 text-gray-800'
            };
            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${colors[status]}">${status}</span>`;
        }

        // Load queue statistics
        async function loadStats() {
            try {
                const { data, error } = await supabase.rpc('get_queue_stats');

                if (error) {
                    console.error('Error loading stats:', error);
                    return;
                }

                const stats = data[0] || data;

                // Update stats cards
                document.getElementById('stat-queued').textContent = stats.total_queued || 0;
                document.getElementById('stat-processing').textContent = stats.total_processing || 0;
                document.getElementById('stat-completed').textContent = stats.total_completed_today || 0;
                document.getElementById('stat-failed').textContent = stats.total_failed_today || 0;

                // Update priority counts
                const highCount = stats.high_priority_count || 0;
                const mediumCount = stats.medium_priority_count || 0;
                const lowCount = stats.low_priority_count || 0;

                document.getElementById('priority-high').textContent = highCount;
                document.getElementById('priority-medium').textContent = mediumCount;
                document.getElementById('priority-low').textContent = lowCount;

                // Update priority bars
                document.getElementById('priority-high-bar').style.width = Math.min(highCount * 10, 100) + '%';
                document.getElementById('priority-medium-bar').style.width = Math.min(mediumCount * 10, 100) + '%';
                document.getElementById('priority-low-bar').style.width = Math.min(lowCount * 10, 100) + '%';

            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        // Load recent jobs
        async function loadJobs() {
            try {
                const { data, error } = await supabase
                    .from('jobs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error('Error loading jobs:', error);
                    return;
                }

                const tbody = document.getElementById('jobs-table');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No jobs found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(job => `
                    <tr>
                        <td class="px-6 py-4 text-sm text-gray-900">${job.id.slice(0, 8)}...</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${job.job_type}</td>
                        <td class="px-6 py-4 text-sm">${getPriorityBadge(job.priority)}</td>
                        <td class="px-6 py-4 text-sm">${getStatusBadge(job.status)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${job.queue_position || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${job.retry_count}/${job.max_retries}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${new Date(job.created_at).toLocaleString()}</td>
                    </tr>
                `).join('');

                // Update last updated time
                document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();

            } catch (err) {
                console.error('Failed to load jobs:', err);
            }
        }

        // Load all data
        async function loadData() {
            await loadStats();
            await loadJobs();
        }

        // Initial load
        loadData();

        // Auto-refresh every 5 seconds
        setInterval(loadData, 5000);
    </script>
</body>
</html>
